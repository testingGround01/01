<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neumorphic Card - Math Practice & Study</title>
  <!-- Added Google Font for Study Area -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Link to the external CSS file -->
<style>
/* ============ ANIMATION KEYFRAMES ============ */
@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes subtlePulse {
  0%, 100% {
    box-shadow: 4px 4px 10px var(--shadow-dark), -4px -4px 10px var(--shadow-light);
    transform: scale(1);
  }
  50% {
    box-shadow: 6px 6px 14px var(--shadow-dark), -6px -6px 14px var(--shadow-light);
    transform: scale(1.02);
  }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeInArea {
    from { opacity: 0; }
    to { opacity: 1; }
}


/* ============ GLOBAL BASE STYLES & RESET ============ */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 16px; /* Base font size */
  scroll-behavior: smooth; /* Smooth scrolling */
}

/* ============ GLOBAL THEME (Practice Area Focused) ============ */
:root {
  --bg: #e0e0e0;
  --card-bg: #e0e0e0; /* Sticking with solid for clean neumorphism */
  --shadow-dark: #bebebe;
  --shadow-light: #ffffff;
  --text-primary: #333;
  --text-secondary: #555;
  /* Pill Colors (also used for bars & pie chart) */
  --pill-correct-text: #155724;
  --pill-correct-bg: rgba(40, 167, 69, 0.3);
  --pill-incorrect-text: #721c24;
  --pill-incorrect-bg: rgba(220, 53, 69, 0.3);
  --pill-skipped-text: #856404;
  --pill-skipped-bg: rgba(255, 193, 7, 0.3);
  --pill-fast-text: #155724;
  --pill-fast-bg: rgba(40, 167, 69, 0.3); /* Same as correct */
  --pill-slow-text: #721c24;
  --pill-slow-bg: rgba(220, 53, 69, 0.3); /* Same as incorrect */
  --pill-average-text: #0c5460;
  --pill-average-bg: rgba(23, 162, 184, 0.3);
  --progress-bar-gradient: linear-gradient(90deg, #00bc8c, #2ecc71);
  --nav-active-text: #007bff; /* Color for active nav item */
  --nav-active-bg: rgba(0, 123, 255, 0.1); /* Subtle background for active nav */
  --mastery-color: #007bff;

  --header-height: 80px; /* Define header height variable */
}

body {
  /* Using Segoe UI as primary, Poppins as fallback or specific override */
  font-family: 'Segoe UI', 'Poppins', Tahoma, Geneva, Verdana, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  min-height: 100vh;
  margin: 0;
  padding-top: var(--header-height); /* Use variable */
  padding-bottom: 80px; /* Space at bottom */
  background: var(--bg);
  color: var(--text-primary); /* Set default body text color */
  transition: background 0.3s ease, color 0.3s ease;
  box-sizing: border-box;
  line-height: 1.6; /* Base line-height from study styles */
}

.dark-mode {
  --bg: #1e1e1e;
  --card-bg: #2a2a2a; /* Sticking with solid dark */
  --shadow-dark: #141414;
  --shadow-light: #3a3a3a;
  --text-primary: #eee;
  --text-secondary: #aaa;
  --pill-correct-text: #a3e9a4;
  --pill-correct-bg: rgba(40, 167, 69, 0.4);
  --pill-incorrect-text: #f5c6cb;
  --pill-incorrect-bg: rgba(220, 53, 69, 0.4);
  --pill-skipped-text: #ffeeba;
  --pill-skipped-bg: rgba(255, 193, 7, 0.4);
  --pill-fast-text: #a3e9a4;
  --pill-fast-bg: rgba(40, 167, 69, 0.4);
  --pill-slow-text: #f5c6cb;
  --pill-slow-bg: rgba(220, 53, 69, 0.4);
  --pill-average-text: #bee5eb;
  --pill-average-bg: rgba(23, 162, 184, 0.4);
  --progress-bar-gradient: linear-gradient(90deg, #0ca678, #20c997);
  --nav-active-text: #4dabf7; /* Lighter blue for dark mode */
  --nav-active-bg: rgba(77, 171, 247, 0.15);
  --mastery-color: #4dabf7;
}

/* ============ TOP TAB (Fixed) ============ */
.page-tab {
  width: 100%;
  display: flex;
  justify-content: center; /* Center title by default */
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1000;
  height: var(--header-height); /* Use variable */
  padding: 0 24px; /* Adjusted padding */
  box-sizing: border-box;
  font-size: 22px;
  font-weight: 600;
  color: var(--text-primary);
  background: var(--card-bg);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Subtle shadow for light */
  transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
  animation: slideInDown 0.6s ease-out forwards; /* ANIMATION */
}
.dark-mode .page-tab {
    box-shadow: 4px 4px 10px var(--shadow-dark), -4px -4px 10px var(--shadow-light);
}

/* --- Hamburger Button --- */
.hamburger-btn {
    position: absolute; /* Position relative to the header */
    left: 24px;
    top: 50%;
    transform: translateY(-50%);
    padding: 0;
    font-size: 20px;
    border: none;
    border-radius: 50%;
    background: var(--card-bg);
    color: var(--text-primary);
    box-shadow: 4px 4px 10px var(--shadow-dark), -4px -4px 10px var(--shadow-light);
    cursor: pointer;
    transition: all 0.3s ease;
    width: 44px;
    height: 44px;
    display: flex;
    flex-direction: column; /* Stack bars vertically */
    align-items: center;
    justify-content: center;
    outline: none;
    z-index: 1001; /* Above menu overlay but below header content if needed */
    gap: 4px; /* Space between bars */
    animation: scaleIn 0.5s ease-out 0.4s backwards; /* ANIMATION */
}
.hamburger-btn span {
    display: block;
    width: 20px;
    height: 2px;
    background-color: var(--text-primary);
    border-radius: 1px;
    transition: transform 0.3s ease, opacity 0.3s ease, background-color 0.3s ease;
}
.hamburger-btn:hover {
  box-shadow: 5px 5px 12px var(--shadow-dark), -5px -5px 12px var(--shadow-light);
  transform: translateY(-50%) scale(1.05);
}
.hamburger-btn:active {
  box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
  transform: translateY(-50%) scale(0.98);
}
 .hamburger-btn:focus-visible {
     outline: 2px solid var(--text-primary);
     outline-offset: 2px;
     box-shadow: 5px 5px 12px var(--shadow-dark), -5px -5px 12px var(--shadow-light); /* Keep hover shadow */
 }
/* Hamburger Active State (X) */
.hamburger-btn.active {
   box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); /* ADDED: Inset shadow when active */
}
.hamburger-btn.active span:nth-child(1) {
    transform: translateY(6px) rotate(45deg); /* Move down and rotate */
}
.hamburger-btn.active span:nth-child(2) {
    opacity: 0; /* Middle bar fades out */
}
.hamburger-btn.active span:nth-child(3) {
     transform: translateY(-6px) rotate(-45deg); /* Move up and rotate */
}
/* --- End Hamburger Button --- */

.page-title { /* Adjusted for hamburger */
    flex-grow: 1;
    font-size: 24px; /* Slightly reduced */
    text-align: center;
    color: var(--text-primary);
    font-weight: 600;
    margin: 0 60px; /* Increase margin to avoid overlap with side buttons */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    animation: scaleIn 0.5s ease-out 0.2s backwards; /* ANIMATION */
}

/* Theme Toggle Button */
.toggle-btn {
  position: absolute; /* Keep absolute for easy positioning */
  right: 24px;
  top: 50%;
  transform: translateY(-50%);
  padding: 0;
  font-size: 20px;
  border: none;
  border-radius: 50%;
  background: var(--card-bg);
  color: var(--text-primary);
  box-shadow: 4px 4px 10px var(--shadow-dark), -4px -4px 10px var(--shadow-light);
  cursor: pointer;
  transition: all 0.3s ease;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  outline: none;
  z-index: 1;
  animation: scaleIn 0.5s ease-out 0.4s backwards; /* ANIMATION */
}
.toggle-btn:hover {
  box-shadow: 5px 5px 12px var(--shadow-dark), -5px -5px 12px var(--shadow-light);
  transform: translateY(-50%) scale(1.05); /* Adjust transform */
}
.toggle-btn:active {
  box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
  transform: translateY(-50%) scale(0.98); /* Adjust transform */
}
 .toggle-btn:focus-visible {
     outline: 2px solid var(--text-primary);
     outline-offset: 2px;
     box-shadow: 5px 5px 12px var(--shadow-dark), -5px -5px 12px var(--shadow-light); /* Keep hover shadow */
 }

/* ============ NAVIGATION MENU ============ */
#main-nav {
    position: fixed;
    top: var(--header-height); /* Position below header */
    left: 0;
    width: 100%;
    background: var(--card-bg);
    z-index: 999; /* Below header (1000) */
    overflow: hidden;
    max-height: 0; /* Initially hidden */
    opacity: 0;
    visibility: hidden;
    transition: max-height 0.4s ease-out, opacity 0.3s ease, visibility 0s linear 0.4s;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border-top: 1px solid var(--shadow-dark); /* Separator */
}
 .dark-mode #main-nav {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    border-top-color: var(--shadow-light);
 }
#main-nav.active {
    max-height: 50vh; /* Allow menu to grow */
    opacity: 1;
    visibility: visible;
    transition: max-height 0.4s ease-in-out, opacity 0.3s ease 0.1s, visibility 0s linear 0s;
}
.nav-list {
    list-style: none;
    padding: 10px 0;
    margin: 0;
}
.nav-list li {
    text-align: center;
}
.nav-list a {
    display: block;
    padding: 12px 20px;
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 16px;
    font-weight: 500;
    transition: color 0.2s ease, background-color 0.2s ease;
}
.nav-list a:hover,
.nav-list a:focus {
    color: var(--text-primary);
    background-color: rgba(128, 128, 128, 0.1); /* Subtle hover */
    outline: none;
}
.dark-mode .nav-list a:hover,
.dark-mode .nav-list a:focus {
    background-color: rgba(200, 200, 200, 0.1);
}
/* Style for the active navigation link */
.nav-list a.nav-active {
    font-weight: 700; /* Make it bolder */
    color: var(--nav-active-text); /* Use theme variable for active color */
    background-color: var(--nav-active-bg); /* Subtle background */
}

/* ============ TOP LEVEL AREAS (Practice / Study / Dashboard / Review) ============ */
#practice-area, #study-area, #dashboard-area, #review-area {
    width: 100%; /* Take full width */
    max-width: 1600px; /* Limit max width */
    display: none; /* Hidden by default */
    flex-direction: column;
    align-items: center;
    justify-content: flex-start; /* Align content to top */
    padding: 0 10px; /* Add some horizontal padding */
    box-sizing: border-box;
    animation: fadeInArea 0.5s ease forwards; /* Apply fade-in */
}
#practice-area.active, #study-area.active, #dashboard-area.active, #review-area.active {
    display: flex; /* Show the active area using flex */
}

/* ============ NEUMORPHIC CARDS (Practice Area) ============ */
.neumorphic-card,
.secondary-card {
  width: 95%;
  max-width: 650px;
  padding: 30px 35px;
  margin: 20px 0; /* Margin applied to cards within areas */
  border-radius: 25px;
  background: var(--bg); /* Main cards have bg background */
  /* Slightly tighter shadow */
  box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light);
  text-align: center;
  transition: all 0.3s ease;
}
.secondary-card {
  background: var(--card-bg); /* Session/Result card have card background */
}
.neumorphic-card h2,
.secondary-card h2,
.dashboard-card h2 { /* Add dashboard h2 */
  margin: 0 0 25px;
  font-size: 26px;
  font-weight: 600;
  color: var(--text-primary);
  animation: slideInUp 0.5s ease-out 0.2s backwards; /* ANIMATION */
}

/* Adjustments for cards inside areas */
#practice-area .neumorphic-card,
#practice-area .secondary-card,
#dashboard-area .dashboard-card,
#review-area .neumorphic-card, /* NEW */
#review-area .secondary-card { /* NEW */
    margin-left: auto; /* Center cards within the flex container */
    margin-right: auto;
}

/* ============ INPUTS (Practice Area) ============ */
.input-bar {
  margin: 25px auto;
  padding: 12px 18px;
  border: none;
  border-radius: 15px;
  background: var(--card-bg);
  /* Standard inset */
  box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
  color: var(--text-primary);
  font-size: 16px;
  outline: none;
  width: 100%;
  max-width: 300px;
  display: block;
  transition: all 0.3s ease;
  box-sizing: border-box;
}
.input-bar::placeholder {
    color: var(--text-secondary);
    opacity: 0.8;
}
.input-bar:focus {
    /* Subtle focus highlight */
     box-shadow: inset 6px 6px 12px var(--shadow-dark),
                 inset -6px -6px 12px var(--shadow-light),
                 0 0 0 2px var(--text-secondary);
}
/* Hide number input spinners */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type=number] {
  -moz-appearance: textfield; /* Firefox */
}
/* Allow decimal input for answer */
#sessionAnswer {
  /* No specific change needed for decimals, type=number allows them */
}

/* ============ CHECKBOX & RADIO GROUP (Practice Area) ============ */
.checkbox-group {
  margin: 25px 0;
  text-align: center;
}
.checkbox-title {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 15px;
  font-size: 16px;
}
.checkbox-options {
  display: flex;
  justify-content: center;
  gap: 15px 20px;
  flex-wrap: wrap;
}
.checkbox-options label {
  display: flex;
  align-items: center;
  font-size: 15px;
  color: var(--text-primary);
  cursor: pointer;
  transition: color 0.3s ease;
  padding: 5px 0; /* Easier vertical clicking */
  user-select: none; /* Prevent text selection on click */
}
.checkbox-options input[type="checkbox"],
.checkbox-options input[type="radio"] {
  appearance: none; /* Remove default appearance */
  -webkit-appearance: none;
  width: 22px;
  height: 22px;
  margin-right: 10px;
  background: var(--card-bg);
  /* Standard raised shadow */
  box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
  position: relative; /* For pseudo-element positioning */
  transition: all 0.3s ease;
  cursor: pointer;
  flex-shrink: 0; /* Prevent shrinking in flex */
}
.checkbox-options input[type="checkbox"] {
  border-radius: 8px;
}
.checkbox-options input[type="radio"] {
  border-radius: 50%;
}
 /* Custom focus style */
.checkbox-options input[type="checkbox"]:focus-visible,
.checkbox-options input[type="radio"]:focus-visible {
   outline: 2px solid var(--text-primary);
   outline-offset: 2px;
}
/* Checked state (DEEPER inset shadow) */
.checkbox-options input[type="checkbox"]:checked,
.checkbox-options input[type="radio"]:checked {
  box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light); /* Enhanced inset */
}
/* Checkmark for Checkbox */
.checkbox-options input[type="checkbox"]:checked::after {
  content: '✔';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 14px;
  font-weight: bold;
  color: var(--text-primary);
  animation: scaleIn 0.3s ease; /* ANIMATION */
}
/* Dot for Radio */
.checkbox-options input[type="radio"]:checked::after {
   content: '';
   position: absolute;
   top: 50%;
   left: 50%;
   transform: translate(-50%, -50%);
   width: 10px; /* Size of the inner dot */
   height: 10px;
   border-radius: 50%;
   background: var(--text-primary);
   animation: scaleIn 0.3s ease; /* ANIMATION */
}
/* Highlight label text when checked */
.checkbox-options input[type="checkbox"]:checked + span,
.checkbox-options input[type="radio"]:checked + span {
  font-weight: 600;
}

/* ============ SECTION BUTTONS & ACTION BUTTONS (Practice Area) ============ */
.section-buttons {
  display: flex;
  justify-content: center;
  margin-top: 25px;
  gap: 15px;
  flex-wrap: wrap; /* Allow wrapping on smaller screens */
  animation: slideInUp 0.5s ease-out 0.3s backwards; /* ANIMATION */
}
/* Styling common to section tabs, sub-tabs, start, and session/result buttons */
.section-buttons button, .subsection-toggle button, .start-btn, .session-actions button {
  padding: 10px 20px;
  border: none;
  border-radius: 12px;
  background: var(--card-bg);
  color: var(--text-primary);
  font-size: 15px;
  font-weight: 500;
  box-shadow: 4px 4px 10px var(--shadow-dark), -4px -4px 10px var(--shadow-light);
  cursor: pointer;
  transition: all 0.3s ease;
  outline: none; /* Remove default outline */
}
/* Hover effect - slightly raised */
.section-buttons button:hover, .subsection-toggle button:hover, .start-btn:hover, .session-actions button:hover {
  box-shadow: 5px 5px 12px var(--shadow-dark), -5px -5px 12px var(--shadow-light);
  transform: translateY(-1px);
}
/* Active tab state (DEEPER inset shadow) */
.section-buttons button.active, .subsection-toggle button.active {
  box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); /* Enhanced inset */
  font-weight: 600; /* Indicate active */
  transform: translateY(0); /* Reset hover transform */
}
 /* Start and Session buttons are bolder */
 .start-btn, .session-actions button {
    font-weight: 600;
 }
/* Active (pressed) state for Start/Session/Result buttons (DEEPER inset) */
.start-btn:active, .session-actions button:active {
  box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light); /* Enhanced inset */
  transform: scale(0.98); /* Slight shrink */
}
 /* Custom focus style for all these buttons */
 .section-buttons button:focus-visible,
 .subsection-toggle button:focus-visible,
 .start-btn:focus-visible,
 .session-actions button:focus-visible {
     outline: 2px solid var(--text-primary);
     outline-offset: 2px;
     /* Keep hover shadow on focus for visibility */
     box-shadow: 5px 5px 12px var(--shadow-dark), -5px -5px 12px var(--shadow-light);
 }

/* Section display logic (Practice Area) */
.section {
  display: none; /* Hidden by default */
  margin-top: 30px;
  animation: fadeIn 0.5s ease; /* Fade-in animation */
  width: 100%; /* Ensure sections take width */
}
.section.active {
  display: block; /* Show active section */
}

/* Adaptive Mode Sub-section Toggle (Practice Area) */
.subsection-toggle {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin: 20px 0;
}
.subsection-toggle button {
  padding: 8px 16px; /* Slightly smaller */
  font-size: 14px;
}

/* Start Button Specifics (Practice Area) */
.start-btn {
  margin-top: 35px;
  padding: 12px 25px;
  font-size: 17px;
  font-weight: 600;
  animation: subtlePulse 2.5s infinite ease-in-out 1s; /* ANIMATION */
}
.start-btn:hover, .start-btn:focus, .start-btn:active {
    animation-name: none; /* Pause pulse on interaction */
}

/* Secondary Cards (Session, Results - Practice Area) */
.secondary-card {
  display: none; /* Hidden by default */
  animation: fadeIn 0.5s ease; /* Apply fade-in */
}
.secondary-card.active {
  display: block; /* Show when active */
}

/* Progress Bar (Practice Area) */
.progress-container {
  width: 90%;
  max-width: 500px;
  height: 10px;
  background: var(--card-bg);
  margin: 25px auto;
  border-radius: 10px;
  /* Inset shadow for the container */
  box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
  overflow: hidden; /* Clip the inner bar */
  position: relative; /* For potential future elements */
}
.progress-bar {
  height: 100%;
  background: var(--progress-bar-gradient);
  border-radius: 10px; /* Match container */
  width: 0%; /* Initial width */
  transition: width 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Bouncy transition */
}
/* Status Text (e.g., Question 1/10 - Practice Area) */
.status-indicator {
  margin-top: 10px;
  margin-bottom: 10px; /* Added margin */
  color: var(--text-secondary);
  font-size: 15px;
  font-weight: 500;
  min-height: 20px; /* Prevent layout shift */
}
/* Question Display Area (Practice Area) */
.session-question {
  margin: 20px 10px; /* Reduced margin */
  color: var(--text-primary);
  font-size: 20px;
  font-weight: 500;
  min-height: 30px; /* Prevent layout shift */
  line-height: 1.4;
}
/* Staggered entry for session card items */
#sessionCard.active .status-indicator {
    animation: fadeIn 0.4s ease 0s backwards;
}
#sessionCard.active .session-question {
    animation: fadeIn 0.4s ease 0.1s backwards;
}
#sessionCard.active .input-bar {
    animation: fadeIn 0.4s ease 0.2s backwards;
}
#sessionCard.active .session-actions {
    animation: fadeIn 0.4s ease 0.3s backwards;
}

/* Session Action Buttons (Submit, Skip, Play Again - Practice Area) */
.session-actions {
  margin-top: 25px; /* Default margin, override if needed */
  display: flex;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap; /* Allow wrapping if needed */
}
.session-actions button {
    min-width: 100px; /* Ensure buttons have decent width */
}

/* ============ RESULT CARD LAYOUT (Practice & Review Areas) ============ */
/* Result Card Subheadings */
.subheading {
  margin: 30px 0 15px 0;
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  text-align: center; /* Center headings */
}
/* Container for small result boxes (Accuracy, Correct, etc.) */
.subcards {
  display: flex;
  flex-wrap: wrap; /* Allow wrapping */
  justify-content: center;
  gap: 15px;
  margin-bottom: 25px;
}
/* Individual small result box */
.result-subcard {
  flex: 1 1 120px; /* Grow, shrink, base width */
  min-width: 110px; /* Minimum width before wrapping */
  padding: 20px 15px;
  border-radius: 15px;
  background: var(--card-bg);
  box-shadow: 5px 5px 12px var(--shadow-dark), -5px -5px 12px var(--shadow-light);
  color: var(--text-primary);
  text-align: center;
  transition: all 0.3s ease;
  display: flex; /* Center content vertically */
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
/* Stagger animation for the small result cards */
#resultCard.active .result-subcard,
#reviewDetailCard.active .result-subcard { /* ADDED review card */
    animation: scaleIn 0.4s ease-out backwards;
}
#resultCard.active .subcards .result-subcard:nth-child(1),
#reviewDetailCard.active .subcards .result-subcard:nth-child(1) { animation-delay: 0.1s; }
#resultCard.active .subcards .result-subcard:nth-child(2),
#reviewDetailCard.active .subcards .result-subcard:nth-child(2) { animation-delay: 0.15s; }
#resultCard.active .subcards .result-subcard:nth-child(3),
#reviewDetailCard.active .subcards .result-subcard:nth-child(3) { animation-delay: 0.2s; }
#resultCard.active .subcards .result-subcard:nth-child(4),
#reviewDetailCard.active .subcards .result-subcard:nth-child(4) { animation-delay: 0.25s; }
#resultCard.active .subcards .result-subcard:nth-child(5),
#reviewDetailCard.active .subcards .result-subcard:nth-child(5) { animation-delay: 0.3s; }
#resultCard.active .subcards .result-subcard:nth-child(6),
#reviewDetailCard.active .subcards .result-subcard:nth-child(6) { animation-delay: 0.35s; }


/* Large number display (e.g., 95%) */
.hero-number {
  font-size: 34px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0 0 5px 0;
  line-height: 1.1;
  animation: slideInUp 0.5s ease-out 0.4s backwards; /* ANIMATION */
}
/* Label below the hero number (e.g., Accuracy) */
.hero-label {
  font-size: 14px;
  color: var(--text-secondary);
  font-weight: 500;
}

/* Sub-cards for Graph and Table (Base Styles) */
.column-card,
.graph-subcard,
.detail-table-subcard {
  margin: 0; /* No margin on the card itself, spacing handled by grid gap */
  background: var(--card-bg);
  border-radius: 15px;
  padding: 20px 25px;
  box-shadow: 5px 5px 12px var(--shadow-dark), -5px -5px 12px var(--shadow-light);
  color: var(--text-primary);
  transition: all 0.3s ease;
  overflow: hidden; /* Needed for child overflow */
  box-sizing: border-box; /* Include padding in height/width */
}

 /* Subheading placement within cards */
.column-card .subheading,
.graph-subcard .subheading,
.detail-table-subcard .subheading {
    margin-top: 0; /* Remove top margin for first heading */
    margin-bottom: 15px;
    padding: 0; /* Reset padding */
}
 /* Add top margin to subsequent headings within column-card / graph-card */
.column-card .subheading:not(:first-of-type),
.graph-subcard .subheading:not(:first-of-type) { /* UPDATED: Also apply to graph card */
     margin-top: 25px;
}

/* Time Graph Container */
.time-graph {
  display: flex;
  justify-content: center; /* Center the bars horizontally */
  align-items: flex-end; /* Align bars at the bottom */
  gap: 10px; /* Reduced gap */
  margin-top: 10px; /* Reduced margin */
  padding: 10px 10px 10px 0; /* Padding around bars */
  min-height: 180px; /* Ensure space even if empty */
  overflow-x: auto; /* Enable horizontal scroll if needed */
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
   /* Custom Scrollbar styles */
   scrollbar-width: thin; /* Firefox */
   scrollbar-color: var(--text-secondary) var(--card-bg); /* Firefox */
}
/* Webkit Scrollbar styles */
.time-graph::-webkit-scrollbar { height: 8px; }
.time-graph::-webkit-scrollbar-track { background: var(--card-bg); border-radius: 4px; box-shadow: inset 1px 1px 2px var(--shadow-dark), inset -1px -1px 2px var(--shadow-light); }
.time-graph::-webkit-scrollbar-thumb { background-color: var(--text-secondary); border-radius: 4px; box-shadow: 1px 1px 2px var(--shadow-dark), -1px -1px 2px var(--shadow-light); }
.time-graph::-webkit-scrollbar-thumb:hover { background-color: var(--text-primary); }
/* Individual Bar in Time Graph */
.time-graph .bar { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; cursor: default; position: relative; outline: none; }
/* Stagger animation for time graph bars */
#resultCard.active .time-graph .bar,
#reviewDetailCard.active .time-graph .bar { /* ADDED review card */
    animation: slideInUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) backwards;
}
#resultCard.active .time-graph .bar:nth-child(1),
#reviewDetailCard.active .time-graph .bar:nth-child(1) { animation-delay: 0.2s; }
#resultCard.active .time-graph .bar:nth-child(2),
#reviewDetailCard.active .time-graph .bar:nth-child(2) { animation-delay: 0.22s; }
#resultCard.active .time-graph .bar:nth-child(3),
#reviewDetailCard.active .time-graph .bar:nth-child(3) { animation-delay: 0.24s; }
#resultCard.active .time-graph .bar:nth-child(4),
#reviewDetailCard.active .time-graph .bar:nth-child(4) { animation-delay: 0.26s; }
#resultCard.active .time-graph .bar:nth-child(5),
#reviewDetailCard.active .time-graph .bar:nth-child(5) { animation-delay: 0.28s; }
#resultCard.active .time-graph .bar:nth-child(6),
#reviewDetailCard.active .time-graph .bar:nth-child(6) { animation-delay: 0.30s; }
#resultCard.active .time-graph .bar:nth-child(7),
#reviewDetailCard.active .time-graph .bar:nth-child(7) { animation-delay: 0.32s; }
#resultCard.active .time-graph .bar:nth-child(8),
#reviewDetailCard.active .time-graph .bar:nth-child(8) { animation-delay: 0.34s; }
#resultCard.active .time-graph .bar:nth-child(9),
#reviewDetailCard.active .time-graph .bar:nth-child(9) { animation-delay: 0.36s; }
#resultCard.active .time-graph .bar:nth-child(10),
#reviewDetailCard.active .time-graph .bar:nth-child(10) { animation-delay: 0.38s; }

.time-graph .bar:focus-visible { outline: 2px solid var(--text-primary); outline-offset: 2px; border-radius: 4px; }
.bar-inner { width: 20px; border-radius: 6px 6px 0 0; box-shadow: 3px -3px 6px rgba(0,0,0,0.1); transition: height 0.5s ease-out, background 0.3s ease; pointer-events: none; }
.bar-inner.correct { background: var(--pill-correct-bg); }
.bar-inner.incorrect { background: var(--pill-incorrect-bg); }
.bar-inner.skipped { background: var(--pill-skipped-bg); }
.time-graph .bar .bar-label { margin-top: 8px; font-size: 12px; color: var(--text-secondary); text-align: center; font-weight: 500; pointer-events: none; }

/* Detailed Results Table */
/* This is the container on DESKTOP for the table */
.detail-table-subcard {
  overflow: hidden; /* Hide scrollbar for card itself */
  -webkit-overflow-scrolling: touch;
  /* Flex properties are defined in the desktop media query */
}

/* This wrapper is used INSIDE the desktop detail card to make the TABLE scroll */
.table-scroll-wrapper {
    /* Scroll properties are defined in the desktop media query */
}

table.detailed-results {
    width: 100%;
    border-collapse: collapse;
    color: var(--text-primary);
    /* min-width is handled in desktop/mobile styles */
    table-layout: auto; /* Let table determine column widths */
}
/* Animate the result details table rows */
#resultCard.active .detailed-results tbody tr,
#reviewDetailCard.active .detailed-results tbody tr { /* ADDED review card */
    animation: fadeIn 0.5s ease backwards;
}
#resultCard.active .detailed-results tbody tr:nth-child(1),
#reviewDetailCard.active .detailed-results tbody tr:nth-child(1) { animation-delay: 0.3s; }
#resultCard.active .detailed-results tbody tr:nth-child(2),
#reviewDetailCard.active .detailed-results tbody tr:nth-child(2) { animation-delay: 0.35s; }
#resultCard.active .detailed-results tbody tr:nth-child(3),
#reviewDetailCard.active .detailed-results tbody tr:nth-child(3) { animation-delay: 0.4s; }
#resultCard.active .detailed-results tbody tr:nth-child(4),
#reviewDetailCard.active .detailed-results tbody tr:nth-child(4) { animation-delay: 0.45s; }
#resultCard.active .detailed-results tbody tr:nth-child(5),
#reviewDetailCard.active .detailed-results tbody tr:nth-child(5) { animation-delay: 0.5s; }

table.detailed-results th,
table.detailed-results td {
  text-align: center;
  padding: 12px 15px;
  border-bottom: 1px solid var(--shadow-dark);
  font-size: 14px;
  vertical-align: middle;
  /* white-space handled in desktop/mobile styles */
}
 table.detailed-results th {
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom-width: 2px;
    /* Sticky header handled in desktop styles */
 }
 table.detailed-results tr:last-child td { border-bottom: none; }
 /* Cell alignment/padding handled in desktop/mobile styles */
table.detailed-results .pill { margin-left: 5px; margin-right: 0; }

/* Status/Speed Pills */
.pill { display: inline-block; border-radius: 999px; padding: 5px 10px; font-size: 11px; font-weight: 600; margin-left: 8px; transition: all 0.3s ease; line-height: 1; vertical-align: middle; white-space: nowrap; animation: scaleIn 0.4s ease; /* ANIMATION */ }
.pill-correct { color: var(--pill-correct-text); background-color: var(--pill-correct-bg); }
.pill-incorrect { color: var(--pill-incorrect-text); background-color: var(--pill-incorrect-bg); }
.pill-skipped { color: var(--pill-skipped-text); background-color: var(--pill-skipped-bg); }
.pill-fast { color: var(--pill-fast-text); background-color: var(--pill-fast-bg); }
.pill-slow { color: var(--pill-slow-text); background-color: var(--pill-slow-bg); }
.pill-average { color: var(--pill-average-text); background-color: var(--pill-average-bg); }

/* Mobile Detailed Results Container */
#mobileDetailContainer,
#reviewMobileDetailContainer { /* ADDED review container */
    display: none;
    margin: 20px 0 0 0;
    padding: 0 5px;
    width: 100%;
    box-sizing: border-box;
}
.mobile-detail-card { background: var(--card-bg); border-radius: 15px; padding: 15px 18px; margin-bottom: 15px; box-shadow: 5px 5px 12px var(--shadow-dark), -5px -5px 12px var(--shadow-light); transition: all 0.3s ease; text-align: left; }
/* Animate mobile detail cards */
#resultCard.active .mobile-detail-card,
#reviewDetailCard.active .mobile-detail-card { /* ADDED review card */
    animation: fadeIn 0.5s ease backwards;
}
#resultCard.active #mobileDetailContainer .mobile-detail-card:nth-of-type(1),
#reviewDetailCard.active #reviewMobileDetailContainer .mobile-detail-card:nth-of-type(1) { animation-delay: 0.3s; }
#resultCard.active #mobileDetailContainer .mobile-detail-card:nth-of-type(2),
#reviewDetailCard.active #reviewMobileDetailContainer .mobile-detail-card:nth-of-type(2) { animation-delay: 0.35s; }
#resultCard.active #mobileDetailContainer .mobile-detail-card:nth-of-type(3),
#reviewDetailCard.active #reviewMobileDetailContainer .mobile-detail-card:nth-of-type(3) { animation-delay: 0.4s; }
#resultCard.active #mobileDetailContainer .mobile-detail-card:nth-of-type(4),
#reviewDetailCard.active #reviewMobileDetailContainer .mobile-detail-card:nth-of-type(4) { animation-delay: 0.45s; }
#resultCard.active #mobileDetailContainer .mobile-detail-card:nth-of-type(5),
#reviewDetailCard.active #reviewMobileDetailContainer .mobile-detail-card:nth-of-type(5) { animation-delay: 0.5s; }


.mobile-detail-card, .mobile-detail-card div, .mobile-detail-card span:not(.pill) { color: var(--text-primary); }
.mobile-detail-header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 10px; border-bottom: 1px solid var(--shadow-dark); margin-bottom: 12px; gap: 10px; }
.mobile-detail-question { font-size: 16px; font-weight: 600; line-height: 1.3; flex-grow: 1; }
.mobile-detail-status { flex-shrink: 0; }
.mobile-detail-status .pill { margin-left: 0; }
.mobile-detail-body { font-size: 14px; line-height: 1.6; }
.mobile-detail-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 10px; }
.mobile-detail-row span:first-child { font-weight: 500; color: var(--text-secondary); flex-shrink: 0; }
.mobile-detail-row span:last-child { font-weight: 500; text-align: right; word-break: break-all; }
.mobile-detail-row .pill { margin-left: 5px; }
.mobile-detail-row:last-child { margin-bottom: 0; }

/* Challenge Score Container */
#challengeScoreContainer,
#reviewChallengeScoreContainer { /* ADDED review container */
    display: none;
}
#challengeScoreContainer.active,
#reviewChallengeScoreContainer.active { /* ADDED review container */
    display: block;
}
.column-card #challengeScoreContainer,
.column-card #reviewChallengeScoreContainer { /* ADDED review container */
    margin-top: 25px; /* Space above challenge score inside column-card */
}
.column-card #challengeScoreContainer .subheading,
.column-card #reviewChallengeScoreContainer .subheading { /* ADDED review container */
    margin-top: 0; /* No extra top margin for challenge heading */
}


/* ============ INFO BUTTON & TOOLTIP/MODAL (Practice Area) ============ */
/* Info container remains part of Practice area */
#info-container { position: fixed; bottom: 20px; right: 20px; z-index: 1001; display: flex; flex-direction: column; align-items: flex-end; }
#info-button { width: 48px; height: 48px; border-radius: 50%; background: var(--card-bg); color: var(--text-primary); border: none; font-size: 20px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 4px 4px 10px var(--shadow-dark), -4px -4px 10px var(--shadow-light); transition: all 0.3s ease; outline: none; position: relative; z-index: 1; }
#info-button:hover { box-shadow: 5px 5px 12px var(--shadow-dark), -5px -5px 12px var(--shadow-light); transform: scale(1.05); }
#info-button:active { box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); transform: scale(0.98); }
#info-button:focus-visible { outline: 2px solid var(--text-primary); outline-offset: 2px; box-shadow: 5px 5px 12px var(--shadow-dark), -5px -5px 12px var(--shadow-light); }
/* Desktop Tooltip */
#info-tooltip { position: absolute; bottom: calc(100% + 10px); right: 0; overflow-y: auto; max-height: 80vh; width: max-content; max-width: 350px; background: var(--card-bg); color: var(--text-primary); padding: 20px; border-radius: 15px; box-shadow: 8px 8px 20px var(--shadow-dark), -8px -8px 20px var(--shadow-light); text-align: left; font-size: 13px; line-height: 1.6; opacity: 0; visibility: hidden; transform: translateY(10px) scale(0.95); transform-origin: bottom right; transition: opacity 0.3s ease, visibility 0s linear 0.3s, transform 0.3s ease; pointer-events: none; z-index: 0; scrollbar-width: thin; scrollbar-color: var(--text-secondary) var(--card-bg); }
#info-tooltip::-webkit-scrollbar { width: 6px; }
#info-tooltip::-webkit-scrollbar-track { background: var(--card-bg); border-radius: 3px; }
#info-tooltip::-webkit-scrollbar-thumb { background-color: var(--text-secondary); border-radius: 3px; }
#info-tooltip::-webkit-scrollbar-thumb:hover { background-color: var(--text-primary); }
/* Tooltip/Modal Content Styling */
#info-tooltip h4, #info-modal-card .modal-content h4 { margin: 0 0 10px 0; font-size: 15px; color: var(--text-primary); border-bottom: 1px solid var(--shadow-dark); padding-bottom: 5px; }
#info-tooltip ul, #info-modal-card .modal-content ul { margin: 0 0 15px 0; padding-left: 20px; list-style: disc; }
#info-tooltip li, #info-modal-card .modal-content li { margin-bottom: 5px; }
#info-tooltip strong, #info-modal-card .modal-content strong { font-weight: 600; color: var(--text-primary); }
#info-tooltip.tooltip-visible { opacity: 1; visibility: visible; transform: translateY(0) scale(1); transition-delay: 0s, 0s, 0s; pointer-events: auto; z-index: 2; }
/* Mobile Info Modal Overlay */
#info-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1002; display: flex; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(3px); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
#info-modal-overlay.modal-visible { opacity: 1; visibility: visible; transition-delay: 0s; }

/* ============ GRAPH TOOLTIP (Practice Area) ============ */
#graphTooltip { position: fixed; background: var(--card-bg); color: var(--text-primary); padding: 10px 15px; border-radius: 10px; box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light); font-size: 12px; line-height: 1.5; text-align: left; z-index: 1010; max-width: 250px; opacity: 0; visibility: hidden; transform: translateY(5px) scale(0.98); transform-origin: top left; transition: opacity 0.2s ease, visibility 0s linear 0.2s, transform 0.2s ease; pointer-events: none; white-space: normal; }
#graphTooltip.tooltip-visible { opacity: 1; visibility: visible; transform: translateY(0) scale(1); transition-delay: 0s; }
#graphTooltip strong { font-weight: 600; color: var(--text-secondary); margin-right: 5px; }
#graphTooltip div { margin-bottom: 4px; }
#graphTooltip div:last-child { margin-bottom: 0; }
#graphTooltip .pill { padding: 3px 8px; font-size: 10px; margin-left: 4px; }

/* Targeted Practice Section (Practice Area) */
#section5 .targeted-type-selector, #section5 .targeted-inputs, #section5 .targeted-limit-type { margin: 20px auto; max-width: 400px; }
#section5 .targeted-inputs label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-secondary); font-size: 14px; }
#section5 .targeted-inputs .input-bar { width: 100%; max-width: none; margin: 0 auto 15px auto; }
#section5 .checkbox-options label { justify-content: center; }
#section5 .input-pair { display: flex; gap: 15px; align-items: center; }
#section5 .input-pair .input-bar { margin-bottom: 0; flex: 1; }
#section5 .input-pair span { font-weight: 500; color: var(--text-secondary); }

/* ============ PIE CHART STYLES (Practice & Review Areas) ============ */
.pie-chart-heading {
    margin-top: 30px; /* Space above the chart heading */
    margin-bottom: 15px;
}
.summary-pie-chart-container {
    width: 100%;
    max-width: 200px; /* Adjusted max size */
    margin: 0 auto; /* Center the chart */
    aspect-ratio: 1 / 1; /* Make it square */
    position: relative; /* For potential overlays or legends */
    display: flex;
    align-items: center;
    justify-content: center;
}
.summary-pie-chart-container svg {
    display: block;
    width: 100%;
    height: 100%;
    transform: rotate(-90deg); /* Start chart from the top */
    border-radius: 50%; /* Ensure clipping if needed */
    /* Optional: add a subtle shadow to the SVG container */
     box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
}
.summary-pie-chart-container circle {
    fill: none;
    stroke-width: 20; /* Thickness of segments - Match JS */
    transition: stroke-dashoffset 0.6s cubic-bezier(0.4, 0, 0.2, 1); /* Smoother animation */
}
/* Placeholder style */
.pie-chart-placeholder {
    text-align: center;
    font-size: 14px;
}
/* Legend styles */
.pie-chart-legend {
    display: flex;
    justify-content: center;
    gap: 10px 20px; /* Adjusted gap */
    margin-top: 20px; /* Space above legend */
    flex-wrap: wrap;
    font-size: 12px;
    color: var(--text-secondary);
    padding: 0 10px; /* Padding */
}
.pie-chart-legend span {
    display: inline-flex;
    align-items: center;
    font-weight: 500;
    animation: fadeIn 0.5s ease backwards; /* ANIMATION */
}
.pie-chart-legend span:nth-of-type(2) { animation-delay: 0.1s; }
.pie-chart-legend span:nth-of-type(3) { animation-delay: 0.2s; }

.pie-chart-legend span::before {
    content: '';
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px; /* Spacing */
    background-color: var(--color); /* Custom property set by JS */
     /* Add subtle shadow to legend dots */
     box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}
/* END PIE CHART STYLES */

/* Visually Hidden Utility Class */
.visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }


/* ============ STUDY AREA SPECIFIC STYLES ============ */
/* --- Main Container --- */
#study-area .study-container { /* Renamed from .container to avoid conflict */
    background-color: var(--card-bg); /* Use theme variable */
    padding: 25px;
    border-radius: 20px;
    box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light);
    width: 95%;
    max-width: 1200px; /* Can adjust this */
    margin-top: 20px;
    position: relative;
    font-family: 'Poppins', 'Segoe UI', sans-serif; /* Prioritize Poppins in study area */
    color: var(--text-primary); /* Use theme color */
}

/* Header */
#study-area h1 {
    text-align: center;
    color: var(--text-secondary); /* Use theme color */
    margin-bottom: 30px;
    font-weight: 600;
    text-shadow: 1px 1px 1px var(--shadow-light), -1px -1px 1px var(--shadow-dark); /* Use theme vars */
    font-size: 2rem; /* Adjust size */
}

/* --- Tab Navigation --- */
#study-area .tab-container {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
}
#study-area .tab-button {
    padding: 12px 25px;
    border: none;
    border-radius: 12px;
    background-color: var(--card-bg);
    color: var(--text-secondary);
    font-size: 1rem;
    font-weight: 400;
    cursor: pointer;
    box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
    transition: all 0.2s ease-in-out;
    outline: none;
    position: relative;
}
#study-area .tab-button:hover {
    color: var(--text-primary);
    box-shadow: 7px 7px 12px var(--shadow-dark), -7px -7px 12px var(--shadow-light);
}
#study-area .tab-button.active {
    box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
    color: var(--text-primary);
    font-weight: 600;
}
#study-area .tab-button:focus-visible {
     box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light), 0 0 0 2px var(--text-secondary);
}

/* --- Tab Content Area --- */
#study-area .tab-content {
    padding: 20px;
    margin-top: 20px;
    background-color: var(--card-bg);
    border-radius: 15px;
    box-shadow: inset 8px 8px 15px var(--shadow-dark), inset -8px -8px 15px var(--shadow-light);
    display: none; /* Hide inactive tabs */
}
#study-area .tab-content.active {
     display: block; /* Show active tab */
     animation: fadeIn 0.5s ease; /* Use existing fadeIn animation */
}

/* General Content Styling */
#study-area h2 {
    text-align: center;
    color: var(--text-primary); /* Darker for contrast */
    margin-bottom: 25px;
    font-weight: 600;
    opacity: 0.8; /* Use opacity if desired */
    font-size: 1.5rem; /* Adjust size */
}

/* --- Utility Controls --- */
#study-area .controls {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin-bottom: 25px;
    align-items: center;
}
#study-area .control-item label {
    margin-right: 8px;
    color: var(--text-secondary);
    font-size: 0.9rem;
}
#study-area .neumorphic-input,
#study-area .neumorphic-button {
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    background-color: var(--card-bg);
    color: var(--text-primary);
    font-size: 0.9rem;
    box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
    outline: none;
    transition: box-shadow 0.2s ease-in-out;
}
#study-area .neumorphic-button {
    box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
    cursor: pointer;
}
#study-area .neumorphic-button:hover {
    box-shadow: 7px 7px 12px var(--shadow-dark), -7px -7px 12px var(--shadow-light);
}
#study-area .neumorphic-button:active {
    box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
}
#study-area .neumorphic-input:focus-visible,
#study-area .neumorphic-button:focus-visible {
    box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light), 0 0 0 2px var(--text-secondary);
}
#study-area .neumorphic-button:focus-visible {
    box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light), 0 0 0 2px var(--text-secondary);
}

/* --- Multiplication Tables Specific Styling --- */
#study-area #multiplication-tables-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 25px;
    margin-top: 20px;
}
#study-area .table-block {
    background-color: var(--card-bg);
    padding: 15px;
    border-radius: 10px;
    box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
    text-align: center;
    transition: box-shadow 0.2s ease, transform 0.2s ease;
    font-size: 1.05rem;
}
#study-area .table-block:hover {
     box-shadow: 7px 7px 14px var(--shadow-dark), -7px -7px 14px var(--shadow-light);
     transform: translateY(-2px);
}
#study-area .table-block h3 {
    margin-bottom: 10px;
    color: var(--text-secondary);
    font-size: 1.1em;
    font-weight: 600;
    opacity: 0.7; /* Adjusted opacity */
}
#study-area .table-block p {
    color: var(--text-primary);
    margin-bottom: 4px;
    transition: background-color 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    border-radius: 4px;
    padding: 2px 5px;
    cursor: pointer;
    position: relative;
    font-size: 1.4em;
    opacity: 0.5; /* Apply opacity to the question part */
}
 #study-area .table-block p:hover {
     background-color: rgba(128, 128, 128, 0.1); /* Use theme hover effect */
 }
 .dark-mode #study-area .table-block p:hover {
     background-color: rgba(200, 200, 200, 0.1);
 }


/* --- Squares and Cubes Specific Styling --- */
#study-area #squares-tables-grid,
#study-area #cubes-tables-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 20px;
}
#study-area .value-item {
    background-color: var(--card-bg);
    padding: 15px 10px;
    border-radius: 10px;
    box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
    text-align: center;
    color: var(--text-primary);
    transition: box-shadow 0.2s ease, transform 0.2s ease, background-color 0.2s ease;
    cursor: pointer;
    font-size: 1.05rem;
}
 #study-area .value-item:hover {
     box-shadow: 7px 7px 14px var(--shadow-dark), -7px -7px 14px var(--shadow-light);
     transform: translateY(-2px);
     background-color: rgba(128, 128, 128, 0.1); /* Use theme hover effect */
 }
 .dark-mode #study-area .value-item:hover {
     background-color: rgba(200, 200, 200, 0.1);
 }
#study-area .value-item p {
    display: inline-block;
    opacity: 0.5; /* Apply opacity to the question part */
    transition: opacity 0.2s ease;
}
#study-area .value-item sup {
    font-size: 0.7em;
    vertical-align: super;
}

/* Animation for items inside an active study tab */
#study-area .tab-content.active .table-block,
#study-area .tab-content.active .value-item {
    animation: scaleIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) backwards;
}

/* Stagger the first few items for effect */
#study-area .tab-content.active .table-block:nth-child(1),
#study-area .tab-content.active .value-item:nth-child(1) { animation-delay: 0.05s; }
#study-area .tab-content.active .table-block:nth-child(2),
#study-area .tab-content.active .value-item:nth-child(2) { animation-delay: 0.10s; }
#study-area .tab-content.active .table-block:nth-child(3),
#study-area .tab-content.active .value-item:nth-child(3) { animation-delay: 0.15s; }
#study-area .tab-content.active .table-block:nth-child(4),
#study-area .tab-content.active .value-item:nth-child(4) { animation-delay: 0.20s; }
#study-area .tab-content.active .table-block:nth-child(5),
#study-area .tab-content.active .value-item:nth-child(5) { animation-delay: 0.25s; }
#study-area .tab-content.active .table-block:nth-child(6),
#study-area .tab-content.active .value-item:nth-child(6) { animation-delay: 0.30s; }
#study-area .tab-content.active .table-block:nth-child(7),
#study-area .tab-content.active .value-item:nth-child(7) { animation-delay: 0.35s; }
#study-area .tab-content.active .table-block:nth-child(8),
#study-area .tab-content.active .value-item:nth-child(8) { animation-delay: 0.40s; }


/* --- Make Answers Prominent --- */
#study-area .answer-value {
    color: var(--nav-active-text); /* Use a theme color for answers */
    font-weight: 600;
    opacity: 1; /* Counteract parent opacity */
}

/* --- Hide Answers Functionality --- */
#study-area.answers-hidden .answer-value {
    opacity: 0 !important;
    transition: opacity 0.2s ease;
}
#study-area.answers-hidden .table-block p:hover .answer-value,
#study-area.answers-hidden .value-item:hover .answer-value {
    opacity: 0 !important;
}

 /* --- Click Highlight Functionality --- */
 #study-area .table-block p.highlighted,
 #study-area .value-item.highlighted {
     box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
     background-color: var(--card-bg);
 }
 #study-area .table-block p.highlighted {
      opacity: 1;
  }
 #study-area .value-item.highlighted p {
     opacity: 1;
 }
 #study-area .table-block p.highlighted:hover {
     opacity: 1;
     transform: none;
     background-color: var(--card-bg); /* Keep background consistent */
 }
  #study-area .value-item.highlighted:hover {
      box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
      transform: none;
 }
 #study-area .value-item.highlighted:hover p {
     opacity: 1;
     background-color: transparent;
 }
 #study-area .table-block p.highlighted .answer-value,
 #study-area .value-item.highlighted .answer-value {
      opacity: 1;
  }
/* END STUDY AREA SPECIFIC STYLES */

/* ============ DASHBOARD AREA SPECIFIC STYLES (ENHANCED) ============ */
.dashboard-card {
    width: 95%;
    max-width: 1200px; /* Wider card for dashboard */
    padding: 30px 35px;
    margin: 20px 0;
    border-radius: 25px;
    background: var(--card-bg);
    box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light);
    text-align: center;
    transition: all 0.3s ease;
}
.dashboard-card .subheading {
    text-align: left;
    margin: 40px 0 20px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--shadow-dark);
}
.dashboard-card .subheading:first-of-type {
    margin-top: 10px;
}
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 30px;
    text-align: left;
}
.dashboard-table {
    width: 100%;
    border-collapse: collapse;
    color: var(--text-primary);
    margin-top: 15px;
    table-layout: fixed; /* For equal columns */
}
.dashboard-table th, .dashboard-table td {
    padding: 12px 15px;
    border-bottom: 1px solid var(--shadow-dark);
    font-size: 15px;
    text-align: left;
    vertical-align: middle;
}
.dashboard-table th {
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom-width: 2px;
}
.dashboard-table tr:last-child td {
    border-bottom: none;
}
.dashboard-table td:not(:first-child) {
    text-align: center; /* Center numerical data */
    font-weight: 500;
}
 .dashboard-table th:not(:first-child) {
    text-align: center;
}
.dashboard-table .type-name {
    font-weight: 600;
    text-transform: capitalize;
}
#dashboard-area .subcards {
    margin-bottom: 0;
    justify-content: flex-start;
}
 #dashboard-area .result-subcard {
     flex-basis: 150px; /* Fixed base width */
     animation: scaleIn 0.4s ease-out backwards;
}
#dashboard-area #overall-stats .result-subcard:nth-child(1) { animation-delay: 0.1s; }
#dashboard-area #overall-stats .result-subcard:nth-child(2) { animation-delay: 0.15s; }
#dashboard-area #overall-stats .result-subcard:nth-child(3) { animation-delay: 0.2s; }
#dashboard-area #overall-stats .result-subcard:nth-child(4) { animation-delay: 0.25s; }
#dashboard-area #overall-stats .result-subcard:nth-child(5) { animation-delay: 0.3s; }

#dashboard-area .dashboard-grid,
#dashboard-area .subheading {
    animation: fadeIn 0.5s ease backwards;
}
 #dashboard-area .dashboard-grid { animation-delay: 0.2s; }

 .mastery-bar-container {
    width: 100%;
    height: 10px;
    background: var(--card-bg);
    border-radius: 5px;
    box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
    overflow: hidden;
 }
 .mastery-bar {
    height: 100%;
    background-color: var(--mastery-color);
    border-radius: 5px;
    transition: width 0.5s ease-out;
 }
 .review-time {
    font-size: 0.85em;
    color: var(--text-secondary);
 }
 /* NEW: Styles for Dashboard Trend Charts */
 #dashboard-trends .graph-subcard {
    min-height: 250px; /* Give charts some default height */
    display: flex;
  flex-direction: column;
}

/* Simple achievement badge */
.badge {
  display: inline-block;
  padding: 6px 10px;
  margin: 4px;
  border-radius: 12px;
  background: #4caf50;
  color: #fff;
  font-weight: 600;
  font-size: 0.9rem;
}
 #dashboard-trends .time-graph { /* Reusing time-graph for trend charts */
    flex-grow: 1;
    width: 100%;
    padding: 10px 0;
 }

/* ============ REVIEW AREA SPECIFIC STYLES (NEW) ============ */
#review-area #reviewListCard {
    animation: fadeIn 0.5s ease;
}
#session-list-container {
    width: 100%;
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.session-list-item {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 15px 20px;
    box-shadow: 5px 5px 12px var(--shadow-dark), -5px -5px 12px var(--shadow-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    border: 2px solid transparent;
    outline: none;
}
.session-list-item:hover, .session-list-item:focus-visible {
    box-shadow: 7px 7px 14px var(--shadow-dark), -7px -7px 14px var(--shadow-light);
    transform: translateY(-2px);
    border-color: var(--text-secondary);
}
.session-list-item:active {
    box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
    transform: translateY(0);
}
.session-list-info {
    flex: 1 1 250px;
    text-align: left;
}
.session-list-info .date {
    font-weight: 600;
    font-size: 1.1em;
    color: var(--text-primary);
}
.session-list-info .mode {
    font-size: 0.9em;
    color: var(--text-secondary);
    text-transform: capitalize;
}
.session-list-stats {
    flex: 2 1 300px;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}
.session-list-stats .stat {
    font-size: 0.95em;
    font-weight: 500;
    color: var(--text-primary);
    white-space: nowrap;
}
.session-list-stats .stat .label {
    color: var(--text-secondary);
    margin-right: 5px;
}
#review-area #reviewDetailCard {
    /* Uses .secondary-card styles, which is correct */
    /* All child elements use existing result card classes and will be styled automatically */
}

/* ============ BACK TO TOP BUTTON (Global) ============ */
#back-to-top-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background-color: var(--card-bg);
    color: var(--text-secondary);
    border: none;
    border-radius: 50%; /* Circle */
    box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
    font-size: 1.5rem; /* Adjust size for arrow */
    line-height: 50px; /* Center arrow vertically */
    text-align: center;
    cursor: pointer;
    outline: none;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease-in-out, visibility 0s linear 0.3s, box-shadow 0.2s ease, transform 0.3s ease-in-out; /* Added transform transition */
    transform: translateY(10px); /* Start slightly lower */
}
#back-to-top-btn.visible {
    opacity: 1;
    visibility: visible;
    transition-delay: 0s;
    transform: translateY(0);
}
#back-to-top-btn:hover {
    color: var(--text-primary);
    box-shadow: 7px 7px 12px var(--shadow-dark), -7px -7px 12px var(--shadow-light);
}
#back-to-top-btn:active {
    box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
}
#back-to-top-btn:focus-visible {
     box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light), 0 0 0 2px var(--text-secondary);
 }

/* ============ DESKTOP LAYOUT (Overrides for min-width: 601px) ============ */
@media (min-width: 601px) {
    #practice-area, #study-area, #dashboard-area, #review-area { /* ADDED review-area */
        padding: 0 20px; /* Slightly more padding on desktop */
    }

    /* --- Practice & Review Area Desktop --- */
    #resultCard, #reviewDetailCard { /* ADDED reviewDetailCard */
        width: 95%;
        max-width: 1600px; /* Increased max-width for desktop */
        padding: 40px 45px; /* Increased padding */
    }
    .result-columns {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* 3 equal columns */
        gap: 30px; /* Space between columns */
        align-items: stretch; /* MODIFIED: Make columns stretch vertically */
        width: 100%; /* Ensure container takes full width */
        margin-bottom: 35px; /* Space before Play Again button */
    }
    .result-column {
        display: flex; /* Use flex to help children stretch */
        flex-direction: column;
        min-height: 0; /* Prevent flex/grid items from overflowing containers */
        min-width: 0; /* Prevent grid blow out */
    }
    /* Column 1: Summary Card */
    .result-column-1 .column-card {
        flex-grow: 1; /* MODIFIED: Ensure card grows */
        display: flex;
        flex-direction: column;
    }
     /* Adjust spacing inside column-card */
     .result-column-1 .column-card .subheading {
         margin-top: 0;
         margin-bottom: 15px;
     }
     .result-column-1 .column-card .subheading:not(:first-of-type) {
        margin-top: 30px;
     }
     .result-column-1 .column-card .subcards {
         margin-bottom: 0;
     }
     .result-column-1 .column-card #challengeScoreContainer,
     .result-column-1 .column-card #reviewChallengeScoreContainer { /* ADDED review container */
         margin-top: 30px;
         margin-bottom: 0;
     }
      .result-column-1 .column-card > *:last-child {
        margin-bottom: 0;
      }
      /* Make pie chart section take remaining space if needed */
      .result-column-1 .column-card .pie-chart-heading {
            margin-top: 30px;
            flex-shrink: 0; /* Prevent heading shrinking */
        }
       .result-column-1 .column-card .summary-pie-chart-container {
            max-width: 220px;
            margin-top: auto; /* Push chart down if space allows */
            margin-bottom: 0;
            flex-shrink: 0;
       }
       .result-column-1 .column-card .pie-chart-legend {
            margin-top: 15px;
            margin-bottom: 0;
            flex-shrink: 0;
       }
    /* Column 2: Graph & Time Analysis */
    .result-column-2 .graph-subcard {
        flex-grow: 1; /* MODIFIED: Ensure card grows */
        display: flex;
        flex-direction: column;
        margin-top: 0;
        margin-bottom: 0;
        padding: 20px 25px;
    }
    .result-column-2 .graph-subcard .subheading {
         margin-bottom: 10px;
         flex-shrink: 0;
    }
     .result-column-2 .graph-subcard .subheading:not(#time-graph-heading):not(#review-time-graph-heading) { /* ADDED review heading ID */
         margin-top: 30px;
         margin-bottom: 15px;
     }
    .result-column-2 .graph-subcard #timeGraph,
    .result-column-2 .graph-subcard #reviewTimeGraph { /* ADDED review graph ID */
        flex-grow: 1; /* Allow graph itself to take remaining vertical space */
        min-height: 250px;
        display: flex; /* Ensure bars align */
        flex-direction: row; /* Default, but explicit */
        align-items: flex-end;
        justify-content: center;
    }
    .result-column-2 .graph-subcard .subcards {
        margin-bottom: 0;
        margin-top: auto; /* Push time analysis down */
        flex-shrink: 0;
    }
    /* Column 3: Table */
    .result-column-3 .detail-table-subcard {
        flex-grow: 1; /* MODIFIED: Ensure card grows */
        display: flex;
        flex-direction: column;
        overflow: hidden;
        margin-top: 0;
        margin-bottom: 0;
        padding: 0;
    }
     .result-column-3 .detail-table-subcard .subheading {
        flex-shrink: 0;
        margin-bottom: 15px;
        padding: 20px 25px 0 25px;
     }
    /* Make the table container scrollable */
    .result-column-3 .detail-table-subcard .table-scroll-wrapper {
        overflow-y: auto;
        overflow-x: hidden;
        flex-grow: 1; /* Allow wrapper to take remaining space */
        padding: 0 25px 20px 25px;
        min-height: 0;
        scrollbar-width: thin;
        scrollbar-color: var(--text-secondary) var(--card-bg);
    }
     .result-column-3 .detail-table-subcard .table-scroll-wrapper::-webkit-scrollbar { width: 8px; }
     .result-column-3 .detail-table-subcard .table-scroll-wrapper::-webkit-scrollbar-track { background: var(--card-bg); border-radius: 4px; box-shadow: inset 1px 1px 2px var(--shadow-dark), inset -1px -1px 2px var(--shadow-light); }
     .result-column-3 .detail-table-subcard .table-scroll-wrapper::-webkit-scrollbar-thumb { background-color: var(--text-secondary); border-radius: 4px; box-shadow: 1px 1px 2px var(--shadow-dark), -1px -1px 2px var(--shadow-light); }
     .result-column-3 .detail-table-subcard .table-scroll-wrapper::-webkit-scrollbar-thumb:hover { background-color: var(--text-primary); }

    /* Table styling inside scroll wrapper */
    .result-column-3 .detail-table-subcard table.detailed-results {
        width: 100%;
        min-width: 0;
        border-collapse: collapse;
    }
    .result-column-3 .detail-table-subcard table.detailed-results thead {
        position: sticky;
        top: 0;
        background: var(--card-bg);
        z-index: 1;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border-bottom: none;
    }
     .dark-mode .result-column-3 .detail-table-subcard table.detailed-results thead {
         box-shadow: 0 2px 5px rgba(0,0,0,0.3);
     }
    .result-column-3 .detail-table-subcard table.detailed-results th,
    .result-column-3 .detail-table-subcard table.detailed-results td {
        padding: 12px 15px;
        text-align: center;
        border-bottom: 1px solid var(--shadow-dark);
        vertical-align: middle;
        white-space: normal;
    }
    .result-column-3 .detail-table-subcard table.detailed-results th {
        font-weight: 600;
        color: var(--text-secondary);
        border-bottom-width: 2px;
        border-bottom-style: solid;
        border-bottom-color: var(--shadow-dark);
    }
    .result-column-3 .detail-table-subcard table.detailed-results td:first-child,
    .result-column-3 .detail-table-subcard table.detailed-results th:first-child {
        text-align: left;
        padding-left: 0;
        min-width: 100px; /* Reduced min-width */
        width: 35%; /* Suggest a relative width, adjust as needed */
    }
     /* Adjust other column widths (optional, auto-layout might be fine) */
    .result-column-3 .detail-table-subcard table.detailed-results th:nth-child(2),
    .result-column-3 .detail-table-subcard table.detailed-results td:nth-child(2) { width: 25%; }
    .result-column-3 .detail-table-subcard table.detailed-results th:nth-child(3),
    .result-column-3 .detail-table-subcard table.detailed-results td:nth-child(3) { width: 25%; }
    .result-column-3 .detail-table-subcard table.detailed-results th:nth-child(4),
    .result-column-3 .detail-table-subcard table.detailed-results td:nth-child(4) { width: 15%; }

    .result-column-3 .detail-table-subcard table.detailed-results td:last-child,
    .result-column-3 .detail-table-subcard table.detailed-results th:last-child {
        padding-right: 0;
    }
    .result-column-3 .detail-table-subcard table.detailed-results tr:last-child td {
        border-bottom: none;
    }
    /* Hide mobile details container on desktop */
    #mobileDetailContainer, #reviewMobileDetailContainer { /* ADDED review container */
        display: none !important;
    }
    #detailTableSubcard, #reviewDetailTableSubcard { /* ADDED review container */
         display: flex !important;
     }
    /* Ensure Play Again button is centered below the columns */
    #resultCard .session-actions, #reviewDetailCard .session-actions { /* ADDED review card */
        justify-content: center;
        margin-top: 35px;
    }

    /* --- Study Area Desktop --- */
    /* Styles already prefixed should work */
}

/* ============ MEDIA QUERIES (Mobile - max-width: 600px) ============ */
@media (max-width: 600px) {
  :root {
      --header-height: 70px; /* Adjust header height for mobile */
  }
  body { padding-top: var(--header-height); padding-bottom: 70px; }

  /* === Mobile Header Adjustments === */
  .page-tab {
       justify-content: space-between; /* Space out items */
       align-items: center;
       padding: 0 16px; /* Vertical padding handled by height */
       font-size: 20px;
       position: relative; /* Needed for absolute positioning inside */
  }
   /* Hamburger Button Mobile */
  .hamburger-btn {
      position: static; /* Let flexbox handle positioning */
      order: 1; /* Move to the left */
      transform: none; /* Reset transform */
      width: 40px;
      height: 40px;
      gap: 4px;
      box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
  }
   .hamburger-btn span { width: 18px; height: 2px; }
   .hamburger-btn.active span:nth-child(1) { transform: translateY(5px) rotate(45deg); }
   .hamburger-btn.active span:nth-child(3) { transform: translateY(-5px) rotate(-45deg); }
   .hamburger-btn:hover { transform: scale(1.05); box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light); }
   .hamburger-btn:active { transform: scale(0.98); box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light); }
   .hamburger-btn:focus-visible { outline: 2px solid var(--text-primary); outline-offset: 2px; box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light); }
  /* Title */
  .page-title {
      position: absolute; /* Center title absolutely */
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      order: 2; /* Title comes logically after hamburger */
      flex-grow: 0;
      text-align: center;
      margin: 0; /* Remove margin */
      font-size: 18px; /* Slightly smaller title on mobile */
      font-weight: 600;
      white-space: nowrap; /* Prevent wrapping */
      /* Adjusted max-width: space for two 40px buttons + padding (16px*2) */
      max-width: calc(100% - 80px - 32px);
      overflow: hidden;
      text-overflow: ellipsis;
   }
  /* Theme Toggle */
  .toggle-btn {
      position: static;
      order: 3; /* Move theme toggle to the right */
      width: 40px;
      height: 40px;
      font-size: 18px;
      margin: 0;
      box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
      transform: none;
  }
  .toggle-btn:hover { transform: scale(1.05); box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light); }
  .toggle-btn:active { transform: scale(0.98); box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light); }
  .toggle-btn:focus-visible { outline: 2px solid var(--text-primary); outline-offset: 2px; box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light); }

  /* Keep the dedicated info container hidden on mobile */
  #info-container { display: none !important; }

  /* === General Mobile Styles === */
   #practice-area, #study-area, #dashboard-area, #review-area { /* ADDED review-area */
       padding: 0 5px; /* Reduced padding for areas on mobile */
   }
  .neumorphic-card, .secondary-card, .dashboard-card { width: 95%; padding: 20px 18px; margin: 15px 0; border-radius: 20px; }
  .neumorphic-card h2, .secondary-card h2, .dashboard-card h2 { font-size: 22px; margin-bottom: 20px; }
  .section-buttons { gap: 8px; }
  .section-buttons button { flex: 1 1 40%; min-width: 100px; padding: 10px 6px; font-size: 13px; white-space: nowrap; }
  .input-bar { width: 90%; max-width: none; margin: 20px auto; padding: 12px 15px; font-size: 15px; }
  .checkbox-group { margin: 20px 0; }
  .checkbox-title { font-size: 15px; margin-bottom: 12px; }
  .checkbox-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px 15px; width: 95%; margin: 0 auto; }
  .checkbox-options label { font-size: 14px; justify-content: flex-start; }
  .checkbox-options input[type="checkbox"], .checkbox-options input[type="radio"] { width: 20px; height: 20px; margin-right: 8px; }
  .checkbox-options input[type="checkbox"]:checked, .checkbox-options input[type="radio"]:checked { box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light); }
  .start-btn { width: 85%; margin: 25px auto 10px auto; padding: 12px; font-size: 16px; }
  .progress-container { width: 90%; height: 8px; margin: 20px auto; }
  .status-indicator { font-size: 13px; margin-top: 8px; margin-bottom: 8px; line-height: 1.3; }
  .session-question { font-size: 18px; margin: 20px 5px; }
  .session-actions { margin-top: 20px; gap: 15px; }
  .session-actions button { flex: 1; max-width: 140px; padding: 10px 5px; font-size: 14px; }
  #resultCard .session-actions, #reviewDetailCard .session-actions { /* ADDED review card */
      margin-top: 30px;
  }

  /* === Mobile Result Card Adjustments (Practice & Review) === */
   .result-columns { display: block; /* Stack columns vertically */ }
   .result-column { margin-bottom: 20px; /* Space between stacked sections */ }
   .result-column:last-child { margin-bottom: 0; }
   /* Ensure cards in columns take auto height */
   .result-column-1 .column-card,
   .result-column-2 .graph-subcard,
   .result-column-3 .detail-table-subcard {
       height: auto; /* Let content dictate height */
       min-height: 0; /* Remove min height */
       padding: 15px 18px; /* Mobile padding */
   }
   .result-column-1 .column-card {
        margin-bottom: 0; /* Remove column margin, spacing controlled by .result-column */
   }
    .result-column-2 .graph-subcard {
       margin-top: 0; /* Ensure consistent spacing */
       margin-bottom: 0;
   }
   /* Hide the desktop table container AND its scroll wrapper on mobile */
   .result-column-3 .detail-table-subcard {
        display: none !important;
   }
    #mobileDetailContainer, #reviewMobileDetailContainer { /* ADDED review container */
        display: block !important; /* Show mobile cards container */
        margin-top: 0; /* Adjust margin if needed */
    }

  .subheading { font-size: 18px; margin: 20px 0 12px 0; } /* Adjusted margin */
   /* Subheading inside mobile column-card */
   .column-card .subheading, .graph-subcard .subheading { /* UPDATED */
       margin: 15px 0 12px 0;
   }
   .column-card .subheading:first-of-type, .graph-subcard .subheading:first-of-type { /* UPDATED */
        margin-top: 0;
   }

  .subcards { gap: 10px; margin-bottom: 15px; } /* Reduced margin */
   .column-card .subcards, .graph-subcard .subcards { /* UPDATED */
       margin-bottom: 0;
   }

  .result-subcard { flex: 1 1 40%; min-width: 90px; padding: 15px 10px; }
  .result-subcard#challengeScoreCard, .result-subcard#streakCard, .result-subcard#totalTimeCard,
  .result-subcard#reviewChallengeScoreCard, .result-subcard#reviewStreakCard, .result-subcard#reviewTotalTimeCard { /* ADDED review cards */
      flex-basis: 40%;
  }
  .hero-number { font-size: 28px; }
  .hero-label { font-size: 12px; }
  .graph-subcard { padding: 15px 15px; } /* Keep padding for graph card */
  .time-graph { margin-top: 20px; gap: 8px; padding: 10px 5px 10px 0; min-height: 150px; }
  .bar-inner { width: 16px; border-radius: 4px 4px 0 0; }
  /* Mobile Detail Card adjustments */
  .mobile-detail-card { padding: 12px 15px; }
  .mobile-detail-question { font-size: 15px; }
  .mobile-detail-body { font-size: 13px; }
  .mobile-detail-row span:first-child { color: var(--text-secondary); }

   /* Pie chart adjustments for mobile */
   .pie-chart-heading { margin-top: 25px; }
   .summary-pie-chart-container { max-width: 160px; } /* Smaller chart */
   .pie-chart-legend { margin-top: 15px; gap: 8px 15px; font-size: 11px; }
   .pie-chart-legend span::before { width: 10px; height: 10px; }

  /* Hide Desktop Tooltip & Graph Tooltip */
  #info-tooltip { display: none !important; }
  #graphTooltip { display: none !important; }

  /* === Mobile Info Modal Styles === */
  #info-modal-card { background: var(--card-bg); color: var(--text-primary); border-radius: 20px; padding: 0; box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light); width: 100%; max-width: 95%; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; position: relative; transform: scale(0.95); opacity: 0; transition: opacity 0.3s 0.1s ease, transform 0.3s 0.1s ease; }
  #info-modal-overlay.modal-visible #info-modal-card { opacity: 1; transform: scale(1); }
  .modal-header { padding: 15px 50px 15px 25px; position: relative; border-bottom: 1px solid var(--shadow-dark); flex-shrink: 0; background: var(--card-bg); border-radius: 20px 20px 0 0; display: flex; align-items: center; }
  .modal-header #info-modal-heading { margin: 0; font-size: 18px; color: var(--text-primary); font-weight: 600; line-height: 1.3; flex-grow: 1; text-align: center; }
  #info-modal-close { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); width: 36px; height: 36px; border-radius: 50%; background: var(--card-bg); color: var(--text-primary); border: none; font-size: 24px; font-weight: bold; line-height: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light); transition: all 0.2s ease; padding: 0; outline: none; }
  #info-modal-close:hover { box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light); transform: translateY(-50%) scale(1.05); }
  #info-modal-close:active { box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light); transform: translateY(-50%) scale(0.95); }
  #info-modal-close:focus-visible { outline: 2px solid var(--text-primary); outline-offset: 2px; box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light); }
  .modal-content { padding: 15px 25px; overflow-y: auto; flex-grow: 1; text-align: left; font-size: 14px; line-height: 1.6; color: var(--text-primary); }
  .modal-content h4 { margin: 15px 0 10px 0; font-size: 15px; color: var(--text-primary); border-bottom: 1px solid var(--shadow-dark); padding-bottom: 5px; }
  .modal-content h4:first-child { margin-top: 0; }
  .modal-content ul { margin: 0 0 15px 0; padding-left: 20px; list-style: disc; }
  .modal-content li { margin-bottom: 5px; }
  .modal-content strong { font-weight: 600; color: var(--text-primary); }
  .modal-content::-webkit-scrollbar { width: 8px; }
  .modal-content::-webkit-scrollbar-track { background: var(--card-bg); border-radius: 10px; box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light); }
  .modal-content::-webkit-scrollbar-thumb { background-color: var(--text-secondary); border-radius: 10px; box-shadow: 2px 2px 5px var(--shadow-dark), -2px -2px 5px var(--shadow-light); }
  .modal-content::-webkit-scrollbar-thumb:hover { background-color: var(--text-primary); }
  .modal-content { scrollbar-width: thin; scrollbar-color: var(--text-secondary) var(--card-bg); }

  /* Targeted Practice Mobile Adjustments */
  #section5 .targeted-type-selector .checkbox-options label span, #section5 .targeted-limit-type .checkbox-options label span { font-size: 13px; }
  #section5 .targeted-type-selector .checkbox-options, #section5 .targeted-limit-type .checkbox-options { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); }
  #section5 .input-pair { flex-direction: column; align-items: stretch; gap: 8px; }
  #section5 .input-pair span { text-align: center; margin: 5px 0; }

  /* --- Study Area Mobile Adjustments --- */
  #study-area .study-container { padding: 15px; box-shadow: 8px 8px 15px var(--shadow-dark), -8px -8px 15px var(--shadow-light); }
  #study-area h1 { font-size: 1.8rem; }
  #study-area .tab-button { padding: 10px 15px; font-size: 0.95rem; }
  #study-area .tab-content { /* Removed positioning overrides */ padding: 15px; margin-top: 15px; box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light);}
  #study-area #multiplication-tables-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
  #study-area #squares-tables-grid, #study-area #cubes-tables-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
  #study-area .table-block, #study-area .value-item { font-size: 1rem; }
  #study-area .controls { flex-direction: column; align-items: stretch; gap: 10px; }
  #study-area .control-item { text-align: center; }
  #study-area .control-item label { margin-right: 0; margin-bottom: 5px; display: block;}
  #study-area .neumorphic-input, #study-area .neumorphic-button { width: 100%; text-align: center; }
  #back-to-top-btn { width: 45px; height: 45px; font-size: 1.3rem; line-height: 45px; bottom: 15px; right: 15px;}

  /* === Mobile Dashboard Adjustments === */
  .dashboard-grid { grid-template-columns: 1fr; /* Stack tables vertically */ }
  .dashboard-table { table-layout: auto; } /* Let table resize columns */
  .dashboard-table th, .dashboard-table td { font-size: 14px; padding: 10px 8px; }
  #dashboard-trends .graph-subcard { min-height: 200px; } /* Adjust chart height for mobile */

  /* === Mobile Review Area Adjustments (NEW) === */
  .session-list-item { flex-direction: column; align-items: flex-start; }
  .session-list-stats { justify-content: flex-start; gap: 10px 15px; }
  .session-list-stats .stat { font-size: 0.9em; }

} /* End of @media (max-width: 600px) */

@media (max-width: 480px) {
    body { padding-bottom: 60px; }

    /* === Mobile Header (Small) === */
    .page-title { font-size: 16px; max-width: calc(100% - 70px - 24px); } /* Further reduce size/space */
    .hamburger-btn, .toggle-btn { width: 36px; height: 36px; }
    .hamburger-btn span { width: 16px; }
    .hamburger-btn.active span:nth-child(1) { transform: translateY(4px) rotate(45deg); }
    .hamburger-btn.active span:nth-child(3) { transform: translateY(-4px) rotate(-45deg); }
    .toggle-btn { font-size: 16px; }

    /* === Practice Area Mobile (Small) === */
    .neumorphic-card, .secondary-card, .dashboard-card { padding: 15px 12px; border-radius: 15px; }
    .neumorphic-card h2, .secondary-card h2, .dashboard-card h2 { font-size: 20px; }
    .section-buttons button { font-size: 12px; padding: 8px 5px; min-width: 80px; }
    .input-bar { padding: 10px 12px; font-size: 14px; }
    .checkbox-options { gap: 8px 10px; }
    .checkbox-options label { font-size: 13px; }
    .checkbox-options input[type="checkbox"], .checkbox-options input[type="radio"] { width: 18px; height: 18px; }
    .start-btn { font-size: 15px; padding: 10px; }
    .progress-container { height: 6px; }
    .status-indicator { font-size: 12px; }
    .session-question { font-size: 16px; }
    .session-actions button { font-size: 13px; padding: 8px 5px; max-width: 120px; }
    .result-subcard { min-width: 80px; padding: 12px 8px; }
    .hero-number { font-size: 24px; }
    .hero-label { font-size: 11px; }
    .bar-inner { width: 14px; }
    .mobile-detail-card { padding: 10px 12px; }
    .mobile-detail-question { font-size: 14px; }
    .mobile-detail-body { font-size: 12px; }

    /* === Study Area Mobile (Small) === */
    #study-area .study-container { padding: 10px; border-radius: 15px; box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light); }
    #study-area h1 { font-size: 1.5rem; margin-bottom: 20px; }
    #study-area .tab-container { gap: 8px; margin-bottom: 15px; }
    #study-area .tab-button { padding: 8px 12px; font-size: 0.9rem; border-radius: 10px; box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light); }
    #study-area .tab-button.active { box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light); }
    #study-area .tab-button:focus-visible { box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light), 0 0 0 2px var(--text-secondary); }
    #study-area .tab-content { padding: 10px; margin-top: 10px; box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light);}
    #study-area h2 { font-size: 1.2rem; margin-bottom: 15px; }
    #study-area #multiplication-tables-grid { grid-template-columns: 1fr; gap: 10px; } /* Stack tables vertically */
    #study-area #squares-tables-grid, #study-area #cubes-tables-grid { grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; }
    #study-area .table-block, #study-area .value-item { font-size: 0.95rem; }
    #study-area .table-block h3 { font-size: 1.1em; }
    #study-area .value-item sup { font-size: 0.7em; }
    #back-to-top-btn { width: 40px; height: 40px; font-size: 1.2rem; line-height: 40px; bottom: 10px; right: 10px;}

    /* === Review Area Mobile (Small) (NEW) === */
    .session-list-stats { gap: 8px 12px; }
    .session-list-stats .stat { font-size: 0.85em; }

} /* End of @media (max-width: 480px) */
</style>
</head>
<body>
  <!-- ============ TOP TAB (Fixed) ============ -->
  <div class="page-tab">
    <!-- HAMBURGER BUTTON -->
    <button class="hamburger-btn" id="hamburgerBtn" aria-label="Toggle Navigation Menu" aria-expanded="false" aria-controls="main-nav">
        <span></span>
        <span></span>
        <span></span>
    </button>
    <!-- END HAMBURGER BUTTON -->

    <span class="page-title" id="pageTitle">Mathex - Dashboard</span> <!-- Updated ID -->
    <button class="toggle-btn" id="themeToggle" aria-label="Toggle dark mode (T)">🌙</button>
  </div>

  <!-- ============ NAVIGATION MENU ============ -->
  <nav id="main-nav" aria-labelledby="hamburgerBtn">
      <ul class="nav-list">
          <!-- UPDATED Nav Links with data attributes -->
          <li><a href="#dashboard-area" data-area="dashboard-area" onclick="showArea('dashboard-area');">Dashboard</a></li>
          <li><a href="#practice-area" data-area="practice-area" onclick="showArea('practice-area');">Practice</a></li>
          <li><a href="#study-area" data-area="study-area" onclick="showArea('study-area');">Study</a></li>
          <li><a href="#review-area" data-area="review-area" onclick="showArea('review-area');">Review</a></li>
      </ul>
  </nav>

  <!-- ============ DASHBOARD AREA (ENHANCED) ============ -->
  <div id="dashboard-area">
      <div id="dashboardCard" class="dashboard-card">
          <h2>Your Dashboard</h2>
          
          <!-- Overall Performance (Existing) -->
          <div id="overall-stats">
              <div class="subheading">Overall Performance</div>
              <div class="subcards">
                  <!-- Subcards will be populated by JS -->
                  <p>Start practicing to see your stats here!</p>
              </div>
          </div>
          
          <!-- NEW: Trend Analysis Section -->
          <div id="dashboard-trends">
              <div class="subheading">Your Progress Over Time</div>
              <div class="dashboard-grid">
                  <!-- Performance Trends Chart -->
                  <div class="graph-subcard" id="performanceTrendContainer">
                      <h4 class="subheading" style="text-align:center; margin-top:0; border:none;">Performance Trends</h4>
                      <div id="performanceTrendChart" class="time-graph" role="figure" aria-labelledby="performanceTrendHeading">
                          <div style="color: var(--text-secondary); font-style: italic; padding: 20px;">Performance history will be charted here.</div>
                      </div>
                  </div>
                  <!-- Mastery Evolution Chart -->
                  <div class="graph-subcard" id="masteryTrendContainer">
                       <h4 class="subheading" style="text-align:center; margin-top:0; border:none;">Mastery Evolution</h4>
                       <div id="masteryTrendChart" class="time-graph" role="figure" aria-labelledby="masteryTrendHeading">
                           <div style="color: var(--text-secondary); font-style: italic; padding: 20px;">Your mastery growth will appear here.</div>
                       </div>
                  </div>
              </div>
          </div>

          <!-- Performance by Type/Difficulty (Existing) -->
          <div class="dashboard-grid">
              <div id="type-performance">
                  <div class="subheading">Performance by Question Type</div>
                  <table class="dashboard-table" id="type-performance-table">
                      <thead>
                          <tr>
                              <th>Type</th>
                              <th>Accuracy</th>
                              <th>Mastery</th>
                              <th>Avg. Time</th>
                          </tr>
                      </thead>
                      <tbody>
                          <!-- Rows will be populated by JS -->
                      </tbody>
                  </table>
              </div>
              <div id="difficulty-performance">
                  <div class="subheading">Performance by Difficulty</div>
                   <table class="dashboard-table" id="difficulty-performance-table">
                      <thead>
                          <tr>
                              <th>Difficulty</th>
                              <th>Accuracy</th>
                              <th>Mastery</th>
                              <th>Avg. Time</th>
                          </tr>
                      </thead>
                      <tbody>
                          <!-- Rows will be populated by JS -->
                      </tbody>
                  </table>
              </div>
          </div>
          
          <!-- Upcoming Reviews (Existing) -->
          <div id="review-container">
              <div class="subheading">Upcoming Reviews</div>
              <p id="review-message" style="text-align: left; color: var(--text-secondary);">Topics you should practice next based on spaced repetition.</p>
              <div id="review-items" class="subcards" style="justify-content: flex-start;">
                <!-- Review items will be populated by JS -->
              </div>
          </div>

          <!-- NEW: Persona-Based Insights & Achievements -->
          <div id="dashboard-insights">
              <div class="subheading">Insights & Achievements</div>
              <div id="insights-container" class="subcards" style="justify-content: flex-start;">
                   <!-- Insights will be populated by JS -->
                   <p style="text-align: left; color: var(--text-secondary); width: 100%;">Personalized tips will appear here as you practice.</p>
              </div>
              <div id="achievements-container" class="subcards" style="justify-content: flex-start;">
                   <!-- Achievement badges will be populated by JS -->
              </div>
          </div>

      </div>
  </div><!-- END Dashboard Area -->

  <!-- ============ PRACTICE AREA (Unchanged) ============ -->
  <div id="practice-area">
      <!-- All existing practice-related cards go inside here -->
      <div id="mainCard" class="neumorphic-card">
        <h2>Test Your Skills</h2>
        <!-- Mode Selection Buttons -->
        <div class="section-buttons" role="tablist" aria-label="Practice Modes">
          <button id="btn-section1" class="active" onclick="showSection('section1')" role="tab" aria-selected="true" aria-controls="section1">Fixed Qs</button>
          <button id="btn-section2" onclick="showSection('section2')" role="tab" aria-selected="false" aria-controls="section2">Fixed Time</button>
          <button id="btn-section3" onclick="showSection('section3')" role="tab" aria-selected="false" aria-controls="section3">Adaptive</button>
          <button id="btn-section4" onclick="showSection('section4')" role="tab" aria-selected="false" aria-controls="section4">Challenge</button>
          <button id="btn-section5" onclick="showSection('section5')" role="tab" aria-selected="false" aria-controls="section5">Targeted</button>
        </div>

        <!-- SECTION 1: Fixed Questions -->
        <div id="section1" class="section active" role="tabpanel" aria-labelledby="btn-section1" aria-hidden="false">
          <label for="s1-numQuestions" class="visually-hidden">Number of Questions</label>
          <input id="s1-numQuestions" class="input-bar" type="number" placeholder="Number of Questions (e.g., 10)" min="1" value="10">
          <div class="checkbox-group">
            <div class="checkbox-title" id="s1-types-title">Select Question Type(s)</div>
            <div class="checkbox-options" data-group="s1-types" role="group" aria-labelledby="s1-types-title">
              <label><input type="checkbox" value="multiplication" checked><span>Multiplication</span></label>
              <label><input type="checkbox" value="squares"><span>Squares</span></label>
              <label><input type="checkbox" value="cubes"><span>Cubes</span></label>
              <label><input type="checkbox" value="sqrt"><span>Square Root</span></label>
              <label><input type="checkbox" value="cbrt"><span>Cube Root</span></label>
              <label><input type="checkbox" value="fractions"><span>Fractions (Decimal Value)</span></label>
            </div>
          </div>
          <div class="checkbox-group">
            <div class="checkbox-title" id="s1-difficulty-title">Select Difficulty Level(s) <span style="font-weight: normal; font-size: 0.9em;">(for Typed Qs)</span></div>
            <div class="checkbox-options" data-group="s1-difficulty" role="group" aria-labelledby="s1-difficulty-title">
              <label><input type="checkbox" value="easy" checked><span>Easy</span></label>
              <label><input type="checkbox" value="medium"><span>Medium</span></label>
              <label><input type="checkbox" value="hard"><span>Hard</span></label>
              <label><input type="checkbox" value="expert"><span>Expert</span></label>
            </div>
          </div>
          <button class="start-btn" onclick="startSession()">Start</button>
        </div>

        <!-- SECTION 2: Fixed Time -->
        <div id="section2" class="section" role="tabpanel" aria-labelledby="btn-section2" aria-hidden="true">
           <label for="s2-timeDuration" class="visually-hidden">Time Duration in Seconds</label>
           <input id="s2-timeDuration" class="input-bar" type="number" placeholder="Time Duration (seconds, e.g., 60)" min="10" value="60">
           <div class="checkbox-group">
             <div class="checkbox-title" id="s2-types-title">Select Question Type(s)</div>
             <div class="checkbox-options" data-group="s2-types" role="group" aria-labelledby="s2-types-title">
                <label><input type="checkbox" value="multiplication" checked><span>Multiplication</span></label>
                <label><input type="checkbox" value="squares"><span>Squares</span></label>
                <label><input type="checkbox" value="cubes"><span>Cubes</span></label>
                <label><input type="checkbox" value="sqrt"><span>Square Root</span></label>
                <label><input type="checkbox" value="cbrt"><span>Cube Root</span></label>
                <label><input type="checkbox" value="fractions"><span>Fractions (Decimal Value)</span></label>
             </div>
           </div>
           <div class="checkbox-group">
             <div class="checkbox-title" id="s2-difficulty-title">Select Difficulty Level(s) <span style="font-weight: normal; font-size: 0.9em;">(for Typed Qs)</span></div>
             <div class="checkbox-options" data-group="s2-difficulty" role="group" aria-labelledby="s2-difficulty-title">
               <label><input type="checkbox" value="easy" checked><span>Easy</span></label>
               <label><input type="checkbox" value="medium"><span>Medium</span></label>
               <label><input type="checkbox" value="hard"><span>Hard</span></label>
               <label><input type="checkbox" value="expert"><span>Expert</span></label>
             </div>
           </div>
           <button class="start-btn" onclick="startSession()">Start</button>
        </div>

        <!-- SECTION 3: Adaptive -->
        <div id="section3" class="section" role="tabpanel" aria-labelledby="btn-section3" aria-hidden="true">
          <div class="subsection-toggle" role="tablist" aria-label="Adaptive Mode Type">
            <button id="sub-fq" class="active" onclick="toggleSub('fq')" role="tab" aria-selected="true" aria-controls="s3-adaptiveInput">Fixed Questions</button>
            <button id="sub-ft" onclick="toggleSub('ft')" role="tab" aria-selected="false" aria-controls="s3-adaptiveInput">Fixed Time</button>
          </div>
          <label for="s3-adaptiveInput" class="visually-hidden" id="s3-input-label">Number of Questions</label>
          <input id="s3-adaptiveInput" class="input-bar" type="number" placeholder="Number of Questions (e.g., 15)" min="1" data-mode="questions" aria-labelledby="s3-input-label" value="15">
           <div class="checkbox-group">
            <div class="checkbox-title" id="s3-types-title">Select Question Type(s)</div>
            <div class="checkbox-options" data-group="s3-types" role="group" aria-labelledby="s3-types-title">
                <label><input type="checkbox" value="multiplication" checked><span>Multiplication</span></label>
                <label><input type="checkbox" value="squares"><span>Squares</span></label>
                <label><input type="checkbox" value="cubes"><span>Cubes</span></label>
                <label><input type="checkbox" value="sqrt"><span>Square Root</span></label>
                <label><input type="checkbox" value="cbrt"><span>Cube Root</span></label>
                <label><input type="checkbox" value="fractions"><span>Fractions (Decimal Value)</span></label>
            </div>
          </div>
          <button class="start-btn" onclick="startSession()">Start</button>
        </div>

        <!-- SECTION 4: Challenge -->
        <div id="section4" class="section" role="tabpanel" aria-labelledby="btn-section4" aria-hidden="true">
          <label for="s4-timeDuration" class="visually-hidden">Initial Time Duration in Seconds</label>
          <input id="s4-timeDuration" class="input-bar" type="number" placeholder="Time Duration (seconds, e.g., 120)" min="30" value="120">
          <div class="checkbox-group">
            <div class="checkbox-title" id="s4-types-title">Select Question Type(s)</div>
            <div class="checkbox-options" data-group="s4-types" role="group" aria-labelledby="s4-types-title">
                <label><input type="checkbox" value="multiplication" checked><span>Multiplication</span></label>
                <label><input type="checkbox" value="squares"><span>Squares</span></label>
                <label><input type="checkbox" value="cubes"><span>Cubes</span></label>
                <label><input type="checkbox" value="sqrt"><span>Square Root</span></label>
                <label><input type="checkbox" value="cbrt"><span>Cube Root</span></label>
                <label><input type="checkbox" value="fractions"><span>Fractions (Decimal Value)</span></label>
            </div>
          </div>
          <div class="checkbox-group">
            <div class="checkbox-title" id="s4-difficulty-title">Select Starting Difficulty Level</div>
            <div class="checkbox-options" data-group="s4-difficulty" role="radiogroup" aria-labelledby="s4-difficulty-title">
              <label><input type="radio" name="s4-difficulty-radio" value="easy" checked><span>Easy</span></label>
              <label><input type="radio" name="s4-difficulty-radio" value="medium"><span>Medium</span></label>
              <label><input type="radio" name="s4-difficulty-radio" value="hard"><span>Hard</span></label>
              <label><input type="radio" name="s4-difficulty-radio" value="expert"><span>Expert</span></label>
            </div>
          </div>
          <button class="start-btn" onclick="startSession()">Start Challenge</button>
        </div>

        <!-- SECTION 5: Targeted Practice -->
        <div id="section5" class="section" role="tabpanel" aria-labelledby="btn-section5" aria-hidden="true">
            <div class="targeted-type-selector checkbox-group">
                <div class="checkbox-title" id="s5-target-type-title">Select Target Type</div>
                <div class="checkbox-options" role="radiogroup" aria-labelledby="s5-target-type-title">
                    <label><input type="radio" name="s5-target-type" value="multiplicationTable" checked onchange="updateTargetedInputs()"><span>Mult. Table</span></label>
                    <label><input type="radio" name="s5-target-type" value="squareRange" onchange="updateTargetedInputs()"><span>Square Range</span></label>
                    <label><input type="radio" name="s5-target-type" value="cubeRange" onchange="updateTargetedInputs()"><span>Cube Range</span></label>
                </div>
            </div>
            <div class="targeted-inputs">
                <div id="s5-input-multiplicationTable">
                     <label for="s5-targetValue1" class="visually-hidden">Multiplication Tables</label>
                     <input id="s5-targetValue1" class="input-bar" type="text" placeholder="Tables or range (e.g., 3,5,7 or 2-5)" value="7">
                </div>
                <div id="s5-input-squareRange" style="display: none;">
                    <div class="input-pair">
                        <label for="s5-targetValueMinSq" class="visually-hidden">Minimum Square Base</label>
                        <input id="s5-targetValueMinSq" class="input-bar" type="number" placeholder="Min" min="1" value="21">
                        <span>to</span>
                        <label for="s5-targetValueMaxSq" class="visually-hidden">Maximum Square Base</label>
                        <input id="s5-targetValueMaxSq" class="input-bar" type="number" placeholder="Max" min="1" value="30">
                    </div>
                </div>
                 <div id="s5-input-cubeRange" style="display: none;">
                    <div class="input-pair">
                        <label for="s5-targetValueMinCb" class="visually-hidden">Minimum Cube Base</label>
                        <input id="s5-targetValueMinCb" class="input-bar" type="number" placeholder="Min" min="1" value="11">
                        <span>to</span>
                        <label for="s5-targetValueMaxCb" class="visually-hidden">Maximum Cube Base</label>
                        <input id="s5-targetValueMaxCb" class="input-bar" type="number" placeholder="Max" min="1" value="20">
                    </div>
                </div>
            </div>
            <div class="targeted-limit-type checkbox-group">
                <div class="checkbox-title" id="s5-limit-type-title">Select Limit</div>
                <div class="checkbox-options" role="radiogroup" aria-labelledby="s5-limit-type-title">
                    <label><input type="radio" name="s5-limit-type" value="questions" checked onchange="updateTargetedLimitInput()"><span>Questions</span></label>
                    <label><input type="radio" name="s5-limit-type" value="time" onchange="updateTargetedLimitInput()"><span>Time</span></label>
                </div>
                <label for="s5-limitValue" class="visually-hidden" id="s5-limit-label">Number of Questions</label>
                <input id="s5-limitValue" class="input-bar" type="number" placeholder="Number of Questions (e.g., 10)" min="1" value="10" aria-labelledby="s5-limit-label">
            </div>
          <button class="start-btn" onclick="startSession()">Start Practice</button>
        </div>
      </div>

      <!-- SESSION CARD (Inside Practice Area) -->
      <div id="sessionCard" class="secondary-card" aria-hidden="true">
        <!-- Progress Bar and Status -->
        <div class="progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-labelledby="statusIndicator">
          <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
        </div>
        <div id="statusIndicator" class="status-indicator" aria-live="polite">Question 0 / 0</div>
        <!-- Question Display -->
        <div id="sessionQuestion" class="session-question" aria-live="polite">Question will appear here...</div>
        <!-- Answer Input -->
        <label for="sessionAnswer" class="visually-hidden">Your Answer</label>
        <input id="sessionAnswer" class="input-bar" type="number" step="0.001" inputmode="decimal" placeholder="Enter your answer (e.g., 1.500)">
        <!-- Action Buttons -->
        <div class="session-actions">
          <button onclick="submitAnswer()" aria-label="Submit Answer (Enter)">Submit</button>
          <button onclick="skipQuestion()" aria-label="Skip Question (S)">Skip</button>
        </div>
      </div>

      <!-- RESULT CARD (Inside Practice Area) -->
      <div id="resultCard" class="secondary-card" aria-hidden="true">
        <h2>Session Results</h2>
        <div class="result-columns">
          <!-- Column 1: Summary & Pie Chart -->
          <div class="result-column result-column-1">
            <div class="column-card">
              <div class="subheading">Summary</div>
              <div class="subcards">
                <div class="result-subcard">
                  <div class="hero-number" id="accuracyNumber">0%</div>
                  <div class="hero-label">Accuracy</div>
                </div>
                <div class="result-subcard">
                  <div class="hero-number" id="correctNumber">0</div>
                  <div class="hero-label">Correct</div>
                </div>
                <div class="result-subcard">
                  <div class="hero-number" id="incorrectNumber">0</div>
                  <div class="hero-label">Incorrect</div>
                </div>
                 <div class="result-subcard">
                  <div class="hero-number" id="skippedNumber">0</div>
                  <div class="hero-label">Skipped</div>
                </div>
                <div class="result-subcard" id="streakCard">
                  <div class="hero-number" id="streakNumber">0</div>
                  <div class="hero-label">Longest Streak</div>
                </div>
              </div>
               <div id="challengeScoreContainer">
                   <div class="subheading">Challenge Score</div>
                   <div class="subcards">
                       <div class="result-subcard" id="challengeScoreCard">
                           <div class="hero-number" id="challengeScoreNumber">0</div>
                           <div class="hero-label">Total Score</div>
                       </div>
                   </div>
               </div>
              <div class="subheading pie-chart-heading" id="pie-chart-heading">Answer Breakdown</div>
              <div id="summaryPieChartContainer" class="summary-pie-chart-container" role="figure" aria-labelledby="pie-chart-heading">
                  <div class="pie-chart-placeholder" style="color: var(--text-secondary); font-style: italic; padding: 20px 0;"></div>
              </div>
              <div id="summaryPieChartLegend" class="pie-chart-legend"></div>
            </div>
          </div>
          <!-- Column 2: Time Graph & Time Analysis -->
          <div class="result-column result-column-2">
            <div class="graph-subcard">
              <div class="subheading" id="time-graph-heading">Time per Question (Hover/Focus for details)</div>
              <div id="timeGraph" class="time-graph" role="figure" aria-labelledby="time-graph-heading">
                <div style="color: var(--text-secondary); font-style: italic; padding-left: 10px;">No time data yet.</div>
              </div>
               <div class="subheading">Time Analysis</div>
               <div class="subcards">
                 <div class="result-subcard">
                   <div class="hero-number" id="avgTimeNumber">0s</div>
                   <div class="hero-label">Average Time</div>
                 </div>
                 <div class="result-subcard">
                   <div class="hero-number" id="fastestNumber">0s</div>
                   <div class="hero-label">Fastest</div>
                 </div>
                 <div class="result-subcard">
                   <div class="hero-number" id="slowestNumber">0s</div>
                   <div class="hero-label">Slowest</div>
                 </div>
                 <div class="result-subcard" id="totalTimeCard">
                  <div class="hero-number" id="totalTimeNumber">0s</div>
                  <div class="hero-label">Total Time</div>
                 </div>
               </div>
            </div>
          </div>
          <!-- Column 3: Detailed Results -->
          <div class="result-column result-column-3">
            <div class="detail-table-subcard" id="detailTableSubcard">
              <div class="subheading" id="desktop-detail-heading">Detailed Results</div>
               <div class="table-scroll-wrapper">
                  <table class="detailed-results" id="detailedResultsTable" aria-labelledby="desktop-detail-heading">
                    <thead>
                      <tr>
                        <th scope="col">Question</th>
                        <th scope="col">Correct Answer</th>
                        <th scope="col">Your Answer</th>
                        <th scope="col">Time Taken</th>
                      </tr>
                    </thead>
                    <tbody id="detailTableBody">
                        <tr><td colspan="4" style="text-align: center; color: var(--text-secondary); font-style: italic;">No details yet.</td></tr>
                    </tbody>
                  </table>
               </div>
            </div>
            <div id="mobileDetailContainer" class="result-card-container">
              <div class="subheading">Detailed Results</div>
              <div style="text-align: center; color: var(--text-secondary); font-style: italic;">No details yet.</div>
            </div>
          </div>
        </div>
        <div class="session-actions" style="margin-top: 35px;">
            <button id="playAgainBtn" onclick="resetToMainScreen()">Play Again</button>
        </div>
      </div>

      <!-- INFO BUTTON & DESKTOP TOOLTIP AREA (Inside Practice Area) -->
      <div id="info-container">
          <button id="info-button" aria-label="Show Information (? or I)" aria-haspopup="true" aria-expanded="false">?</button>
          <div id="info-tooltip" role="tooltip">
              <h4>Information</h4>
              <h4>Modes</h4>
              <ul>
                  <li><strong>Fixed Questions:</strong> Answer a set number of questions. Select types and difficulties freely.</li>
                  <li><strong>Fixed Time:</strong> Answer as many questions as possible within the time limit. Select types and difficulties freely.</li>
                  <li><strong>Adaptive (Enhanced):</strong> Difficulty now adapts based on your long-term performance, focusing on your weakest areas using mastery scores and spaced repetition. In-session difficulty still adjusts based on correct/incorrect streaks.</li>
                  <li><strong>Challenge:</strong> Time-based mode. Start at a chosen difficulty. Correct answers add time bonus (Easy:+0.5s, Exp:+2s) & difficulty ↑ after 3 correct. Incorrect answers reset difficulty streak.</li>
                  <li><strong>Targeted:</strong> Practice a specific multiplication table, or a specific range of squares or cubes. Choose number of questions or time limit.</li>
              </ul>
              <h4>Question Types</h4>
              <ul>
                  <li><strong>Multiplication:</strong> e.g., 12 × 5</li>
                  <li><strong>Squares:</strong> e.g., 15²</li>
                  <li><strong>Cubes:</strong> e.g., 7³</li>
                  <li><strong>Square Root:</strong> e.g., √144 (only perfect squares)</li>
                  <li><strong>Cube Root:</strong> e.g., ³√125 (only perfect cubes)</li>
                  <li><strong>Fractions (Decimal Value):</strong> e.g., 3/8? (answer as decimal: 0.375)</li>
              </ul>
               <h4>Difficulty Levels (Approx. Number Ranges / Effect)</h4>
               <ul>
                   <li><strong>Multiplication:</strong> Easy (1-10 × 1-10), Med (1-10 × 11-30 or vice-versa), Hard (11-30 × 11-30), Expert (31-50 × 31-50)</li>
                   <li><strong>Squares:</strong> Easy (1-20), Med (21-30), Hard (31-40), Expert (41-50)</li>
                   <li><strong>Cubes:</strong> Easy (1-10), Med (11-20), Hard (21-30), Expert (31-40)</li>
                   <li><strong>Square Root (Result):</strong> Easy (1-20), Med (21-30), Hard (31-40), Expert (41-50)</li>
                   <li><strong>Cube Root (Result):</strong> Easy (1-10), Med (11-20), Hard (21-30), Expert (31-40)</li>
                   <li><strong>Fractions (Decimal Value):</strong> Numerator/Denominator always 1-10. Difficulty level currently only affects Adaptive/Challenge mode progression.</li>
               </ul>
                <h4>Keyboard Shortcuts</h4>
               <ul>
                   <li><strong>Enter:</strong> Submit answer (when input focused).</li>
                   <li><strong>S:</strong> Skip current question (during session).</li>
                   <li><strong>T:</strong> Toggle Light/Dark Theme.</li>
                   <li><strong>?</strong> or <strong>I:</strong> Show/Hide this information panel (when not in session).</li>
                   <li><strong>Esc:</strong> Close this panel or Graph Tooltip.</li>
               </ul>
               <h4>Other Features</h4>
               <ul>
                   <li><strong>Auto-Submit:</strong> Correct answers are submitted automatically as you type them.</li>
               </ul>
          </div>
      </div>

  </div><!-- END Practice Area -->

  <!-- ============ STUDY AREA (Unchanged) ============ -->
  <div id="study-area">
      <!-- CONTENT FROM SECOND HTML FILE PASTED HERE -->
       <div class="study-container"> <!-- Renamed class -->
            <h1>Neumorphic Math Tables</h1>

            <!-- Utility Controls -->
            <div class="controls">
                 <div class="control-item">
                     <button id="toggle-answers-btn" class="neumorphic-button" data-state="shown">Hide Answers</button>
                 </div>
            </div>

            <!-- Tab Buttons -->
            <div class="tab-container" role="tablist">
                <button class="tab-button active" data-tab="multiplication" role="tab" aria-selected="true" id="tab-btn-multiplication">Multiplication (1-50)</button>
                <button class="tab-button" data-tab="squares" role="tab" aria-selected="false" id="tab-btn-squares">Squares (1-50)</button>
                <button class="tab-button" data-tab="cubes" role="tab" aria-selected="false" id="tab-btn-cubes">Cubes (1-30)</button>
            </div>

            <!-- Tab Content Panels -->
            <div id="multiplication" class="tab-content active" role="tabpanel" aria-labelledby="tab-btn-multiplication">
                <h2>Multiplication Tables (1 to 50)</h2>
                 <div class="controls">
                     <div class="control-item">
                        <label for="jump-to-input">Jump to Table:</label>
                        <input type="number" id="jump-to-input" class="neumorphic-input" placeholder="e.g., 27" min="1" max="50"> <!-- Added min/max -->
                    </div>
                 </div>
                <div id="multiplication-tables-grid">
                     <p>Loading Multiplication Tables...</p>
                </div>
            </div>

            <div id="squares" class="tab-content" role="tabpanel" aria-labelledby="tab-btn-squares">
                <h2>Squares (1 to 50)</h2>
                <div id="squares-tables-grid">
                     <p>Loading Squares...</p>
                </div>
            </div>

            <div id="cubes" class="tab-content" role="tabpanel" aria-labelledby="tab-btn-cubes">
                <h2>Cubes (1 to 30)</h2>
                <div id="cubes-tables-grid">
                    <p>Loading Cubes...</p>
                </div>
            </div>
        </div>
      <!-- END OF PASTED CONTENT -->
  </div><!-- END Study Area -->

  <!-- ============ REVIEW AREA (NEW) ============ -->
  <div id="review-area">
      <!-- Card for listing past sessions -->
      <div id="reviewListCard" class="neumorphic-card" style="max-width: 800px;">
          <h2>Session History</h2>
          <div id="session-list-container">
              <!-- Session history list will be populated by JS -->
              <p style="color: var(--text-secondary); font-style: italic;">Your past practice sessions will appear here.</p>
          </div>
      </div>
      
      <!-- Card for displaying the details of a selected past session. -->
      <!-- This is a clone of resultCard with unique IDs. -->
      <div id="reviewDetailCard" class="secondary-card" aria-hidden="true" style="display: none;">
        <h2 id="reviewDetailTitle">Session Review</h2>
        <div class="result-columns">
          <!-- Column 1: Summary & Pie Chart -->
          <div class="result-column result-column-1">
            <div class="column-card">
              <div class="subheading">Summary</div>
              <div class="subcards">
                <div class="result-subcard">
                  <div class="hero-number" id="reviewAccuracyNumber">0%</div>
                  <div class="hero-label">Accuracy</div>
                </div>
                <div class="result-subcard">
                  <div class="hero-number" id="reviewCorrectNumber">0</div>
                  <div class="hero-label">Correct</div>
                </div>
                <div class="result-subcard">
                  <div class="hero-number" id="reviewIncorrectNumber">0</div>
                  <div class="hero-label">Incorrect</div>
                </div>
                 <div class="result-subcard">
                  <div class="hero-number" id="reviewSkippedNumber">0</div>
                  <div class="hero-label">Skipped</div>
                </div>
                <div class="result-subcard" id="reviewStreakCard">
                  <div class="hero-number" id="reviewStreakNumber">0</div>
                  <div class="hero-label">Longest Streak</div>
                </div>
              </div>
               <div id="reviewChallengeScoreContainer" style="display:none;">
                   <div class="subheading">Challenge Score</div>
                   <div class="subcards">
                       <div class="result-subcard" id="reviewChallengeScoreCard">
                           <div class="hero-number" id="reviewChallengeScoreNumber">0</div>
                           <div class="hero-label">Total Score</div>
                       </div>
                   </div>
               </div>
              <div class="subheading pie-chart-heading" id="review-pie-chart-heading">Answer Breakdown</div>
              <div id="reviewPieChartContainer" class="summary-pie-chart-container" role="figure" aria-labelledby="review-pie-chart-heading">
                  <div class="pie-chart-placeholder" style="color: var(--text-secondary); font-style: italic; padding: 20px 0;"></div>
              </div>
              <div id="reviewPieChartLegend" class="pie-chart-legend"></div>
            </div>
          </div>
          <!-- Column 2: Time Graph & Time Analysis -->
          <div class="result-column result-column-2">
            <div class="graph-subcard">
              <div class="subheading" id="review-time-graph-heading">Time per Question</div>
              <div id="reviewTimeGraph" class="time-graph" role="figure" aria-labelledby="review-time-graph-heading">
                <div style="color: var(--text-secondary); font-style: italic; padding-left: 10px;">No time data yet.</div>
              </div>
               <div class="subheading">Time Analysis</div>
               <div class="subcards">
                 <div class="result-subcard">
                   <div class="hero-number" id="reviewAvgTimeNumber">0s</div>
                   <div class="hero-label">Average Time</div>
                 </div>
                 <div class="result-subcard">
                   <div class="hero-number" id="reviewFastestNumber">0s</div>
                   <div class="hero-label">Fastest</div>
                 </div>
                 <div class="result-subcard">
                   <div class="hero-number" id="reviewSlowestNumber">0s</div>
                   <div class="hero-label">Slowest</div>
                 </div>
                 <div class="result-subcard" id="reviewTotalTimeCard">
                  <div class="hero-number" id="reviewTotalTimeNumber">0s</div>
                  <div class="hero-label">Total Time</div>
                 </div>
               </div>
            </div>
          </div>
          <!-- Column 3: Detailed Results -->
          <div class="result-column result-column-3">
            <div class="detail-table-subcard" id="reviewDetailTableSubcard">
              <div class="subheading" id="review-desktop-detail-heading">Detailed Results</div>
               <div class="table-scroll-wrapper">
                  <table class="detailed-results" id="reviewDetailedResultsTable" aria-labelledby="review-desktop-detail-heading">
                    <thead>
                      <tr>
                        <th scope="col">Question</th>
                        <th scope="col">Correct Answer</th>
                        <th scope="col">Your Answer</th>
                        <th scope="col">Time Taken</th>
                      </tr>
                    </thead>
                    <tbody id="reviewDetailTableBody">
                        <tr><td colspan="4" style="text-align: center; color: var(--text-secondary); font-style: italic;">No details yet.</td></tr>
                    </tbody>
                  </table>
               </div>
            </div>
            <div id="reviewMobileDetailContainer" class="result-card-container">
              <div class="subheading">Detailed Results</div>
              <div style="text-align: center; color: var(--text-secondary); font-style: italic;">No details yet.</div>
            </div>
          </div>
        </div>
        <div class="session-actions" style="margin-top: 35px;">
            <button id="backToListBtn" onclick="showReviewList()">Back to Session History</button>
        </div>
      </div>
  </div><!-- END Review Area -->

  <!-- ============ MOBILE INFO MODAL (Remains outside specific areas) ============ -->
  <div id="info-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="info-modal-heading" tabindex="-1">
      <div id="info-modal-card">
          <div class="modal-header">
              <h4 id="info-modal-heading">Information</h4>
              <button id="info-modal-close" aria-label="Close Information">×</button>
          </div>
          <div class="modal-content">
               <h4>Modes</h4>
              <ul>
                  <li><strong>Fixed Questions:</strong> Answer a set number of questions. Select types and difficulties freely.</li>
                  <li><strong>Fixed Time:</strong> Answer as many questions as possible within the time limit. Select types and difficulties freely.</li>
                   <li><strong>Adaptive (Enhanced):</strong> Difficulty now adapts based on your long-term performance, focusing on your weakest areas using mastery scores and spaced repetition. In-session difficulty still adjusts based on correct/incorrect streaks.</li>
                  <li><strong>Challenge:</strong> Time-based mode. Start at a chosen difficulty. Correct answers add time bonus (Easy:+0.5s, Exp:+2s) & difficulty ↑ after 3 correct. Incorrect answers reset difficulty streak.</li>
                  <li><strong>Targeted:</strong> Practice a specific multiplication table, or a specific range of squares or cubes. Choose number of questions or time limit.</li>
              </ul>
              <h4>Question Types</h4>
              <ul>
                  <li><strong>Multiplication:</strong> e.g., 12 × 5</li>
                  <li><strong>Squares:</strong> e.g., 15²</li>
                  <li><strong>Cubes:</strong> e.g., 7³</li>
                  <li><strong>Square Root:</strong> e.g., √144 (only perfect squares)</li>
                  <li><strong>Cube Root:</strong> e.g., ³√125 (only perfect cubes)</li>
                  <li><strong>Fractions (Decimal Value):</strong> e.g., 3/8? (answer as decimal: 0.375)</li>
              </ul>
              <h4>Difficulty Levels (Approx. Number Ranges / Effect)</h4>
              <ul>
                  <li><strong>Multiplication:</strong> Easy (1-10 × 1-10), Med (1-10 × 11-30 or vice-versa), Hard (11-30 × 11-30), Expert (31-50 × 31-50)</li>
                  <li><strong>Squares:</strong> Easy (1-20), Med (21-30), Hard (31-40), Expert (41-50)</li>
                  <li><strong>Cubes:</strong> Easy (1-10), Med (11-20), Hard (21-30), Expert (31-40)</li>
                  <li><strong>Square Root (Result):</strong> Easy (1-20), Med (21-30), Hard (31-40), Expert (41-50)</li>
                  <li><strong>Cube Root (Result):</strong> Easy (1-10), Med (11-20), Hard (21-30), Expert (31-40)</li>
                   <li><strong>Fractions (Decimal Value):</strong> Numerator/Denominator always 1-10. Difficulty level currently only affects Adaptive/Challenge mode progression.</li>
              </ul>
               <h4>Keyboard Shortcuts</h4>
              <ul>
                  <li><strong>Enter:</strong> Submit answer (when input focused).</li>
                  <li><strong>S:</strong> Skip current question (during session).</li>
                  <li><strong>T:</strong> Toggle Light/Dark Theme.</li>
                  <li><strong>?</strong> or <strong>I:</strong> Show/Hide this information panel (when not in session).</li>
                  <li><strong>Esc:</strong> Close this panel or Graph Tooltip.</li>
              </ul>
              <h4>Other Features</h4>
              <ul>
                 <li><strong>Auto-Submit:</strong> Correct answers are submitted automatically as you type them.</li>
              </ul>
          </div>
      </div>
  </div>

  <!-- ============ GRAPH TOOLTIP ELEMENT (Remains outside specific areas) ============ -->
  <div id="graphTooltip"></div>

  <!-- Back to Top Button (Global) -->
  <button id="back-to-top-btn" title="Back to Top">↑</button> <!-- Simple up arrow -->

  <!-- Link to the external JavaScript file -->
<script>
/*
--------------------------------------------------------------------------
IMPORTANT NOTE ON DATA STORAGE
--------------------------------------------------------------------------
This application uses the browser's `localStorage` to save user progress.
This data is stored securely within your browser for this specific website.
It does NOT create any physical files on your computer's filesystem (like
in the same folder as this index.html file). This is the standard, modern
approach for web applications to remember user data without requiring a server
or user accounts. The data persists even if you close the tab or browser.
--------------------------------------------------------------------------
*/

/* ---------------------------------------
   GLOBAL VARIABLES & STATE TRACKING
---------------------------------------- */
let currentMode = 'light'; // 'light' or 'dark'
let sessionActive = false;
let sessionStartTime = 0;
let sessionEndTime = 0;
let questionIndex = 0; // Current question number (1-based for display)
let correctCount = 0;
let incorrectCount = 0;
let skippedCount = 0;
let totalQuestionsTarget = 0; // For 'Fixed Questions' mode
let sessionDurationTarget = 0; // For 'Fixed Time' modes (in seconds)
let sessionTimerId = null;
let remainingTime = 0; // For 'Fixed Time' modes (in seconds)
let questionStartTime = 0; // Timestamp when the current question was shown
let currentSessionSettings = null; // Holds settings for the current session
let sessionDetails = []; // Array to store details of each question answered
let currentQuestion = null; // The currently displayed question object {text, answer, type, difficulty}
let isAutoSubmitting = false; // Flag to prevent double submission on auto-submit
let currentArea = 'practice-area'; // Track the currently visible area

// Difficulty levels order
const difficultyLevels = ['easy', 'medium', 'hard', 'expert'];
const questionTypes = ['multiplication', 'squares', 'cubes', 'sqrt', 'cbrt', 'fractions'];
let isAdaptiveMode = false;
let adaptiveDifficultyLevel = 'easy'; // Current difficulty in adaptive/challenge modes
let consecutiveCorrectAnswers = 0; // Counter for adaptive/challenge progression
let consecutiveIncorrectAnswers = 0; // NEW: Counter for adaptive decrease trigger
let adaptiveIncreaseThreshold = 5; // Correct answers needed to level up in Adaptive
const ADAPTIVE_DECREASE_THRESHOLD = 2; // NEW: Consecutive incorrect needed to decrease difficulty

let isChallengeMode = false;
let challengeScore = 0;
const challengeTimeBonuses = { easy: 0.5, medium: 1, hard: 1.5, expert: 2 }; // Seconds added per correct answer
const challengeDifficultyIncreaseThreshold = 3; // Correct answers needed to level up in Challenge

// Streak tracking variables
let currentStreak = 0;
let maxStreak = 0;

// DOM Element References (GLOBAL)
const body = document.body;
const pageTab = document.querySelector('.page-tab');
const pageTitleEl = document.getElementById('pageTitle');
const practiceArea = document.getElementById('practice-area');
const studyArea = document.getElementById('study-area');
const dashboardArea = document.getElementById('dashboard-area');
const mainCard = document.getElementById('mainCard');
const sessionCard = document.getElementById('sessionCard');
const resultCard = document.getElementById('resultCard');
const progressBar = document.getElementById('progressBar');
const progressBarContainer = document.querySelector('.progress-container');
const statusIndicator = document.getElementById('statusIndicator');
const sessionQuestionEl = document.getElementById('sessionQuestion');
const sessionAnswerInput = document.getElementById('sessionAnswer');
const timeGraphContainer = document.getElementById('timeGraph');
const detailTableBody = document.getElementById('detailTableBody');
const mobileDetailContainer = document.getElementById('mobileDetailContainer');
const themeToggleButton = document.getElementById('themeToggle');
const challengeScoreContainer = document.getElementById('challengeScoreContainer');
const challengeScoreNumber = document.getElementById('challengeScoreNumber');
const infoContainer = document.getElementById('info-container');
const infoButton = document.getElementById('info-button');
const infoTooltip = document.getElementById('info-tooltip');
const infoModalOverlay = document.getElementById('info-modal-overlay');
const infoModalCard = document.getElementById('info-modal-card');
const infoModalCloseBtn = document.getElementById('info-modal-close');
const s3AdaptiveInput = document.getElementById('s3-adaptiveInput');
const s3InputLabel = document.getElementById('s3-input-label');
const subFqButton = document.getElementById('sub-fq');
const subFtButton = document.getElementById('sub-ft');
const streakNumberEl = document.getElementById('streakNumber');
const totalTimeNumberEl = document.getElementById('totalTimeNumber');
const graphTooltipEl = document.getElementById('graphTooltip');
const summaryPieChartContainer = document.getElementById('summaryPieChartContainer');
const summaryPieChartLegend = document.getElementById('summaryPieChartLegend');
const hamburgerBtn = document.getElementById('hamburgerBtn');
const mainNav = document.getElementById('main-nav');
const navLinks = mainNav?.querySelectorAll('.nav-list a[data-area]') || []; // Get area links
const backToTopBtnGlobal = document.getElementById('back-to-top-btn'); // Global Back to Top Button

// Targeted Practice elements
const s5TargetTypeRadios = document.querySelectorAll('input[name="s5-target-type"]');
const s5LimitTypeRadios = document.querySelectorAll('input[name="s5-limit-type"]');
const s5TargetInputContainers = {
    multiplicationTable: document.getElementById('s5-input-multiplicationTable'),
    squareRange: document.getElementById('s5-input-squareRange'),
    cubeRange: document.getElementById('s5-input-cubeRange')
};
const s5LimitValueInput = document.getElementById('s5-limitValue');
const s5LimitLabel = document.getElementById('s5-limit-label');

// NEW: Review Area DOM Element References
const reviewArea = document.getElementById('review-area');
const reviewListCard = document.getElementById('reviewListCard');
const sessionListContainer = document.getElementById('session-list-container');
const reviewDetailCard = document.getElementById('reviewDetailCard');


/* ---------------------------------------
   ADVANCED USER PROFILE MANAGEMENT
---------------------------------------- */

/**
 * UserProfile class to manage all user data, including stats, history, and mastery.
 * This encapsulates all data logic, making the main script cleaner.
 */
class UserProfile {
    constructor(data = {}) {
        this.schemaVersion = data.schemaVersion || 3; // UPDATED: Schema version for full session storage
        this.profile = {
            creationDate: data.profile?.creationDate || new Date().toISOString(),
            lastSeenDate: data.profile?.lastSeenDate || new Date().toISOString()
        };
        this.globalStats = {
            totalSessions: 0,
            totalTimePracticed: 0,
            allTimeBestStreak: 0,
            totalQuestionsAnswered: 0,
            ...data.globalStats
        };
        // UPDATED: sessionHistory now stores the full session object
        this.sessionHistory = data.sessionHistory || [];
        this.detailedPerformance = data.detailedPerformance || {};
        this.nextReviewSchedule = data.nextReviewSchedule || {};
    }

    /**
     * Processes the results of a completed session and updates the user profile.
     * @param {{sessionId: string, startTime: number, endTime: number, maxStreak: number, settings: object, details: Array<object>, summary: object}} sessionData
     */
    endSession(sessionData) {
        const { endTime, startTime, maxStreak, details } = sessionData;
        this.globalStats.totalSessions++;
        const durationMs = endTime - startTime;
        this.globalStats.totalTimePracticed += durationMs;
        this.globalStats.allTimeBestStreak = Math.max(this.globalStats.allTimeBestStreak, maxStreak);
        this.profile.lastSeenDate = new Date().toISOString();

        // Record full session history
        this.sessionHistory.unshift(sessionData); // Add to the beginning (for reverse chrono order)
        if (this.sessionHistory.length > 100) this.sessionHistory.pop(); // Keep history manageable

        // Update per-question stats and mastery
        details.forEach(d => this._updateDetail(d));

        // Schedule next review based on performance in this session
        this._scheduleNextReview(details);

        // Persist the entire updated profile
        saveUserPerformance(this);
    }

    _updateDetail({ type, difficulty, status, timeMs, userAnswer, questionText, correctAnswer }) {
        if (difficulty === 'targeted') return; // Do not track targeted practice in long-term stats

        this.globalStats.totalQuestionsAnswered++;

        // Ensure the data structure path exists
        this.detailedPerformance[type] ??= {};
        const bucket = (this.detailedPerformance[type][difficulty] ??= {
            correct: 0,
            incorrect: 0,
            skipped: 0,
            totalAttempts: 0,
            totalTimeCorrect: 0,
            totalTimeIncorrect: 0,
            errorLog: [],
            mastery: 0
        });

        bucket.totalAttempts++;
        if (status === 'correct') {
            bucket.correct++;
            bucket.totalTimeCorrect += timeMs;
        } else if (status === 'incorrect') {
            bucket.incorrect++;
            bucket.totalTimeIncorrect += timeMs;
            bucket.errorLog.push({ q: questionText, ans: correctAnswer, userAns: userAnswer, time: new Date().toISOString() });
            if (bucket.errorLog.length > 20) bucket.errorLog.shift(); // Keep error log manageable
        } else {
            bucket.skipped++;
        }
        // Update mastery after every attempt
        bucket.mastery = this._calculateMastery(bucket);
    }

    _calculateMastery(bucket) {
        // A simple mastery score: ratio of correct answers to total attempts.
        // Could be evolved into an exponential moving average for more recent performance weighting.
        if (bucket.totalAttempts === 0) return 0;
        return bucket.correct / bucket.totalAttempts;
    }

    _scheduleNextReview(details) {
        // Spaced Repetition System (SRS)
        details
            .filter(d => d.status !== 'skipped' && d.difficulty !== 'targeted')
            .forEach(({ type, difficulty }) => {
                const mastery = this.detailedPerformance[type]?.[difficulty]?.mastery ?? 0;
                // Spaced repetition intervals in days: [1, 3, 7, 14, 30]
                // The lower the mastery, the sooner the review.
                let intervalDays;
                if (mastery < 0.4) intervalDays = 1;
                else if (mastery < 0.7) intervalDays = 3;
                else if (mastery < 0.9) intervalDays = 7;
                else if (mastery < 1) intervalDays = 14;
                else intervalDays = 30; // Fully mastered

                this.nextReviewSchedule[type] ??= {};
                this.nextReviewSchedule[type][difficulty] = new Date(Date.now() + intervalDays * 24 * 3600 * 1000).toISOString();
            });
    }
}


/**
 * Retrieves the user's performance data from localStorage and returns a UserProfile instance.
 * @returns {UserProfile} An instance of the UserProfile class.
 */
function loadUserPerformance() {
  try {
    const data = localStorage.getItem('mathexUserProfile_v3'); // Using a new key for the new structure
    if (data) {
      const parsedData = JSON.parse(data);
      if (parsedData.schemaVersion === 3) {
         return new UserProfile(parsedData);
      }
    }
  } catch (error) {
    console.error("Error parsing user profile from localStorage:", error);
    localStorage.removeItem('mathexUserProfile_v3');
  }
  // Return a new, empty profile if nothing is found or an error occurs.
  return new UserProfile();
}

/**
 * Saves the UserProfile instance's data to localStorage.
 * @param {UserProfile} profile The UserProfile instance to save.
 */
function saveUserPerformance(profile) {
  try {
    // We stringify the profile instance, which serializes its data properties.
    localStorage.setItem('mathexUserProfile_v3', JSON.stringify(profile));
  } catch (error) {
    console.error("Error saving user profile to localStorage:", error);
  }
}


/* ---------------------------------------
   HELPER FUNCTIONS
---------------------------------------- */
function getRandomInt(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// Parse a comma-separated list of numbers or ranges (e.g., "2,4-6")
function parseNumberList(str) {
    if (!str || typeof str !== 'string') return [];
    const values = [];
    str.split(',').forEach(part => {
        const item = part.trim();
        if (!item) return;
        if (item.includes('-')) {
            const [start, end] = item.split('-').map(n => parseInt(n, 10));
            if (!isNaN(start) && !isNaN(end) && start <= end) {
                for (let i = start; i <= end; i++) values.push(i);
            }
        } else {
            const num = parseInt(item, 10);
            if (!isNaN(num)) values.push(num);
        }
    });
    return values.filter(n => n >= 1);
}

function formatDecimalAnswer(num) {
    if (typeof num !== 'number' || isNaN(num)) {
        return '0.000';
    }
    let fixedNum = num.toFixed(3);
    let parts = fixedNum.split('.');
    if (parts.length === 1) {
        fixedNum += '.000';
    } else if (parts[1].length < 3) {
        fixedNum += '0'.repeat(3 - parts[1].length);
    }
    return fixedNum;
}

function formatTime(ms, showDecimals = true) {
    if (ms === null || typeof ms !== 'number' || isNaN(ms) || ms < 0) return showDecimals ? '0.00s' : '0s';
    if (showDecimals && ms < 60000) { // Only show decimals for times under a minute
         return `${(ms / 1000).toFixed(2)}s`;
    } else {
        const totalSeconds = Math.round(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        if (minutes > 0) {
            return `${minutes}m ${seconds}s`;
        } else {
             return `${seconds}s`;
        }
    }
}

 function formatBigNumber(num) {
    if (typeof num !== 'number' || isNaN(num)) return '0';
    return num.toLocaleString();
}

function sanitizeHTML(str) {
    if (!str) return '';
    const temp = document.createElement('div');
    temp.textContent = str;
    return temp.innerHTML;
}

function updateTargetedInputs() {
    if (!practiceArea.contains(document.querySelector('input[name="s5-target-type"]'))) return; // Only run if in practice area
    const selectedType = document.querySelector('#practice-area input[name="s5-target-type"]:checked')?.value;
    Object.values(s5TargetInputContainers).forEach(container => {
        if (container) container.style.display = 'none';
    });
    if (selectedType && s5TargetInputContainers[selectedType]) {
        s5TargetInputContainers[selectedType].style.display = 'block';
         const firstInput = s5TargetInputContainers[selectedType].querySelector('input');
         if(firstInput && document.activeElement !== firstInput) firstInput.focus();
    }
}

function updateTargetedLimitInput() {
    if (!practiceArea.contains(document.querySelector('input[name="s5-limit-type"]'))) return; // Only run if in practice area
    const selectedLimit = document.querySelector('#practice-area input[name="s5-limit-type"]:checked')?.value;
    if (selectedLimit === 'questions') {
        s5LimitValueInput.placeholder = 'Number of Questions (e.g., 10)';
        s5LimitValueInput.min = '1';
        s5LimitLabel.textContent = 'Number of Questions';
        s5LimitValueInput.value = s5LimitValueInput.value || '10';
    } else if (selectedLimit === 'time') {
        s5LimitValueInput.placeholder = 'Time Duration (seconds, e.g., 60)';
        s5LimitValueInput.min = '10';
        s5LimitLabel.textContent = 'Time Duration (seconds)';
        s5LimitValueInput.value = s5LimitValueInput.value || '60';
    }
     if(document.activeElement !== s5LimitValueInput) s5LimitValueInput.focus();
}

function checkAnswerCorrectness(userAnswerRaw, question) {
    if (!question || typeof userAnswerRaw !== 'string') {
         console.warn("Invalid input to checkAnswerCorrectness");
         return false;
    }
    const correctAnswer = question.answer;
    let isCorrect = false;
    if (question.type === 'fractions') {
        try {
            const userAnswerNum = parseFloat(userAnswerRaw);
            const correctAnswerNum = parseFloat(correctAnswer);
            const tolerance = 0.0001;
            if (!isNaN(userAnswerNum) && !isNaN(correctAnswerNum)) {
                isCorrect = Math.abs(userAnswerNum - correctAnswerNum) < tolerance;
            } else {
                isCorrect = false;
            }
        } catch (e) {
            console.error("Error parsing fraction answer for comparison:", e);
            isCorrect = false;
        }
    } else {
        isCorrect = (userAnswerRaw.trim() === correctAnswer.trim());
    }
    return isCorrect;
}


/* ---------------------------------------
   QUESTION GENERATION
---------------------------------------- */
 function generateMultiplication(difficulty) {
  let num1, num2;
  switch (difficulty) {
    case 'easy': num1 = getRandomInt(1, 10); num2 = getRandomInt(1, 10); break;
    case 'medium':
      num1 = getRandomInt(1, 10);
      num2 = getRandomInt(11, 30);
      if (Math.random() > 0.5) [num1, num2] = [num2, num1];
      break;
    case 'hard': num1 = getRandomInt(11, 30); num2 = getRandomInt(11, 30); break;
    case 'expert': num1 = getRandomInt(31, 50); num2 = getRandomInt(31, 50); break;
    default: num1 = getRandomInt(1, 10); num2 = getRandomInt(1, 10);
  }
  return { text: `${num1} × ${num2}?`, answer: (num1 * num2).toString(), type: 'multiplication', difficulty };
}

function generateSquare(difficulty) {
    let base;
    switch (difficulty) {
        case 'easy': base = getRandomInt(1, 20); break;
        case 'medium': base = getRandomInt(21, 30); break;
        case 'hard': base = getRandomInt(31, 40); break;
        case 'expert': base = getRandomInt(41, 50); break;
        default: base = getRandomInt(1, 20);
    }
    return { text: `${base}²?`, answer: (base * base).toString(), type: 'squares', difficulty };
}

function generateCube(difficulty) {
    let base;
    switch (difficulty) {
        case 'easy': base = getRandomInt(1, 10); break;
        case 'medium': base = getRandomInt(11, 20); break;
        case 'hard': base = getRandomInt(21, 30); break;
        case 'expert': base = getRandomInt(31, 40); break;
        default: base = getRandomInt(1, 10);
    }
    return { text: `${base}³?`, answer: (base * base * base).toString(), type: 'cubes', difficulty };
}

function generateSquareRoot(difficulty) {
    let root;
    switch (difficulty) {
        case 'easy': root = getRandomInt(1, 20); break;
        case 'medium': root = getRandomInt(21, 30); break;
        case 'hard': root = getRandomInt(31, 40); break;
        case 'expert': root = getRandomInt(41, 50); break;
        default: root = getRandomInt(1, 20);
    }
    const perfectSquare = root * root;
    return { text: `√${perfectSquare}?`, answer: root.toString(), type: 'sqrt', difficulty };
}

function generateCubeRoot(difficulty) {
    let root;
    switch (difficulty) {
        case 'easy': root = getRandomInt(1, 10); break;
        case 'medium': root = getRandomInt(11, 20); break;
        case 'hard': root = getRandomInt(21, 30); break;
        case 'expert': root = getRandomInt(31, 40); break;
        default: root = getRandomInt(1, 10);
    }
    const perfectCube = root * root * root;
    return { text: `³√${perfectCube}?`, answer: root.toString(), type: 'cbrt', difficulty };
}

function generateFraction(difficulty) {
    let n1, d1, questionText;
    let maxNumDen = 10;
    do {
        n1 = getRandomInt(1, maxNumDen);
        d1 = getRandomInt(1, maxNumDen);
    } while (d1 === 0 || (n1 % d1 === 0));
    questionText = `What is the decimal value of ${n1}/${d1}?`;
    const decimalAnswer = n1 / d1;
    const formattedAnswer = formatDecimalAnswer(decimalAnswer);
    return { text: questionText, answer: formattedAnswer, type: 'fractions', difficulty };
}

function getAdaptiveQuestionPool(profile, availableTypes) {
    const reviewPool = [];
    const masteryPool = [];
    const now = new Date();

    // 1. Prioritize topics due for spaced repetition
    if (profile.nextReviewSchedule) {
        for (const type in profile.nextReviewSchedule) {
            if (availableTypes.includes(type)) {
                for (const difficulty in profile.nextReviewSchedule[type]) {
                    if (new Date(profile.nextReviewSchedule[type][difficulty]) <= now) {
                        reviewPool.push({ type, difficulty, weight: 10 }); // High weight for review items
                    }
                }
            }
        }
    }
    if (reviewPool.length > 0) {
         console.log("ADAPTIVE: Prioritizing from review pool.", reviewPool);
         return reviewPool;
    }

    // 2. If no reviews are due, build a pool based on mastery
    questionTypes.forEach(type => {
        if (availableTypes.includes(type)) {
            difficultyLevels.forEach(difficulty => {
                const mastery = profile.detailedPerformance[type]?.[difficulty]?.mastery ?? 0;
                // Weight is inversely proportional to mastery. Higher weight for lower mastery.
                const weight = Math.ceil((1 - mastery) * 10);
                if (weight > 0) {
                    masteryPool.push({ type, difficulty, weight });
                }
            });
        }
    });
    
    // Create the final pool based on weights
    const finalPool = [];
    masteryPool.forEach(item => {
        for (let i = 0; i < item.weight; i++) {
            finalPool.push({ type: item.type, difficulty: item.difficulty });
        }
    });

    console.log("ADAPTIVE: Using mastery-based pool.", finalPool);
    return finalPool.length > 0 ? finalPool : null;
}


function generateQuestion() {
  if (!currentSessionSettings) {
      console.error("Cannot generate question: session settings not loaded.");
      return generateMultiplication('easy'); // Fallback
  }

  // === Targeted Practice Logic ===
  if (currentSessionSettings.mode === 'section5') {
      const { targetType, targetValues, targetValueMin, targetValueMax } = currentSessionSettings;
      const MULT_RANGE = 12;
      let newQuestion = null;
      try {
         if (targetType === 'multiplicationTable') {
            const table = targetValues[getRandomInt(0, targetValues.length - 1)];
            const num2 = getRandomInt(1, MULT_RANGE);
            const text = Math.random() > 0.5 ? `${table} × ${num2}?` : `${num2} × ${table}?`;
            newQuestion = { text: text, answer: (table * num2).toString(), type: 'multiplication', difficulty: 'targeted' };
         } else if (targetType === 'squareRange') {
            const base = getRandomInt(targetValueMin, targetValueMax);
            newQuestion = { text: `${base}²?`, answer: (base * base).toString(), type: 'squares', difficulty: 'targeted' };
         } else if (targetType === 'cubeRange') {
             const base = getRandomInt(targetValueMin, targetValueMax);
             newQuestion = { text: `${base}³?`, answer: (base * base * base).toString(), type: 'cubes', difficulty: 'targeted' };
         } else {
              console.error("Unknown targeted practice type:", targetType);
              newQuestion = generateMultiplication('easy'); // Fallback
         }
      } catch (e) {
          console.error("Error generating targeted question:", e);
          newQuestion = generateMultiplication('easy'); // Fallback
      }
       currentQuestion = newQuestion;
       return currentQuestion;
  }

  // === Logic for other modes ===
  let availableTypes = currentSessionSettings.types.length > 0 ? currentSessionSettings.types : ['multiplication'];
  let difficultyToUse;
  let questionFunc;

  // === MODIFIED ADAPTIVE LOGIC ===
  if (isAdaptiveMode) {
        const userProfile = loadUserPerformance();
        const adaptivePool = getAdaptiveQuestionPool(userProfile, availableTypes);
        let questionParams;

        if (adaptivePool && adaptivePool.length > 0) {
            questionParams = adaptivePool[getRandomInt(0, adaptivePool.length - 1)];
        } else {
            // Fallback if there's no history or all types are mastered: select a random available type
            const selectedType = availableTypes[getRandomInt(0, availableTypes.length - 1)];
            questionParams = { type: selectedType, difficulty: 'easy' }; // Start easy on new types
        }
         // In-session difficulty still overrides the difficulty from the pool for a smoother experience
        difficultyToUse = adaptiveDifficultyLevel;
        switch (questionParams.type) {
            case 'multiplication': questionFunc = generateMultiplication; break;
            case 'squares': questionFunc = generateSquare; break;
            case 'cubes': questionFunc = generateCube; break;
            case 'sqrt': questionFunc = generateSquareRoot; break;
            case 'cbrt': questionFunc = generateCubeRoot; break;
            case 'fractions': questionFunc = generateFraction; break;
            default: questionFunc = generateMultiplication;
        }
  }
  // === END OF MODIFIED ADAPTIVE LOGIC ===
  else { // Regular, non-adaptive logic for other modes
      const selectedType = availableTypes[getRandomInt(0, availableTypes.length - 1)];

      if (isChallengeMode) {
          difficultyToUse = adaptiveDifficultyLevel;
      } else {
          const availableDifficulties = currentSessionSettings.difficulty.length > 0 ? currentSessionSettings.difficulty : ['easy'];
          difficultyToUse = availableDifficulties[getRandomInt(0, availableDifficulties.length - 1)];
      }

      switch (selectedType) {
          case 'multiplication': questionFunc = generateMultiplication; break;
          case 'squares': questionFunc = generateSquare; break;
          case 'cubes': questionFunc = generateCube; break;
          case 'sqrt': questionFunc = generateSquareRoot; break;
          case 'cbrt': questionFunc = generateCubeRoot; break;
          case 'fractions': questionFunc = generateFraction; break;
          default: questionFunc = generateMultiplication;
      }
  }

   currentQuestion = questionFunc(difficultyToUse);
   return currentQuestion;
}


/* ---------------------------------------
   ADAPTIVE & CHALLENGE LOGIC
---------------------------------------- */
function increaseDifficulty() {
    const currentIndex = difficultyLevels.indexOf(adaptiveDifficultyLevel);
    if (currentIndex < difficultyLevels.length - 1) {
        adaptiveDifficultyLevel = difficultyLevels[currentIndex + 1];
        console.log("Difficulty Increased to:", adaptiveDifficultyLevel);
    }
}

function decreaseDifficulty() {
    const currentIndex = difficultyLevels.indexOf(adaptiveDifficultyLevel);
    if (currentIndex > 0) {
        adaptiveDifficultyLevel = difficultyLevels[currentIndex - 1];
        console.log("Difficulty Decreased to:", adaptiveDifficultyLevel);
    }
}

function updateAdaptiveState(status) {
    if (isAdaptiveMode) {
        if (status === 'correct') {
            consecutiveCorrectAnswers++;
            consecutiveIncorrectAnswers = 0;
            if (consecutiveCorrectAnswers >= adaptiveIncreaseThreshold) {
                increaseDifficulty();
                consecutiveCorrectAnswers = 0;
            }
        } else if (status === 'incorrect') {
            consecutiveIncorrectAnswers++;
            consecutiveCorrectAnswers = 0;
            if (consecutiveIncorrectAnswers >= ADAPTIVE_DECREASE_THRESHOLD) {
                if (adaptiveDifficultyLevel !== difficultyLevels[0]) {
                     decreaseDifficulty();
                }
                consecutiveIncorrectAnswers = 0;
            }
        } else { // Skipped
             consecutiveCorrectAnswers = 0;
             consecutiveIncorrectAnswers = 0;
        }
    } else if (isChallengeMode) {
         if (status === 'correct') {
              consecutiveCorrectAnswers++;
              if (consecutiveCorrectAnswers >= challengeDifficultyIncreaseThreshold) {
                  increaseDifficulty();
                  consecutiveCorrectAnswers = 0;
              }
         } else {
             consecutiveCorrectAnswers = 0;
         }
    }
}

function updateChallengeState(status, difficulty) {
    if (!isChallengeMode || status !== 'correct' || !difficulty || difficulty === 'targeted') return;
    const timeBonus = challengeTimeBonuses[difficulty] || 0;
    challengeScore += timeBonus;
    if (sessionTimerId && remainingTime >= 0) {
        const bonusSeconds = Math.round(timeBonus);
        remainingTime += bonusSeconds;
        console.log(`Challenge Score: ${challengeScore.toFixed(1)}, Time Bonus: +${timeBonus}s (difficulty ${difficulty}), Added ${bonusSeconds}s, New Remaining: ${remainingTime}s`);
        updateStatusIndicator();
    }
}

/* ---------------------------------------
   UI & THEME MANAGEMENT
---------------------------------------- */
  function toggleMode() {
      body.classList.toggle('dark-mode');
      currentMode = body.classList.contains('dark-mode') ? 'dark' : 'light';
      themeToggleButton.textContent = currentMode === 'dark' ? '☀️' : '🌙';
      // Re-render components that depend on theme variables if they are visible
      if (!sessionActive) {
        if(resultCard?.classList.contains('active') && currentArea === 'practice-area') {
            renderTimeGraph('live', sessionDetails);
            // Pie chart is already rendered with correct colors
        }
        if(dashboardArea?.classList.contains('active') && currentArea === 'dashboard-area') {
            renderDashboard();
        }
        if (reviewDetailCard?.style.display !== 'none' && currentArea === 'review-area') {
            // Re-render the visible review graph if theme changes
            const profile = loadUserPerformance();
            const visibleSessionId = reviewDetailCard.dataset.sessionId;
            const sessionData = profile.sessionHistory.find(s => s.sessionId === visibleSessionId);
            if (sessionData) {
                renderTimeGraph('review', sessionData.details);
            }
        }
      }
      try {
         localStorage.setItem('themeMode', currentMode);
      } catch (e) {
         console.warn("Could not save theme preference to localStorage.");
      }
  }

  function applySavedTheme() {
      try {
          const savedMode = localStorage.getItem('themeMode');
          if (savedMode === 'dark') {
              body.classList.add('dark-mode');
              currentMode = 'dark';
              themeToggleButton.textContent = '☀️';
          } else {
              body.classList.remove('dark-mode');
              currentMode = 'light';
              themeToggleButton.textContent = '🌙';
          }
      } catch (e) {
          console.warn("Could not load theme preference from localStorage.");
          currentMode = 'light';
          themeToggleButton.textContent = '🌙';
      }
  }

/* ---------------------------------------
   AREA & SECTION NAVIGATION
---------------------------------------- */
function showArea(areaId) {
    if (sessionActive && areaId !== 'practice-area') {
        console.warn("Cannot switch away from Practice area during an active session.");
        closeNavMenu();
        return;
    }

    console.log(`Switching to area: ${areaId}`);
    currentArea = areaId;

    // Hide all top-level areas
    practiceArea.classList.remove('active');
    studyArea.classList.remove('active');
    dashboardArea.classList.remove('active');
    reviewArea.classList.remove('active'); // NEW

    // Show the target area
    const targetArea = document.getElementById(areaId);
    if (targetArea) {
        targetArea.classList.add('active');

        // Update page title
        if (pageTitleEl) {
             const titleText = areaId.split('-')[0]; // practice, study, dashboard
             pageTitleEl.textContent = `Mathex - ${titleText.charAt(0).toUpperCase() + titleText.slice(1)}`;
        }

        // Update active class in nav menu
        navLinks.forEach(link => {
            link.classList.remove('nav-active');
            if (link.dataset.area === areaId) {
                link.classList.add('nav-active');
            }
        });

        // --- Specific Area Setup ---
        if (areaId === 'dashboard-area') {
            renderDashboard();
        } else if (areaId === 'practice-area' && !sessionActive) {
             // If returning to practice setup, ensure correct card is visible
             if(mainCard) mainCard.style.display = 'block';
             if(sessionCard) sessionCard.style.display = 'none';
             if(resultCard) resultCard.style.display = 'none';
             if(sessionCard) sessionCard.classList.remove('active');
             if(resultCard) resultCard.classList.remove('active');
             // Show the last selected section or default to section1
             const currentActiveSectionButton = practiceArea.querySelector('.section-buttons button.active');
             if (!currentActiveSectionButton) {
                 showSection('section1');
             } else {
                 showSection(currentActiveSectionButton.id.replace('btn-',''));
             }
         } else if (areaId === 'study-area') {
            // Focus the study area container or its heading
             setTimeout(() => {
                 const studyContainer = studyArea.querySelector('.study-container');
                 (studyContainer?.querySelector('h1') || studyContainer)?.focus();
             }, 50);
             // Ensure study area answer state matches button
             const studyToggleBtn = studyArea.querySelector('#toggle-answers-btn');
             if (studyToggleBtn) {
                const state = studyToggleBtn.getAttribute('data-state');
                if (state === 'hidden') {
                    studyArea.classList.add('answers-hidden');
                } else {
                    studyArea.classList.remove('answers-hidden');
                }
             }
         } else if (areaId === 'review-area') { // NEW
            renderSessionHistoryList();
            showReviewList(); // Ensure the list is visible by default
         }
    } else {
        console.error("Target area not found:", areaId);
    }

    handleResize(); // Update layout (e.g., info button visibility) based on new area
    closeNavMenu(); // Close nav menu after switching
}

// Specific to Practice Area Sections
function showSection(sectionId) {
  // Only allow changing sections if in practice area and session is not active
  if (currentArea !== 'practice-area' || sessionActive) return;

  document.querySelectorAll('#practice-area .section').forEach((s) => {
    s.classList.remove('active');
    s.setAttribute('aria-hidden', 'true');
  });
  document.querySelectorAll('#practice-area .section-buttons button').forEach((b) => {
      b.classList.remove('active');
      b.setAttribute('aria-selected', 'false');
  });
  const targetSection = document.getElementById(sectionId);
  const targetButton = document.getElementById('btn-' + sectionId);
  if(targetSection) {
      targetSection.classList.add('active');
      targetSection.setAttribute('aria-hidden', 'false');
      const firstInput = targetSection.querySelector('input, button');
      if (firstInput && document.activeElement !== firstInput) setTimeout(() => firstInput.focus(), 50);
  }
   if(targetButton) {
      targetButton.classList.add('active');
      targetButton.setAttribute('aria-selected', 'true');
  }
   if (sectionId === 'section5') {
      updateTargetedInputs();
      updateTargetedLimitInput();
   }
}

// Specific to Practice Area Adaptive Mode Sub-toggle
function toggleSub(type) {
  if (currentArea !== 'practice-area' || sessionActive) return;

  subFqButton.classList.remove('active');
  subFtButton.classList.remove('active');
  subFqButton.setAttribute('aria-selected', 'false');
  subFtButton.setAttribute('aria-selected', 'false');
  if (type === 'fq') {
    s3AdaptiveInput.placeholder = 'Number of Questions (e.g., 15)';
    s3AdaptiveInput.dataset.mode = 'questions';
    s3InputLabel.textContent = 'Number of Questions';
    subFqButton.classList.add('active');
    subFqButton.setAttribute('aria-selected', 'true');
    s3AdaptiveInput.value = '15';
    subFqButton.focus();
  } else {
    s3AdaptiveInput.placeholder = 'Time Duration (seconds, e.g., 90)';
    s3AdaptiveInput.dataset.mode = 'time';
    s3InputLabel.textContent = 'Time Duration (seconds)';
    subFtButton.classList.add('active');
    subFtButton.setAttribute('aria-selected', 'true');
    s3AdaptiveInput.value = '90';
    subFtButton.focus();
  }
  if(document.activeElement !== s3AdaptiveInput) setTimeout(() => s3AdaptiveInput.focus(), 50);
}

 // Specific to Practice Area Checkbox/Radio Groups
 function getSelectedValues(selector) {
     // Ensure the selector targets within the practice area if needed
     const fullSelector = `#practice-area ${selector}`;
     return Array.from(document.querySelectorAll(fullSelector))
                 .filter(el => el.checked)
                 .map(el => el.value);
 }

 /* ---------------------------------------
    NAVIGATION MENU CONTROL
 ---------------------------------------- */
 function toggleNavMenu() {
     if (!hamburgerBtn || !mainNav) return;
     const isExpanded = hamburgerBtn.getAttribute('aria-expanded') === 'true';
     hamburgerBtn.classList.toggle('active');
     mainNav.classList.toggle('active');
     hamburgerBtn.setAttribute('aria-expanded', !isExpanded);
     if (!isExpanded) {
        const firstLink = mainNav.querySelector('a');
        if(firstLink) setTimeout(() => firstLink.focus(), 50);
     }
 }

 function closeNavMenu() {
     if (!hamburgerBtn || !mainNav) return;
     hamburgerBtn.classList.remove('active');
     mainNav.classList.remove('active');
     hamburgerBtn.setAttribute('aria-expanded', 'false');
 }

 if (hamburgerBtn) hamburgerBtn.addEventListener('click', toggleNavMenu);

 document.addEventListener('click', (event) => {
    // Close Nav Menu
    if (mainNav?.classList.contains('active') && !mainNav.contains(event.target) && event.target !== hamburgerBtn && !hamburgerBtn?.contains(event.target)) {
        closeNavMenu();
    }
    // Close Desktop Info Tooltip
    if (window.innerWidth > 600 && infoTooltip?.classList.contains('tooltip-visible')) {
        if (infoContainer && !infoContainer.contains(event.target)) {
            hideInfo();
        }
    }
    // Close Graph Tooltip
    if (graphTooltipEl?.classList.contains('tooltip-visible')) {
        const clickedBar = event.target.closest('.time-graph .bar');
        if (!graphTooltipEl.contains(event.target) && !clickedBar) {
             hideGraphTooltip();
        }
    }
    // Remove Study Area highlight on click outside
    if (currentArea === 'study-area') {
         const highlightedItem = studyArea.querySelector('.highlighted');
         const clickedItem = event.target.closest('#study-area .table-block p, #study-area .value-item');
         if (highlightedItem && highlightedItem !== clickedItem && !highlightedItem.contains(event.target)) {
             highlightedItem.classList.remove('highlighted');
         }
    }
 });


 /* ---------------------------------------
    SESSION SETUP & CONTROL
 ---------------------------------------- */
 function getSessionSettings() {
     const activeSection = practiceArea.querySelector('.section.active'); // Look within practice area
     if (!activeSection) {
         console.error("No active practice section found.");
         return null;
     }
     const sectionId = activeSection.id;
     let settings = {
        mode: sectionId,
        numQuestions: 0,
        timeLimit: 0,
        types: [],
        difficulty: [],
        adaptiveSubMode: 'questions',
        targetType: null,
        targetValues: [],
        targetValueMin: null,
        targetValueMax: null,
        limitType: 'questions',
     };

     // --- Standard Modes (Sections 1, 2, 3, 4) ---
     if (sectionId !== 'section5') {
         settings.types = getSelectedValues(`#${sectionId} .checkbox-options[data-group$="-types"] input:checked`);
         if (settings.types.length === 0 && sectionId !== 'section3') {
             alert("Please select at least one Question Type.");
             return null;
         }
         if (sectionId === 'section1' || sectionId === 'section2') {
             settings.difficulty = getSelectedValues(`#${sectionId} .checkbox-options[data-group$="-difficulty"] input:checked`);
             if (settings.difficulty.length === 0) {
                  settings.difficulty = ['easy']; // Default to easy if none selected
             }
         } else if (sectionId === 'section4') {
             const diffRadio = activeSection.querySelector(`#${sectionId} .checkbox-options[data-group$="-difficulty"] input[type="radio"]:checked`);
             settings.difficulty = diffRadio ? [diffRadio.value] : ['easy'];
         } else if (sectionId === 'section3') {
             settings.difficulty = ['easy']; // Adaptive starts easy
             if(settings.types.length === 0) settings.types = ['multiplication']; // Default type if none selected
         }
         try {
             let inputElement, value;
             if (sectionId === 'section1') {
                 inputElement = document.getElementById('s1-numQuestions');
                 value = parseInt(inputElement?.value, 10);
                 if (!inputElement || !inputElement.value || isNaN(value) || value < 1) { alert("Please enter a valid Number of Questions (minimum 1)."); inputElement?.focus(); return null; }
                 settings.numQuestions = value;
             } else if (sectionId === 'section2') {
                 inputElement = document.getElementById('s2-timeDuration');
                 value = parseInt(inputElement?.value, 10);
                  if (!inputElement || !inputElement.value || isNaN(value) || value < 10) { alert("Please enter a valid Time Duration (minimum 10 seconds)."); inputElement?.focus(); return null; }
                 settings.timeLimit = value;
             } else if (sectionId === 'section3') {
                 inputElement = s3AdaptiveInput;
                 settings.adaptiveSubMode = inputElement.dataset.mode || 'questions';
                 value = parseInt(inputElement?.value, 10);
                 if (!inputElement || !inputElement.value || isNaN(value)) { alert(`Please enter a valid ${settings.adaptiveSubMode === 'questions' ? 'Number of Questions' : 'Time Duration'}.`); inputElement?.focus(); return null; }
                 if (settings.adaptiveSubMode === 'questions') {
                      if (value < 1) { alert("Number of Questions must be at least 1."); inputElement?.focus(); return null; }
                     settings.numQuestions = value;
                 } else {
                      if (value < 10) { alert("Time Duration must be at least 10 seconds."); inputElement?.focus(); return null; }
                     settings.timeLimit = value;
                 }
             } else if (sectionId === 'section4') {
                 inputElement = document.getElementById('s4-timeDuration');
                 value = parseInt(inputElement?.value, 10);
                 if (!inputElement || !inputElement.value || isNaN(value) || value < 30) { alert("Please enter a valid Initial Time Duration (minimum 30 seconds)."); inputElement?.focus(); return null; }
                 settings.timeLimit = value;
             }
         } catch (e) {
             console.error("Error parsing number/time inputs:", e);
             alert("Invalid number or time entered. Please check your inputs.");
             return null;
         }
     }
     // --- Targeted Mode (Section 5) ---
     else { // sectionId === 'section5'
         settings.targetType = activeSection.querySelector('input[name="s5-target-type"]:checked')?.value;
         if (!settings.targetType) { alert("Please select a Target Type."); activeSection.querySelector('input[name="s5-target-type"]')?.focus(); return null; }
         try {
            if (settings.targetType === 'multiplicationTable') {
                const input = document.getElementById('s5-targetValue1');
                settings.targetValues = parseNumberList(input?.value);
                if (!input || settings.targetValues.length === 0) { alert("Please enter valid table numbers or range."); input?.focus(); return null; }
            } else if (settings.targetType === 'squareRange' || settings.targetType === 'cubeRange') {
                 const inputMin = document.getElementById(settings.targetType === 'squareRange' ? 's5-targetValueMinSq' : 's5-targetValueMinCb');
                 const inputMax = document.getElementById(settings.targetType === 'squareRange' ? 's5-targetValueMaxSq' : 's5-targetValueMaxCb');
                 settings.targetValueMin = parseInt(inputMin?.value, 10);
                 settings.targetValueMax = parseInt(inputMax?.value, 10);
                 if (!inputMin || !inputMax || isNaN(settings.targetValueMin) || isNaN(settings.targetValueMax) || settings.targetValueMin < 1 || settings.targetValueMax < 1) { alert("Please enter valid Min and Max values (minimum 1)."); (inputMin || inputMax)?.focus(); return null; }
                 if (settings.targetValueMin > settings.targetValueMax) { alert("Min value cannot be greater than Max value."); inputMin?.focus(); return null; }
             }
         } catch (e) {
              console.error("Error parsing targeted value inputs:", e);
              alert("Invalid target value entered. Please check your inputs.");
              return null;
         }
         settings.limitType = activeSection.querySelector('input[name="s5-limit-type"]:checked')?.value || 'questions';
         const limitInput = document.getElementById('s5-limitValue');
         const limitValue = parseInt(limitInput?.value, 10);
         if (settings.limitType === 'questions') {
             if (!limitInput || isNaN(limitValue) || limitValue < 1) { alert("Please enter a valid Number of Questions (minimum 1)."); limitInput?.focus(); return null; }
             settings.numQuestions = limitValue;
         } else { // 'time'
             if (!limitInput || isNaN(limitValue) || limitValue < 10) { alert("Please enter a valid Time Duration (minimum 10 seconds)."); limitInput?.focus(); return null; }
             settings.timeLimit = limitValue;
         }
         settings.difficulty = ['targeted']; // Use a specific difficulty identifier
         settings.types = [settings.targetType]; // Type is determined by target type
     }
     console.log("Session Settings:", settings);
     return settings;
 }

function startSession() {
  if (currentArea !== 'practice-area') return; // Can only start from practice area
  // Basic null checks for essential elements
  if (!mainCard || !sessionCard || !resultCard || !progressBar || !progressBarContainer || !statusIndicator || !sessionQuestionEl || !sessionAnswerInput) {
      console.error("Cannot start session: Essential UI elements not found.");
      alert("Error: UI components missing. Cannot start session.");
      return;
  }

  currentSessionSettings = getSessionSettings();
  if (!currentSessionSettings) return;

  sessionActive = true;
  sessionStartTime = Date.now();
  sessionEndTime = 0;
  questionIndex = 0;
  correctCount = 0;
  incorrectCount = 0;
  skippedCount = 0;
  sessionDetails = [];
  clearTimeout(sessionTimerId);
  sessionTimerId = null;
  currentQuestion = null;
  isAutoSubmitting = false;
  currentStreak = 0;
  maxStreak = 0;
  consecutiveCorrectAnswers = 0;
  consecutiveIncorrectAnswers = 0;

  totalQuestionsTarget = currentSessionSettings.numQuestions;
  sessionDurationTarget = currentSessionSettings.timeLimit;
  isAdaptiveMode = currentSessionSettings.mode === 'section3';
  isChallengeMode = currentSessionSettings.mode === 'section4';
  adaptiveDifficultyLevel = currentSessionSettings.difficulty[0] || difficultyLevels[0]; // Use first difficulty as start or default
  challengeScore = 0;
  if(challengeScoreContainer) challengeScoreContainer.classList.remove('active');

  if (isAdaptiveMode) {
       if (currentSessionSettings.adaptiveSubMode === 'questions' && totalQuestionsTarget > 0) {
           adaptiveIncreaseThreshold = Math.max(2, Math.min(5, Math.ceil(totalQuestionsTarget * 0.2)));
       } else {
           adaptiveIncreaseThreshold = 5; // Default for time-based adaptive
       }
       console.log("Adaptive Increase Threshold:", adaptiveIncreaseThreshold, "Decrease Threshold:", ADAPTIVE_DECREASE_THRESHOLD);
  }

  console.log("Starting Session - Mode:", currentSessionSettings.mode, "Adaptive:", isAdaptiveMode, "Challenge:", isChallengeMode, "Targeted:", currentSessionSettings.mode === 'section5', "Start Diff:", adaptiveDifficultyLevel);

  // UI Updates (within Practice Area)
  mainCard.style.display = 'none';
  resultCard.classList.remove('active');
  resultCard.setAttribute('aria-hidden', 'true');
  resultCard.style.display = 'none';
  sessionCard.classList.add('active');
  sessionCard.setAttribute('aria-hidden', 'false');
  sessionCard.style.display = 'block';
  progressBar.style.width = '0%';
  progressBarContainer.setAttribute('aria-valuenow', '0');
  handleResize(); // Hides info button container, etc.
  hideInfo();
  hideGraphTooltip();
  closeNavMenu();
  if (summaryPieChartContainer) summaryPieChartContainer.innerHTML = '<div class="pie-chart-placeholder" style="color: var(--text-secondary); font-style: italic; padding: 20px 0;"></div>';
  if (summaryPieChartLegend) summaryPieChartLegend.innerHTML = '';

  if (sessionDurationTarget > 0) {
       startSessionTimer(sessionDurationTarget);
   } else {
       updateStatusIndicator();
   }
  nextQuestion();
}

function updateStatusIndicator() {
    if (!statusIndicator || !progressBarContainer || !progressBar) return;
    let text = "";
    let currentProgressIndex = sessionDetails.length;
    let currentDisplayNum = currentProgressIndex + 1;
    let progressTarget = totalQuestionsTarget;
    let isTimeBasedLimit = false;
    if (currentSessionSettings?.mode === 'section2' ||
        (isAdaptiveMode && currentSessionSettings?.adaptiveSubMode === 'time') ||
        currentSessionSettings?.mode === 'section4' ||
        (currentSessionSettings?.mode === 'section5' && currentSessionSettings?.limitType === 'time')) {
        progressTarget = sessionDurationTarget;
        isTimeBasedLimit = true;
    }
    if (totalQuestionsTarget > 0 && !isTimeBasedLimit) {
        text = `Question ${Math.min(currentDisplayNum, totalQuestionsTarget)} / ${totalQuestionsTarget}`;
    } else if (isTimeBasedLimit) {
        // For time modes, just show current question number, not total time
        text = `Question ${currentDisplayNum}`;
    } else {
         // Fallback for modes without explicit limit (though should have one)
         text = `Question ${currentDisplayNum}`;
    }
    // Add targeted info if applicable
    if(currentSessionSettings && currentSessionSettings.mode === 'section5') {
        let targetDesc = '';
        switch(currentSessionSettings.targetType) {
            case 'multiplicationTable': targetDesc = `${currentSessionSettings.targetValues.join(',')}× Table`; break;
            case 'squareRange': targetDesc = `Squares ${currentSessionSettings.targetValueMin}-${currentSessionSettings.targetValueMax}`; break;
            case 'cubeRange': targetDesc = `Cubes ${currentSessionSettings.targetValueMin}-${currentSessionSettings.targetValueMax}`; break;
        }
         text = `${targetDesc} - ${text}`;
    }
    // Calculate Progress Bar Percentage
    let progressPercent = 0;
    if (progressTarget > 0) {
        if (isTimeBasedLimit) {
            // Progress based on time elapsed
            const elapsed = sessionDurationTarget - remainingTime;
            progressPercent = Math.min(100, Math.max(0, Math.round((elapsed / progressTarget) * 100)));
        } else {
            // Progress based on questions answered
            progressPercent = Math.min(100, Math.round((currentProgressIndex / progressTarget) * 100));
        }
    }
    progressBar.style.width = `${progressPercent}%`;
    progressBarContainer.setAttribute('aria-valuenow', progressPercent);
    // Add time remaining if applicable
    if (sessionDurationTarget > 0 && remainingTime >= 0) {
         const minutes = Math.floor(remainingTime / 60);
         const seconds = remainingTime % 60;
         const timeString = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
         text += ` (${timeString} left)`;
    }
    // Add difficulty/streak info
    if (isAdaptiveMode || isChallengeMode) {
        text += ` [${adaptiveDifficultyLevel}]`;
    }
    if (currentStreak > 0) {
        text += ` (Streak: ${currentStreak})`;
    }
    statusIndicator.textContent = text;
}

function startSessionTimer(durationSeconds) {
    remainingTime = durationSeconds;
    updateStatusIndicator();
    clearTimeout(sessionTimerId);
    sessionTimerId = setInterval(() => {
        if (!sessionActive) {
            clearTimeout(sessionTimerId);
            return;
        }
        remainingTime--;
        updateStatusIndicator();
        if (remainingTime < 0) {
            remainingTime = 0;
            updateStatusIndicator();
            console.log("Time's up!");
            endSession();
        }
    }, 1000);
}

function nextQuestion() {
  if (!sessionActive) return;
  if (!sessionQuestionEl || !sessionAnswerInput) return; // Element check

  if (totalQuestionsTarget > 0 && sessionDetails.length >= totalQuestionsTarget) {
    console.log("Target questions reached.");
    endSession();
    return;
  }
  questionIndex = sessionDetails.length + 1;
  isAutoSubmitting = false;
  sessionAnswerInput.value = '';
  const q = generateQuestion();
  if (!q) {
      console.error("Failed to generate question!");
      alert("Error generating question. Ending session.");
      endSession();
      return;
  }
   sessionQuestionEl.textContent = q.text;
  setTimeout(() => {
     if(sessionActive && document.activeElement !== sessionAnswerInput) sessionAnswerInput.focus();
  }, 50);
  updateStatusIndicator();
  questionStartTime = Date.now();
}


function recordAnswer(status) {
    if (!sessionActive || !currentQuestion) {
        console.warn("recordAnswer called, but session inactive or no current question.");
        return;
    }
    const timeTakenMs = Date.now() - questionStartTime;
    const userAnswerRaw = sessionAnswerInput.value.trim();
    let userAnswerFormatted = userAnswerRaw;
    if (status !== 'skipped') {
        try {
            const userAnswerFloat = parseFloat(userAnswerRaw);
            if (!isNaN(userAnswerFloat)) {
                if (currentQuestion.type === 'fractions') {
                    userAnswerFormatted = formatDecimalAnswer(userAnswerFloat);
                } else {
                     userAnswerFormatted = userAnswerRaw; // Keep raw non-fraction numbers as string
                }
            } else {
                userAnswerFormatted = userAnswerRaw; // Keep non-numeric input as is
            }
        } catch (e) {
            userAnswerFormatted = userAnswerRaw; // Fallback on error
        }
    }
    const userAnswerForStorage = (status === 'skipped') ? 'Skipped' : userAnswerFormatted;
    const { answer: correctAnswer, text: questionText, difficulty: questionDifficulty, type: questionType } = currentQuestion;
    sessionDetails.push({
        questionText: questionText || `Question ${sessionDetails.length + 1}`,
        correctAnswer: correctAnswer || 'N/A',
        userAnswer: userAnswerForStorage,
        timeMs: (status === 'skipped' ? null : timeTakenMs),
        status: status,
        difficulty: questionDifficulty,
        type: questionType
    });
    if (status === 'correct') {
        correctCount++;
        currentStreak++;
        maxStreak = Math.max(maxStreak, currentStreak);
    } else {
        currentStreak = 0;
        if (status === 'incorrect') incorrectCount++;
        else if (status === 'skipped') skippedCount++;
    }
    updateAdaptiveState(status);
    updateChallengeState(status, questionDifficulty);
    console.log(`Answer recorded: ${status}. User: '${userAnswerRaw}', Correct: '${correctAnswer}', Stored User Answer: '${userAnswerForStorage}', Q-Diff: ${questionDifficulty}. Streak: ${currentStreak}/${maxStreak}. Proceeding.`);
    nextQuestion(); // Proceed to the next question
}

function submitAnswer() {
    if (!sessionActive || isAutoSubmitting || !currentQuestion) return;
    if (!sessionAnswerInput) return; // Element check
    const userAnswerRaw = sessionAnswerInput.value.trim();
    if (userAnswerRaw === '') {
        sessionAnswerInput.focus();
        return; // Don't submit empty answers
    }
    const isCorrect = checkAnswerCorrectness(userAnswerRaw, currentQuestion);
    console.log(`Manual Submit: User='${userAnswerRaw}', Correct=${isCorrect}`);
    recordAnswer(isCorrect ? 'correct' : 'incorrect');
}

if (sessionAnswerInput) {
    sessionAnswerInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter' && sessionActive && !isAutoSubmitting) {
            event.preventDefault();
            submitAnswer();
        }
    });

    sessionAnswerInput.addEventListener('input', function(event) {
        if (sessionActive && currentQuestion && !isAutoSubmitting) {
            const userAnswerRaw = event.target.value;
            const isCorrect = checkAnswerCorrectness(userAnswerRaw, currentQuestion);
            if (isCorrect) {
                console.log(`Auto-Submit Triggered: User='${userAnswerRaw}' is correct!`);
                isAutoSubmitting = true;
                recordAnswer('correct');
            }
        }
    });
}


function skipQuestion() {
    if (!sessionActive || isAutoSubmitting || !currentQuestion) return;
    console.log("Skipping question");
    recordAnswer('skipped');
}

function endSession() {
  if (!sessionActive) return;

  sessionActive = false;
  sessionEndTime = Date.now();
  clearTimeout(sessionTimerId);
  isAutoSubmitting = false;

  const totalAnswered = correctCount + incorrectCount;
  const accuracy = totalAnswered > 0 ? ((correctCount / totalAnswered) * 100) : 0;
  const sessionActualDurationMs = sessionEndTime - sessionStartTime;

  // Compile all session data into one object
  const fullSessionData = {
    sessionId: `session_${sessionStartTime}`, // Unique ID for the session
    startTime: sessionStartTime,
    endTime: sessionEndTime,
    maxStreak: maxStreak,
    settings: { ...currentSessionSettings, isChallengeMode, challengeScore },
    details: sessionDetails,
    summary: { // Keep a summary for quick display
        correct: correctCount,
        incorrect: incorrectCount,
        skipped: skippedCount,
        accuracy: accuracy,
        durationMs: sessionActualDurationMs
    }
  };

  const userProfile = loadUserPerformance();
  userProfile.endSession(fullSessionData);
  try {
    localStorage.setItem('latestSessionResults', JSON.stringify(fullSessionData));
  } catch (e) {
    console.error('Failed to save latest results:', e);
  }

  window.location.href = 'results.html';
  return;

}

/* ---------------------------------------
   RESULT & DASHBOARD RENDERING
---------------------------------------- */

/**
 * NEW: Generic function to render the results of a session into a view.
 * @param {object} sessionData - The full session object from sessionHistory.
 * @param {'live' | 'review'} viewType - The type of view to populate.
 */
function renderResults(sessionData, viewType) {
    if (!sessionData) return;

    const isLive = viewType === 'live';
    const sDetails = sessionData.details;
    const sSummary = sessionData.summary;
    const sSettings = sessionData.settings;

    // Determine the correct DOM elements based on the view type
    const accuracyEl = document.getElementById(isLive ? 'accuracyNumber' : 'reviewAccuracyNumber');
    const correctEl = document.getElementById(isLive ? 'correctNumber' : 'reviewCorrectNumber');
    const incorrectEl = document.getElementById(isLive ? 'incorrectNumber' : 'reviewIncorrectNumber');
    const skippedEl = document.getElementById(isLive ? 'skippedNumber' : 'reviewSkippedNumber');
    const streakEl = document.getElementById(isLive ? 'streakNumber' : 'reviewStreakNumber');
    const challengeScoreNumEl = document.getElementById(isLive ? 'challengeScoreNumber' : 'reviewChallengeScoreNumber');
    const challengeScoreContEl = document.getElementById(isLive ? 'challengeScoreContainer' : 'reviewChallengeScoreContainer');
    const pieContainerEl = document.getElementById(isLive ? 'summaryPieChartContainer' : 'reviewPieChartContainer');
    const pieLegendEl = document.getElementById(isLive ? 'summaryPieChartLegend' : 'reviewPieChartLegend');
    const timeGraphEl = document.getElementById(isLive ? 'timeGraph' : 'reviewTimeGraph');
    const avgTimeEl = document.getElementById(isLive ? 'avgTimeNumber' : 'reviewAvgTimeNumber');
    const fastestEl = document.getElementById(isLive ? 'fastestNumber' : 'reviewFastestNumber');
    const slowestEl = document.getElementById(isLive ? 'slowestNumber' : 'reviewSlowestNumber');
    const totalTimeEl = document.getElementById(isLive ? 'totalTimeNumber' : 'reviewTotalTimeNumber');
    const detailTableBodyEl = document.getElementById(isLive ? 'detailTableBody' : 'reviewDetailTableBody');
    const mobileDetailContEl = document.getElementById(isLive ? 'mobileDetailContainer' : 'reviewMobileDetailContainer');
    
    // Time calculations
    const validTimesMs = sDetails
        .filter(d => d.status !== 'skipped' && typeof d.timeMs === 'number' && !isNaN(d.timeMs))
        .map(d => d.timeMs);
    const avgTimeMs = validTimesMs.length > 0 ? validTimesMs.reduce((a, b) => a + b, 0) / validTimesMs.length : 0;
    const fastestTimeMs = validTimesMs.length > 0 ? Math.min(...validTimesMs) : 0;
    const slowestTimeMs = validTimesMs.length > 0 ? Math.max(...validTimesMs) : 0;

    // Populate summary numbers
    if (accuracyEl) accuracyEl.textContent = `${sSummary.accuracy.toFixed(1)}%`;
    if (correctEl) correctEl.textContent = sSummary.correct;
    if (incorrectEl) incorrectEl.textContent = sSummary.incorrect;
    if (skippedEl) skippedEl.textContent = sSummary.skipped;
    if (streakEl) streakEl.textContent = sessionData.maxStreak;
    if (totalTimeEl) totalTimeEl.textContent = formatTime(sSummary.durationMs, false);

    // Populate time analysis
    if (avgTimeEl) avgTimeEl.textContent = formatTime(avgTimeMs, true);
    if (fastestEl) fastestEl.textContent = formatTime(fastestTimeMs, true);
    if (slowestEl) slowestEl.textContent = formatTime(slowestTimeMs, true);
    
    // Handle challenge score display
    if (challengeScoreContEl && challengeScoreNumEl) {
        if (sSettings.isChallengeMode) {
            challengeScoreNumEl.textContent = sSettings.challengeScore.toFixed(1);
            challengeScoreContEl.style.display = 'block'; // Or add 'active' class
             challengeScoreContEl.classList.add('active');
        } else {
            challengeScoreContEl.style.display = 'none';
             challengeScoreContEl.classList.remove('active');
        }
    }
    
    // Render visual components
    renderPieChart(pieContainerEl, pieLegendEl, sSummary.correct, sSummary.incorrect, sSummary.skipped);
    renderTimeGraph(timeGraphEl, sDetails);
    renderDetailResultsTable(detailTableBodyEl, mobileDetailContEl, sDetails, avgTimeMs);
}


function renderTimeGraph(container, details) {
    if (!container) return;
    container.innerHTML = '';
    hideGraphTooltip();

    if (details.length === 0) {
        container.innerHTML = '<div style="color: var(--text-secondary); font-style: italic; padding-left: 10px;">No time data available.</div>';
        return;
    }

    const timesMs = details.map(d => (d.status !== 'skipped' && d.timeMs ? d.timeMs : 0));
    const maxTime = Math.max(...timesMs, 1);
    let graphHeight = container.clientHeight;
    if (!graphHeight || graphHeight < 50) {
        graphHeight = window.innerWidth > 600 ? 250 : 150;
    }
    const maxBarHeight = Math.max(50, graphHeight * 0.9);
    const minBarHeight = 5;

    details.forEach((detail, i) => {
        const timeMs = (detail.status !== 'skipped' && detail.timeMs) ? detail.timeMs : 0;
        let height = Math.max(minBarHeight, (timeMs / maxTime) * maxBarHeight);
        
        const barContainer = document.createElement('div');
        barContainer.classList.add('bar');
        barContainer.setAttribute('tabindex', '0');
        barContainer.dataset.index = i;
        barContainer.dataset.details = JSON.stringify(detail); // Store details for tooltip

        const barInner = document.createElement('div');
        barInner.classList.add('bar-inner', detail.status);
        barInner.style.height = height + 'px';
        
        const label = document.createElement('div');
        label.classList.add('bar-label');
        label.textContent = `${i + 1}`;

        barContainer.appendChild(barInner);
        barContainer.appendChild(label);
        container.appendChild(barContainer);

        // Add event listeners for tooltips
        barContainer.addEventListener('mouseover', (e) => handleGraphHoverFocus(e, details));
        barContainer.addEventListener('focus', (e) => handleGraphHoverFocus(e, details));
        barContainer.addEventListener('mouseout', hideGraphTooltip);
        barContainer.addEventListener('blur', hideGraphTooltip);
    });
}


function renderDetailResultsTable(tableBody, mobileContainer, details, avgMs) {
    if (!tableBody || !mobileContainer) {
        console.warn("Detail results containers not found.");
        return;
    }

    tableBody.innerHTML = '';
    const mobileHeading = mobileContainer.querySelector('.subheading');
    mobileContainer.innerHTML = '';
    if (mobileHeading) mobileContainer.appendChild(mobileHeading);

    if (details.length === 0) {
        const noDataMsg = '<div style="text-align: center; color: var(--text-secondary); font-style: italic;">No details available.</div>';
        tableBody.innerHTML = `<tr><td colspan="4">${noDataMsg}</td></tr>`;
        mobileContainer.innerHTML += noDataMsg;
        return;
    }

    const fastThreshold = avgMs > 0 ? avgMs * 0.75 : Infinity;
    const slowThreshold = avgMs > 0 ? avgMs * 1.25 : 0;

    details.forEach((qd, i) => {
        const timeMs = qd.timeMs;
        const timeText = qd.status === 'skipped' ? '-' : formatTime(timeMs, true);
        const questionNum = i + 1;
        const userAnswerDisplay = (qd.status === "skipped") ? "-" : (sanitizeHTML(qd.userAnswer) || '-');
        const correctAnswerDisplay = sanitizeHTML(qd.correctAnswer);
        const questionTextDisplay = sanitizeHTML(qd.questionText);
        const difficultyText = qd.difficulty === 'targeted' ? 'Targeted' : (sanitizeHTML(qd.difficulty) || 'N/A');

        let statusPillClass = 'pill-skipped', statusText = 'Skipped';
        if (qd.status === 'correct') { statusPillClass = 'pill-correct'; statusText = 'Correct'; }
        else if (qd.status === 'incorrect') { statusPillClass = 'pill-incorrect'; statusText = 'Incorrect'; }
        const statusPillHTML = `<span class="pill ${statusPillClass}">${statusText}</span>`;

        let speedPillHTML = '';
        if (qd.status !== 'skipped' && avgMs > 0 && timeMs !== null && timeMs >= 0) {
            let speedText = 'Average', speedClass = 'pill-average';
            if (timeMs <= fastThreshold) { speedText = 'Fast'; speedClass = 'pill-fast'; }
            else if (timeMs >= slowThreshold) { speedText = 'Slow'; speedClass = 'pill-slow'; }
            speedPillHTML = ` <span class="pill ${speedClass}">${speedText}</span>`;
        }

        const difficultySpanHTML = (difficultyText !== 'Targeted' && difficultyText !== 'N/A')
            ? `<span style='font-size:0.85em; color:var(--text-secondary); margin-left: 5px;'>[${difficultyText}]</span>`
            : '';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td data-label="Question">Q${questionNum}: ${questionTextDisplay}${difficultySpanHTML} ${statusPillHTML}</td>
            <td data-label="Correct Answer">${correctAnswerDisplay}</td>
            <td data-label="Your Answer">${userAnswerDisplay}</td>
            <td data-label="Time Taken">${timeText}${speedPillHTML}</td>
        `;
        tableBody.appendChild(row);

        const card = document.createElement('div');
        card.className = 'mobile-detail-card';
        card.innerHTML = `
          <div class="mobile-detail-header">
            <div class="mobile-detail-question">Q${questionNum}: ${questionTextDisplay} ${difficultySpanHTML}</div>
            <div class="mobile-detail-status">${statusPillHTML}</div>
          </div>
          <div class="mobile-detail-body">
            <div class="mobile-detail-row">
              <span>Correct Answer:</span>
              <span>${correctAnswerDisplay}</span>
            </div>
            <div class="mobile-detail-row">
              <span>Your Answer:</span>
              <span>${userAnswerDisplay}</span>
            </div>
            <div class="mobile-detail-row">
              <span>Time Taken:</span>
              <span>${timeText}${speedPillHTML}</span>
            </div>
          </div>
        `;
        mobileContainer.appendChild(card);
    });
}


function renderPieChart(container, legendContainer, correct, incorrect, skipped) {
    if (!container || !legendContainer) return;
    const total = correct + incorrect + skipped;
    container.innerHTML = '';
    legendContainer.innerHTML = '';

    if (total === 0) {
        container.innerHTML = '<div class="pie-chart-placeholder" style="color: var(--text-secondary); font-style: italic; padding: 20px 0;">No data for chart.</div>';
        return;
    }

    const percentages = {
        correct: (correct / total) * 100,
        incorrect: (incorrect / total) * 100,
        skipped: (skipped / total) * 100,
    };

    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("viewBox", "0 0 100 100");
    svg.setAttribute("role", "img");

    const radius = 40, circumference = 2 * Math.PI * radius, strokeWidth = 20;
    let currentAngle = 0;

    const segments = [
        { value: percentages.correct, colorVar: '--pill-correct-bg', label: 'Correct', count: correct },
        { value: percentages.incorrect, colorVar: '--pill-incorrect-bg', label: 'Incorrect', count: incorrect },
        { value: percentages.skipped, colorVar: '--pill-skipped-bg', label: 'Skipped', count: skipped },
    ];

    const computedStyle = getComputedStyle(document.documentElement);

    segments.forEach(segment => {
        if (segment.value <= 0) return;
        const segmentLength = (segment.value / 100) * circumference;
        const dashOffset = circumference - (segmentLength * 0.999);

        const circle = document.createElementNS(svgNS, "circle");
        circle.setAttribute("cx", 50);
        circle.setAttribute("cy", 50);
        circle.setAttribute("r", radius);
        const strokeColor = computedStyle.getPropertyValue(segment.colorVar).trim() || '#ccc';
        circle.setAttribute("stroke", strokeColor);
        circle.setAttribute("stroke-width", strokeWidth);
        circle.setAttribute("stroke-dasharray", `${circumference} ${circumference}`);
        circle.setAttribute("transform", `rotate(${currentAngle} 50 50)`);
        circle.setAttribute("stroke-dashoffset", circumference);
        circle.style.transition = 'stroke-dashoffset 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
        
        svg.appendChild(circle);
        setTimeout(() => { circle.style.strokeDashoffset = dashOffset; }, 50);
        currentAngle += (segment.value / 100) * 360;

        if (segment.count > 0) {
            const legendItem = document.createElement('span');
            legendItem.style.setProperty('--color', strokeColor);
            legendItem.textContent = `${segment.label}: ${segment.count} (${segment.value.toFixed(1)}%)`;
            legendContainer.appendChild(legendItem);
        }
    });

    container.appendChild(svg);
}


function renderDashboard() {
    if (!dashboardArea) return;
    const profile = loadUserPerformance();
    const { globalStats, detailedPerformance, nextReviewSchedule, sessionHistory } = profile;

    // Populate Overall Stats
    const overallStatsContainer = dashboardArea.querySelector('#overall-stats .subcards');
    if (overallStatsContainer) {
        const totalCorrect = Object.values(detailedPerformance).flatMap(Object.values).reduce((sum, s) => sum + s.correct, 0);
        const totalAnsweredForAcc = totalCorrect + Object.values(detailedPerformance).flatMap(Object.values).reduce((sum, s) => sum + s.incorrect, 0);
        const overallAccuracy = totalAnsweredForAcc > 0 ? (totalCorrect / totalAnsweredForAcc) * 100 : 0;

        overallStatsContainer.innerHTML = `
            <div class="result-subcard">
              <div class="hero-number">${overallAccuracy.toFixed(1)}%</div>
              <div class="hero-label">Overall Accuracy</div>
            </div>
            <div class="result-subcard">
              <div class="hero-number">${formatBigNumber(globalStats.totalQuestionsAnswered)}</div>
              <div class="hero-label">Total Answered</div>
            </div>
            <div class="result-subcard">
              <div class="hero-number">${formatBigNumber(globalStats.totalSessions)}</div>
              <div class="hero-label">Total Sessions</div>
            </div>
            <div class="result-subcard">
              <div class="hero-number">${formatTime(globalStats.totalTimePracticed, false)}</div>
              <div class="hero-label">Total Time Practiced</div>
            </div>
             <div class="result-subcard">
              <div class="hero-number">${globalStats.allTimeBestStreak || 0}</div>
              <div class="hero-label">All-Time Best Streak</div>
            </div>
        `;
    }

    const generateRowHTML = (name, stats) => {
        const accuracy = (stats.correct + stats.incorrect > 0) ? (stats.correct / (stats.correct + stats.incorrect)) * 100 : 0;
        const avgTime = stats.correct > 0 ? stats.totalTimeCorrect / stats.correct : 0;
        const mastery = stats.mastery || 0;
        return `
            <tr>
                <td class="type-name">${name}</td>
                <td>${accuracy.toFixed(1)}%</td>
                <td>
                    <div class="mastery-bar-container" title="Mastery: ${(mastery * 100).toFixed(1)}%">
                        <div class="mastery-bar" style="width: ${mastery * 100}%;"></div>
                    </div>
                </td>
                <td>${formatTime(avgTime, true)}</td>
            </tr>
        `;
    };

    const typeTableBody = dashboardArea.querySelector('#type-performance-table tbody');
    if (typeTableBody) {
        typeTableBody.innerHTML = '';
        questionTypes.forEach(type => {
            const typeStats = Object.values(detailedPerformance[type] || {}).reduce((acc, diffStats) => {
                acc.correct += diffStats.correct;
                acc.incorrect += diffStats.incorrect;
                acc.totalTimeCorrect += diffStats.totalTimeCorrect;
                acc.totalAttempts += diffStats.totalAttempts;
                return acc;
            }, { correct: 0, incorrect: 0, totalTimeCorrect: 0, totalAttempts: 0 });

            typeStats.mastery = typeStats.totalAttempts > 0 ? typeStats.correct / typeStats.totalAttempts : 0;

            if (typeStats.totalAttempts > 0) {
                const name = type.replace('cbrt', 'Cube Root').replace('sqrt', 'Square Root');
                typeTableBody.innerHTML += generateRowHTML(name, typeStats);
            }
        });
    }

    const diffTableBody = dashboardArea.querySelector('#difficulty-performance-table tbody');
    if (diffTableBody) {
        diffTableBody.innerHTML = '';
        difficultyLevels.forEach(diff => {
             const diffStats = questionTypes.reduce((acc, type) => {
                const stats = detailedPerformance[type]?.[diff];
                if(stats) {
                    acc.correct += stats.correct;
                    acc.incorrect += stats.incorrect;
                    acc.totalTimeCorrect += stats.totalTimeCorrect;
                    acc.totalAttempts += stats.totalAttempts;
                }
                return acc;
            }, { correct: 0, incorrect: 0, totalTimeCorrect: 0, totalAttempts: 0 });

             diffStats.mastery = diffStats.totalAttempts > 0 ? diffStats.correct / diffStats.totalAttempts : 0;

             if (diffStats.totalAttempts > 0) {
                diffTableBody.innerHTML += generateRowHTML(diff, diffStats);
            }
        });
    }

    const reviewItemsContainer = dashboardArea.querySelector('#review-items');
    const reviewMessage = dashboardArea.querySelector('#review-message');
    if (reviewItemsContainer && reviewMessage) {
        reviewItemsContainer.innerHTML = '';
        const now = new Date();
        const upcomingReviews = [];
        for (const type in nextReviewSchedule) {
            for (const difficulty in nextReviewSchedule[type]) {
                const reviewDate = new Date(nextReviewSchedule[type][difficulty]);
                if (reviewDate <= now) {
                    upcomingReviews.push({ type, difficulty, date: reviewDate });
                }
            }
        }

        if (upcomingReviews.length > 0) {
            reviewMessage.textContent = "These topics are ready for review to strengthen your mastery!";
            upcomingReviews
                .sort((a,b) => a.date - b.date)
                .forEach(item => {
                    const name = `${item.difficulty} ${item.type}`.replace('cbrt', 'Cube Root').replace('sqrt', 'Square Root');
                    const reviewCard = document.createElement('div');
                    reviewCard.className = 'result-subcard';
                    reviewCard.innerHTML = `<div class="hero-label" style="font-weight: 600; text-transform: capitalize;">${name}</div><div class="review-time">Review now</div>`;
                    reviewItemsContainer.appendChild(reviewCard);
                });
        } else {
            reviewMessage.textContent = "Great job! No topics are currently due for review.";
        }
    }
    
    // NEW: Call functions to render new dashboard components
    renderPerformanceTrendChart(sessionHistory);
    renderDashboardInsights(profile);
}


/* ---------------------------------------
   GRAPH TOOLTIP FUNCTIONS
---------------------------------------- */
function handleGraphHoverFocus(event, details) {
    if (window.innerWidth <= 600) return;
    const barElement = event.currentTarget;
    const index = parseInt(barElement.dataset.index, 10);
    if (isNaN(index) || !details || index < 0 || index >= details.length) return;
    const detail = details[index];
    showGraphTooltip(detail, index + 1, barElement, event);
}

function showGraphTooltip(detail, questionNum, targetElement, event) {
    if (!graphTooltipEl) return;
    const timeText = detail.status === 'skipped' ? '-' : formatTime(detail.timeMs, true);
    const userAnswerDisplay = (detail.status === "skipped") ? "-" : (sanitizeHTML(detail.userAnswer) || '-');
    const correctAnswerDisplay = sanitizeHTML(detail.correctAnswer);
    const questionTextDisplay = sanitizeHTML(detail.questionText);
    const difficultyText = detail.difficulty === 'targeted' ? 'Targeted' : (sanitizeHTML(detail.difficulty) || 'N/A');
    const difficultySpanHTML = (difficultyText !== 'Targeted' && difficultyText !== 'N/A') ? ` [${difficultyText}]` : '';

    let statusPillClass = 'pill-skipped', statusText = 'Skipped';
    if (detail.status === 'correct') { statusPillClass = 'pill-correct'; statusText = 'Correct'; }
    else if (detail.status === 'incorrect') { statusPillClass = 'pill-incorrect'; statusText = 'Incorrect'; }
    const statusPillHTML = `<span class="pill ${statusPillClass}">${statusText}</span>`;

    graphTooltipEl.innerHTML = `
        <div><strong>Q${questionNum}:</strong> ${questionTextDisplay}${difficultySpanHTML}</div>
        <div><strong>Status:</strong> ${statusPillHTML}</div>
        <div><strong>Correct:</strong> ${correctAnswerDisplay}</div>
        <div><strong>Yours:</strong> ${userAnswerDisplay}</div>
        <div><strong>Time:</strong> ${timeText}</div>
    `;
    updateTooltipPosition(event, targetElement);
    graphTooltipEl.classList.add('tooltip-visible');
}

function hideGraphTooltip() {
    if (graphTooltipEl) {
        graphTooltipEl.classList.remove('tooltip-visible');
    }
}

function updateTooltipPosition(event, targetElement) {
    if (!graphTooltipEl || !event) return;
    const PADDING = 15;
    let x, y;
    if (event.type.includes('mouse') && event.clientX && event.clientY) {
         x = event.clientX + PADDING;
         y = event.clientY + PADDING;
    } else if (targetElement) {
        const rect = targetElement.getBoundingClientRect();
        x = rect.left + window.scrollX;
        let tooltipHeight = graphTooltipEl.offsetHeight;
        if(tooltipHeight === 0) {
            graphTooltipEl.style.visibility = 'hidden';
            graphTooltipEl.style.display = 'block';
            tooltipHeight = graphTooltipEl.offsetHeight;
            graphTooltipEl.style.visibility = '';
            graphTooltipEl.style.display = '';
        }
        tooltipHeight = tooltipHeight || 50;
        y = rect.top + window.scrollY - PADDING - tooltipHeight;
        if (y < window.scrollY + PADDING) {
             y = rect.bottom + window.scrollY + PADDING;
        }
    } else {
        return;
    }
    const tooltipRect = graphTooltipEl.getBoundingClientRect();
    const tooltipWidth = tooltipRect.width || 200;
    const tooltipHeight = tooltipRect.height || 50;
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const currentScrollX = window.scrollX;
    const currentScrollY = window.scrollY;

    if (x + tooltipWidth + PADDING > vw + currentScrollX) {
        x = vw + currentScrollX - tooltipWidth - PADDING;
    }
    if (x < currentScrollX + PADDING) {
        x = currentScrollX + PADDING;
    }
    if (y + tooltipHeight + PADDING > vh + currentScrollY) {
         if (event.type.includes('mouse') && event.clientY) {
             y = event.clientY + currentScrollY - tooltipHeight - PADDING;
         } else if (targetElement) {
             const rect = targetElement.getBoundingClientRect();
             y = rect.top + currentScrollY - tooltipHeight - PADDING;
         } else {
             y = vh + currentScrollY - tooltipHeight - PADDING;
         }
    }
    if (y < currentScrollY + PADDING) {
        y = currentScrollY + PADDING;
    }
    graphTooltipEl.style.left = `${x}px`;
    graphTooltipEl.style.top = `${y}px`;
}

/* ---------------------------------------
   RESIZE HANDLING & RESPONSIVENESS
---------------------------------------- */
 let resizeTimeout;
function handleResize() {
    const isMobile = window.innerWidth <= 600;
    if (!pageTab || !hamburgerBtn || !mainNav || !resultCard || !infoContainer || !infoButton || !timeGraphContainer || !summaryPieChartContainer) {
        return;
    }

    if (!isMobile && mainNav.classList.contains('active')) {
        closeNavMenu();
    }

    if (currentArea === 'practice-area') {
        if (isMobile) {
            infoContainer.style.display = 'none';
        } else {
            infoContainer.style.display = sessionActive ? 'none' : 'flex';
        }
    } else {
        infoContainer.style.display = 'none';
    }

    if (currentArea === 'practice-area' && !sessionActive && resultCard.classList.contains('active')) {
       renderTimeGraph(timeGraphContainer, sessionDetails);
       renderPieChart(summaryPieChartContainer, summaryPieChartLegend, correctCount, incorrectCount, skippedCount);
    }

    hideInfo();
    hideGraphTooltip();
}

window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(handleResize, 100);
});

/* ---------------------------------------
   INFO TOOLTIP/MODAL LOGIC
---------------------------------------- */
 function showInfo() {
     if (sessionActive && currentArea === 'practice-area') return;
     closeNavMenu();

     if (window.innerWidth <= 600) {
         if(infoModalOverlay) infoModalOverlay.classList.add('modal-visible');
         if(infoModalCloseBtn) setTimeout(() => infoModalCloseBtn.focus(), 50);
     } else {
         if (currentArea === 'practice-area' && !sessionActive) {
             if (infoTooltip) infoTooltip.classList.add('tooltip-visible');
             if (infoButton) infoButton.setAttribute('aria-expanded', 'true');
         } else {
              if(infoModalOverlay) infoModalOverlay.classList.add('modal-visible');
              if(infoModalCloseBtn) setTimeout(() => infoModalCloseBtn.focus(), 50);
         }
     }
 }

 function hideInfo() {
     if (infoTooltip) infoTooltip.classList.remove('tooltip-visible');
     if (infoModalOverlay) infoModalOverlay.classList.remove('modal-visible');
     if (infoButton) infoButton.setAttribute('aria-expanded', 'false');
 }

 if (infoButton) {
     infoButton.addEventListener('click', (event) => {
         if (currentArea !== 'practice-area' || sessionActive || window.innerWidth <= 600) return;
         event.stopPropagation();
         const isExpanded = infoButton.getAttribute('aria-expanded') === 'true';
         if (isExpanded) hideInfo();
         else showInfo();
     });
 }

 if (infoModalCloseBtn) infoModalCloseBtn.addEventListener('click', hideInfo);

 if (infoModalOverlay) {
     infoModalOverlay.addEventListener('click', (event) => {
         if (event.target === infoModalOverlay) hideInfo();
     });
 }

 if(infoContainer && infoTooltip && infoButton) {
     let leaveTimeout;
     infoContainer.addEventListener('mouseenter', () => {
         clearTimeout(leaveTimeout);
         if (currentArea === 'practice-area' && window.innerWidth > 600 && !sessionActive && !infoTooltip.classList.contains('tooltip-visible') && mainNav && !mainNav.classList.contains('active')) {
             showInfo();
         }
     });
     infoContainer.addEventListener('mouseleave', () => {
         leaveTimeout = setTimeout(() => {
            if (window.innerWidth > 600 && !infoContainer.contains(document.activeElement)) {
                hideInfo();
            }
         }, 150);
     });
     infoContainer.addEventListener('focusin', () => {
          clearTimeout(leaveTimeout);
         if (currentArea === 'practice-area' && window.innerWidth > 600 && !sessionActive && !infoTooltip.classList.contains('tooltip-visible') && mainNav && !mainNav.classList.contains('active')) {
             showInfo();
         }
     });
     infoContainer.addEventListener('focusout', (event) => {
         setTimeout(() => {
             const targetIsInside = infoContainer.contains(event.relatedTarget) || infoTooltip.contains(event.relatedTarget);
            if (window.innerWidth > 600 && !targetIsInside) {
                hideInfo();
            }
         }, 50);
     });
 }

  window.addEventListener('scroll', hideGraphTooltip, true);

/* ---------------------------------------
   KEYBOARD SHORTCUTS
---------------------------------------- */
document.addEventListener('keydown', (event) => {
    const targetIsInput = event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA';
    const isSessionAnswerInputFocused = document.activeElement === sessionAnswerInput;
    const isStudyJumpInputFocused = studyArea && document.activeElement === studyArea.querySelector('#jump-to-input');

    if (event.key === 'Escape') {
         event.preventDefault();
         let closedSomething = false;
         if (mainNav?.classList.contains('active')) {
             closeNavMenu();
             hamburgerBtn?.focus();
             console.log("Shortcut: Esc Close Nav Menu");
             closedSomething = true;
         }
         else if ((infoModalOverlay?.classList.contains('modal-visible')) || (infoTooltip?.classList.contains('tooltip-visible'))) {
            hideInfo();
            if (window.innerWidth > 600 && currentArea === 'practice-area' && !sessionActive) infoButton?.focus();
            console.log("Shortcut: Esc Close Info");
            closedSomething = true;
        }
         else if (graphTooltipEl?.classList.contains('tooltip-visible')) {
             hideGraphTooltip();
             console.log("Shortcut: Esc Close Graph Tooltip");
             closedSomething = true;
         }
          if (!closedSomething && sessionActive && currentArea === 'practice-area') {
             sessionAnswerInput?.focus();
             console.log("Shortcut: Esc Focus Answer Input");
         } else if (!closedSomething && currentArea === 'study-area') {
             if(isStudyJumpInputFocused) event.target.blur();
         }
    }
    else if (sessionActive && currentArea === 'practice-area') {
        if (event.key.toLowerCase() === 's' && !isAutoSubmitting) {
             event.preventDefault();
             skipQuestion();
             console.log("Shortcut: Skip");
        }
    }
    else if (!targetIsInput) {
         if (event.key.toLowerCase() === 't') {
             event.preventDefault();
             toggleMode();
             console.log("Shortcut: Toggle Theme");
         }
         else if (event.key === '?' || event.key.toLowerCase() === 'i') {
             if (!(sessionActive && currentArea === 'practice-area')) {
                 event.preventDefault();
                 const infoVisible = (infoModalOverlay?.classList.contains('modal-visible')) || (infoTooltip?.classList.contains('tooltip-visible'));
                 if (infoVisible) {
                     hideInfo();
                     console.log("Shortcut: Hide Info");
                 } else {
                     showInfo();
                     console.log("Shortcut: Show Info");
                 }
             }
         }
    }
});


/* ---------------------------------------
   PLAY AGAIN FUNCTIONALITY
---------------------------------------- */
function resetToMainScreen() {
    console.log("Resetting to main practice screen...");
    if (sessionActive) endSession();
    sessionActive = false;
    clearTimeout(sessionTimerId);
    sessionTimerId = null;
    isAutoSubmitting = false;
    currentQuestion = null;

    if (!mainCard || !sessionCard || !resultCard) {
        console.error("Cannot reset: Main/Session/Result card not found.");
        return;
    }

    showArea('practice-area');
    mainCard.style.display = 'block';
    sessionCard.style.display = 'none';
    sessionCard.classList.remove('active');
    resultCard.style.display = 'none';
    resultCard.classList.remove('active');

    showSection('section1');
    handleResize();
    closeNavMenu();

     const accuracyEl = document.getElementById('accuracyNumber');
     const correctEl = document.getElementById('correctNumber');
     const incorrectEl = document.getElementById('incorrectNumber');
     const skippedEl = document.getElementById('skippedNumber');
     const avgTimeEl = document.getElementById('avgTimeNumber');
     const fastestEl = document.getElementById('fastestNumber');
     const slowestEl = document.getElementById('slowestNumber');

     if(accuracyEl) accuracyEl.textContent = '0%';
     if(correctEl) correctEl.textContent = '0';
     if(incorrectEl) incorrectEl.textContent = '0';
     if(skippedEl) skippedEl.textContent = '0';
     if(challengeScoreContainer) challengeScoreContainer.classList.remove('active');
     if(avgTimeEl) avgTimeEl.textContent = '0s';
     if(fastestEl) fastestEl.textContent = '0s';
     if(slowestEl) slowestEl.textContent = '0s';
     if(streakNumberEl) streakNumberEl.textContent = '0';
     if(totalTimeNumberEl) totalTimeNumberEl.textContent = '0s';
     if (timeGraphContainer) timeGraphContainer.innerHTML = '<div style="color: var(--text-secondary); font-style: italic; padding-left: 10px;">No time data yet.</div>';
     if (detailTableBody) detailTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary); font-style: italic;">No details yet.</td></tr>';
     if (mobileDetailContainer) mobileDetailContainer.innerHTML = '<div class="subheading">Detailed Results</div><div style="text-align: center; color: var(--text-secondary); font-style: italic;">No details yet.</div>';
    if (summaryPieChartContainer) summaryPieChartContainer.innerHTML = '<div class="pie-chart-placeholder" style="color: var(--text-secondary); font-style: italic; padding: 20px 0;"></div>';
    if (summaryPieChartLegend) summaryPieChartLegend.innerHTML = '';

    mainCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    const firstSectionBtn = document.getElementById('btn-section1');
    if (firstSectionBtn) setTimeout(() => firstSectionBtn.focus(), 100);
}


/* =======================================
   STUDY AREA JAVASCRIPT LOGIC
======================================== */
function initializeStudyArea() {
    console.log("Initializing Study Area...");
    const MULTIPLICATION_LIMIT = 50;
    const MULTIPLICATION_DEPTH = 10;
    const SQUARES_LIMIT = 50;
    const CUBES_LIMIT = 30;
    const JUMP_TO_DEBOUNCE_DELAY = 300;

    const studyContainer = studyArea.querySelector('.study-container');
    const tabButtonsStudy = studyArea.querySelectorAll('.tab-button');
    const tabContentsStudy = studyArea.querySelectorAll('.tab-content');
    const multiplicationContainerStudy = studyArea.querySelector('#multiplication-tables-grid');
    const squaresContainerStudy = studyArea.querySelector('#squares-tables-grid');
    const cubesContainerStudy = studyArea.querySelector('#cubes-tables-grid');
    const jumpToInputStudy = studyArea.querySelector('#jump-to-input');
    const toggleAnswersBtnStudy = studyArea.querySelector('#toggle-answers-btn');

    if (!studyContainer || tabButtonsStudy.length === 0 || tabContentsStudy.length === 0 || !multiplicationContainerStudy || !squaresContainerStudy || !cubesContainerStudy || !jumpToInputStudy || !toggleAnswersBtnStudy) {
         console.error("Study Area Initialization Failed: Missing required elements.");
         studyArea.innerHTML = `<div class='study-container' style='text-align: center; padding: 40px;'><h2>Error</h2><p style='color: var(--text-secondary);'>Could not load study materials. Required components are missing.</p></div>`;
         return;
    }

    const debounceStudy = (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    };

    tabButtonsStudy.forEach(button => {
        button.addEventListener('click', () => {
            const targetTabId = button.getAttribute('data-tab');
            const targetTabContent = studyArea.querySelector(`#${targetTabId}`);
            if (!targetTabContent) return;
            tabButtonsStudy.forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            tabContentsStudy.forEach(content => {
                content.classList.remove('active');
                const highlightedItem = content.querySelector('.highlighted');
                if (highlightedItem) {
                    highlightedItem.classList.remove('highlighted');
                }
            });
            button.classList.add('active');
            button.setAttribute('aria-selected', 'true');
            targetTabContent.classList.add('active');
            try {
               localStorage.setItem('activeMathTab', targetTabId);
            } catch(e){ console.warn("Could not save study tab preference."); }
        });
    });

    function generateMultiplicationTablesStudy() {
        let html = '';
        for (let i = 1; i <= MULTIPLICATION_LIMIT; i++) {
            html += `<div class="table-block" data-number="${i}" id="table-${i}">`;
            html += `<h3>Table of ${i}</h3>`;
            for (let j = 1; j <= MULTIPLICATION_DEPTH; j++) {
                html += `<p>${i} × ${j} = <span class="answer-value">${i * j}</span></p>`;
            }
            html += `</div>`;
        }
        multiplicationContainerStudy.innerHTML = html;
    }

    function generateSquaresStudy() {
        let html = '';
        for (let i = 1; i <= SQUARES_LIMIT; i++) {
            html += `<div class="value-item"><p>${i}<sup>2</sup> = <span class="answer-value">${i * i}</span></p></div>`;
        }
        squaresContainerStudy.innerHTML = html;
    }

    function generateCubesStudy() {
        let html = '';
        for (let i = 1; i <= CUBES_LIMIT; i++) {
            html += `<div class="value-item"><p>${i}<sup>3</sup> = <span class="answer-value">${i * i * i}</span></p></div>`;
        }
        cubesContainerStudy.innerHTML = html;
    }

    const handleJumpToStudy = debounceStudy(() => {
        let tableNumber = parseInt(jumpToInputStudy.value, 10);
         const multTabButton = studyArea.querySelector('.tab-button[data-tab="multiplication"]');
         if (!multTabButton || !multTabButton.classList.contains('active')) {
             console.log("Jump-to only works on Multiplication tab.");
             return;
         }
        if (isNaN(tableNumber)) {
            return;
        } else if (tableNumber < 1) {
            tableNumber = 1;
            jumpToInputStudy.value = '1';
        } else if (tableNumber > MULTIPLICATION_LIMIT) {
            tableNumber = MULTIPLICATION_LIMIT;
            jumpToInputStudy.value = MULTIPLICATION_LIMIT;
        }
        const targetTable = studyArea.querySelector(`#table-${tableNumber}`);
        if (targetTable) {
            targetTable.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetTable.style.transition = 'background-color 0.5s ease, box-shadow 0.5s ease';
            const originalBg = getComputedStyle(targetTable).backgroundColor;
             const computedStyle = getComputedStyle(document.documentElement);
             const shadowDark = computedStyle.getPropertyValue('--shadow-dark').trim();
             const shadowLight = computedStyle.getPropertyValue('--shadow-light').trim();
             const highlightShadow = `inset 4px 4px 8px ${shadowDark}, inset -4px -4px 8px ${shadowLight}, 5px 5px 10px ${shadowDark}, -5px -5px 10px ${shadowLight}`;
             const originalShadow = getComputedStyle(targetTable).boxShadow;
             targetTable.style.backgroundColor = 'rgba(128, 128, 128, 0.15)';
             targetTable.style.boxShadow = highlightShadow;
            setTimeout(() => {
                targetTable.style.backgroundColor = originalBg;
                targetTable.style.boxShadow = originalShadow;
                 setTimeout(() => {
                     targetTable.style.transition = '';
                     targetTable.style.backgroundColor = '';
                     targetTable.style.boxShadow = '';
                 }, 500);
            }, 1200);
        }
    }, JUMP_TO_DEBOUNCE_DELAY);

    jumpToInputStudy.addEventListener('input', handleJumpToStudy);
     jumpToInputStudy.addEventListener('keypress', (event) => {
         if (event.key === 'Enter') {
             event.preventDefault();
             handleJumpToStudy();
         }
     });

     toggleAnswersBtnStudy.addEventListener('click', () => {
        const currentState = toggleAnswersBtnStudy.getAttribute('data-state');
        if (currentState === 'shown') {
            studyArea.classList.add('answers-hidden');
            toggleAnswersBtnStudy.textContent = 'Show Answers';
            toggleAnswersBtnStudy.setAttribute('data-state', 'hidden');
        } else {
            studyArea.classList.remove('answers-hidden');
            toggleAnswersBtnStudy.textContent = 'Hide Answers';
            toggleAnswersBtnStudy.setAttribute('data-state', 'shown');
        }
     });

    function handleHighlightClickStudy(event) {
        const target = event.target;
        const clickableItem = target.closest('#study-area .table-block p, #study-area .value-item');
        if (clickableItem) {
            let itemToHighlight = clickableItem;
            const parentContainer = itemToHighlight.closest('.tab-content');
            if (!parentContainer) return;
            const currentlyHighlighted = parentContainer.querySelector('.highlighted');
            let clickedExistingHighlight = (currentlyHighlighted === itemToHighlight);
            if (currentlyHighlighted) {
                currentlyHighlighted.classList.remove('highlighted');
            }
            if (!clickedExistingHighlight) {
                itemToHighlight.classList.add('highlighted');
            }
        }
    }

    if(multiplicationContainerStudy) multiplicationContainerStudy.addEventListener('click', handleHighlightClickStudy);
    if(squaresContainerStudy) squaresContainerStudy.addEventListener('click', handleHighlightClickStudy);
    if(cubesContainerStudy) cubesContainerStudy.addEventListener('click', handleHighlightClickStudy);

    function setupStudyArea() {
        const lastTab = localStorage.getItem('activeMathTab');
        const defaultActiveButtonStudy = studyArea.querySelector('.tab-button.active');
        const defaultActiveContentStudy = studyArea.querySelector('.tab-content.active');

        if(defaultActiveButtonStudy) {
            defaultActiveButtonStudy.classList.remove('active');
            defaultActiveButtonStudy.setAttribute('aria-selected', 'false');
        }
        if(defaultActiveContentStudy) defaultActiveContentStudy.classList.remove('active');

        let tabToActivate = lastTab || 'multiplication';
        const lastActiveButtonStudy = studyArea.querySelector(`.tab-button[data-tab="${tabToActivate}"]`);
        const lastActiveContentStudy = studyArea.querySelector(`#${tabToActivate}`);

         if(lastActiveButtonStudy && lastActiveContentStudy) {
             lastActiveButtonStudy.classList.add('active');
             lastActiveButtonStudy.setAttribute('aria-selected', 'true');
             lastActiveContentStudy.classList.add('active');
         } else {
             const firstTabButton = studyArea.querySelector('.tab-button');
             const firstTabContent = studyArea.querySelector('.tab-content');
             if(firstTabButton) {
                 firstTabButton.classList.add('active');
                 firstTabButton.setAttribute('aria-selected', 'true');
             }
              if(firstTabContent) firstTabContent.classList.add('active');
         }
        generateMultiplicationTablesStudy();
        generateSquaresStudy();
        generateCubesStudy();
        console.log("Study Area Content Generated.");
    }
    setupStudyArea();
}


 /* =======================================
   GLOBAL BACK TO TOP LOGIC
======================================== */
function initializeBackToTop() {
    const SCROLL_THRESHOLD_FOR_BACK_TO_TOP = 300;
    if (!backToTopBtnGlobal) return;

    window.addEventListener('scroll', () => {
       if (window.scrollY > SCROLL_THRESHOLD_FOR_BACK_TO_TOP) {
           backToTopBtnGlobal.classList.add('visible');
       } else {
           backToTopBtnGlobal.classList.remove('visible');
       }
    });
    backToTopBtnGlobal.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    console.log("Back to Top Initialized.");
}


/* =======================================
   NEW REVIEW AREA & DASHBOARD FUNCTIONS
======================================== */
function renderSessionHistoryList() {
    if (!sessionListContainer) return;
    const profile = loadUserPerformance();
    sessionListContainer.innerHTML = '';

    if (profile.sessionHistory.length === 0) {
        sessionListContainer.innerHTML = `<p style="color: var(--text-secondary); font-style: italic;">Your past practice sessions will appear here.</p>`;
        return;
    }

    profile.sessionHistory.forEach(session => {
        const item = document.createElement('div');
        item.className = 'session-list-item';
        item.setAttribute('tabindex', '0');
        item.setAttribute('role', 'button');
        item.dataset.sessionId = session.sessionId;

        const date = new Date(session.startTime);
        const formattedDate = date.toLocaleString(undefined, {
            year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
        });
        
        const modeText = (session.settings.mode || 'Practice').replace('section', 'Mode ');

        item.innerHTML = `
            <div class="session-list-info">
                <div class="date">${formattedDate}</div>
                <div class="mode">${modeText}</div>
            </div>
            <div class="session-list-stats">
                <div class="stat"><span class="label">🎯</span>${session.summary.accuracy.toFixed(1)}%</div>
                <div class="stat"><span class="label">📈</span>${session.maxStreak}</div>
                <div class="stat"><span class="label">⏱️</span>${formatTime(session.summary.durationMs, false)}</div>
            </div>
        `;
        item.addEventListener('click', () => showSessionReviewDetail(session.sessionId));
        item.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' || e.key === ' ') showSessionReviewDetail(session.sessionId);
        });
        sessionListContainer.appendChild(item);
    });
}

function showSessionReviewDetail(sessionId) {
    const profile = loadUserPerformance();
    const sessionData = profile.sessionHistory.find(s => s.sessionId === sessionId);
    if (!sessionData) {
        alert("Error: Could not find session data.");
        return;
    }

    if (reviewListCard) reviewListCard.style.display = 'none';
    if (reviewDetailCard) {
        reviewDetailCard.dataset.sessionId = sessionId; // Store for theme changes
        reviewDetailCard.style.display = 'block';
        reviewDetailCard.setAttribute('aria-hidden', 'false');
    }

    const detailTitle = document.getElementById('reviewDetailTitle');
    if(detailTitle) detailTitle.textContent = `Review of Session from ${new Date(sessionData.startTime).toLocaleDateString()}`;

    renderResults(sessionData, 'review');
    reviewDetailCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function showReviewList() {
    if (reviewDetailCard) {
        reviewDetailCard.style.display = 'none';
        reviewDetailCard.setAttribute('aria-hidden', 'true');
    }
    if (reviewListCard) {
        reviewListCard.style.display = 'block';
        reviewListCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function renderPerformanceTrendChart(sessionHistory) {
    const container = document.getElementById('performanceTrendChart');
    if (!container) return;

    const history = [...sessionHistory].reverse(); // Chart from oldest to newest
    if (history.length < 2) {
        container.innerHTML = `<div style="color: var(--text-secondary); font-style: italic; padding: 20px;">Complete at least two sessions to see your progress trends.</div>`;
        return;
    }
    container.innerHTML = ''; // Clear placeholder

    const accuracies = history.map(s => s.summary.accuracy);
    const avgTimes = history.map(s => {
        const validTimes = s.details.filter(d => d.timeMs !== null).map(d => d.timeMs);
        return validTimes.length > 0 ? validTimes.reduce((a, b) => a + b, 0) / validTimes.length : 0;
    });

    const maxAvgTime = Math.max(...avgTimes, 1);
    const graphHeight = container.clientHeight || 200;
    const maxBarHeight = graphHeight * 0.9;
    const minBarHeight = 2;
    
    // Simple bar chart visualization
    history.forEach((session, i) => {
        const accuracyHeight = Math.max(minBarHeight, (accuracies[i] / 100) * maxBarHeight);
        const timeHeight = Math.max(minBarHeight, (avgTimes[i] / maxAvgTime) * maxBarHeight);

        const barGroup = document.createElement('div');
        barGroup.classList.add('bar');
        barGroup.style.flexDirection = 'row';
        barGroup.style.gap = '2px';
        barGroup.setAttribute('tabindex', '0');
        barGroup.setAttribute('aria-label', `Session ${i+1}: Accuracy ${accuracies[i].toFixed(1)}%, Avg. Time ${formatTime(avgTimes[i])}`);

        // Accuracy bar
        const accBar = document.createElement('div');
        accBar.classList.add('bar-inner', 'correct');
        accBar.style.height = `${accuracyHeight}px`;
        accBar.style.width = '8px';
        accBar.title = `Accuracy: ${accuracies[i].toFixed(1)}%`;
        
        // Time bar
        const timeBar = document.createElement('div');
        timeBar.classList.add('bar-inner');
        timeBar.style.backgroundColor = 'var(--mastery-color)';
        timeBar.style.height = `${timeHeight}px`;
        timeBar.style.width = '8px';
        timeBar.title = `Avg. Time: ${formatTime(avgTimes[i])}`;
        
        const label = document.createElement('div');
        label.classList.add('bar-label');
        label.textContent = i + 1;

        const barContainer = document.createElement('div');
        barContainer.style.display = 'flex';
        barContainer.style.flexDirection = 'column';
        barContainer.style.alignItems = 'center';
        
        barGroup.appendChild(accBar);
        barGroup.appendChild(timeBar);
        barContainer.appendChild(barGroup);
        barContainer.appendChild(label);
        container.appendChild(barContainer);
    });
}

function getAchievements(profile) {
    const achievements = [];
    const { globalStats, detailedPerformance } = profile;

    if (globalStats.totalQuestionsAnswered >= 100) achievements.push('Rookie');
    if (globalStats.totalQuestionsAnswered >= 500) achievements.push('Veteran');
    if (globalStats.allTimeBestStreak >= 10) achievements.push('Streak 10');
    if (globalStats.allTimeBestStreak >= 25) achievements.push('On Fire');

    for (const type in detailedPerformance) {
        for (const diff in detailedPerformance[type]) {
            const item = detailedPerformance[type][diff];
            if (item.mastery >= 0.9) {
                achievements.push(`Mastered ${diff} ${type}`);
                return achievements;
            }
        }
    }
    return achievements;
}

function renderDashboardInsights(profile) {
    const container = document.getElementById('insights-container');
    const achContainer = document.getElementById('achievements-container');
    if (!container || !achContainer) return;

    const insights = [];
    const { detailedPerformance, globalStats } = profile;

    // Insight 1: Find weakest area
    let weakest = { mastery: 1, name: '' };
    for (const type in detailedPerformance) {
        for (const diff in detailedPerformance[type]) {
            const item = detailedPerformance[type][diff];
            if (item.mastery < weakest.mastery && item.totalAttempts > 5) {
                weakest = { mastery: item.mastery, name: `${diff} ${type}` };
            }
        }
    }
    if (weakest.mastery < 0.7) {
        insights.push(`Your biggest opportunity for improvement is in <strong>${weakest.name}</strong>. Try a 'Targeted' or 'Adaptive' session to focus on it.`);
    }

    // Insight 2: Speed vs Accuracy
    const timedModes = profile.sessionHistory.filter(s => s.settings.timeLimit > 0);
    const fixedModes = profile.sessionHistory.filter(s => s.settings.timeLimit === 0);
    if (timedModes.length > 2 && fixedModes.length > 2) {
        const timedAcc = timedModes.reduce((a,b) => a + b.summary.accuracy, 0) / timedModes.length;
        const fixedAcc = fixedModes.reduce((a,b) => a + b.summary.accuracy, 0) / fixedModes.length;
        if (timedAcc > 85 && Math.abs(timedAcc - fixedAcc) < 5) {
             insights.push("You perform well under pressure! Your accuracy remains high in timed modes.");
        } else if (fixedAcc > timedAcc + 10) {
            insights.push("You're very accurate, but the clock adds pressure. Try 'Fixed Time' mode with easier questions to build speed and confidence.");
        }
    }

    // Render insights
    if (insights.length > 0) {
        container.innerHTML = insights.map(insight => `<div class="result-subcard" style="flex-basis: 100%; text-align: left; align-items: flex-start;"><p>${insight}</p></div>`).join('');
    } else {
        container.innerHTML = `<p style="text-align: left; color: var(--text-secondary); width: 100%;">Personalized tips and achievements will appear here as you practice.</p>`;
    }

    const achievements = getAchievements(profile);
    achContainer.innerHTML = achievements.map(a => `<span class="badge" title="Achievement">${a}</span>`).join('');
}


/* ---------------------------------------
   INITIALIZATION
---------------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM Fully Loaded.");
    applySavedTheme();
    showArea('dashboard-area'); // Start on dashboard
    initializeStudyArea();
    initializeBackToTop();

    if (practiceArea) {
        updateTargetedInputs();
        updateTargetedLimitInput();
    }

    if (summaryPieChartContainer) summaryPieChartContainer.innerHTML = '<div class="pie-chart-placeholder" style="color: var(--text-secondary); font-style: italic; padding: 20px 0;"></div>';
    if (summaryPieChartLegend) summaryPieChartLegend.innerHTML = '';

    if (practiceArea && mainCard) mainCard.style.display = 'block';
    if (sessionCard) sessionCard.style.display = 'none';
    if (resultCard) resultCard.style.display = 'none';

    if (themeToggleButton) {
        themeToggleButton.addEventListener('click', toggleMode);
    } else {
        console.error("Theme toggle button not found!");
    }

    console.log("Mathex App Initialized.");
});
</script>
<script>showArea("practice-area");</script>
</body>
</html>
